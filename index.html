<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LOL Messenger ULTRA</title>
  
  <!-- –ò–∫–æ–Ω–∫–∏ –¥–ª—è iOS / PWA - –¢–í–û–ô –õ–û–ì–û–¢–ò–ü (–ø–æ —Å—Å—ã–ª–∫–µ) -->
  <link rel="apple-touch-icon" sizes="180x180" href="https://iili.io/qdLcM6N.md.jpg">
  <link rel="apple-touch-icon" sizes="152x152" href="https://iili.io/qdLcM6N.md.jpg">
  <link rel="apple-touch-icon" sizes="167x167" href="https://iili.io/qdLcM6N.md.jpg">
  <link rel="apple-touch-icon" sizes="120x120" href="https://iili.io/qdLcM6N.md.jpg">

  <style>
    :root{
      --bg:#070a10;
      --panel:rgba(18,24,38,.72);
      --panel2:rgba(10,14,22,.88);
      --line:rgba(255,255,255,.08);
      --text:#eaf1ff;
      --muted:rgba(234,241,255,.62);
      --muted2:rgba(234,241,255,.40);
      --blue:#2b86ff;
      --blue2:#1f6bff;
      --ok:#22c55e;
      --red:#ef4444;
      --shadow:0 18px 45px rgba(0,0,0,.45);

      --tabbar-h:82px;
      --composer-h:72px;
      
      /* Liquid Tabbar –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ */
      --bar: rgba(70,70,72,.86);
      --idle-pill: rgba(255,255,255,.12);
      --water: rgba(255,255,255,.02);
      --active: #007AFF;
      --inactive: #000;
      --pad: 7px;
      --pillH: 60px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% -10%, rgba(43,134,255,.22), transparent 60%),
        radial-gradient(850px 550px at 85% 0%, rgba(168,85,247,.18), transparent 58%),
        radial-gradient(900px 700px at 60% 110%, rgba(34,197,94,.10), transparent 55%),
        var(--bg);
      overflow:hidden;
    }

    .app{ height:100%; display:flex; flex-direction:column; }
    .screen{ display:none; height:100%; overflow-y:auto; overflow-x:hidden; }
    .screen.active{ display:block; }

    .glass{
      background:var(--panel);
      border:1px solid var(--line);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: var(--shadow);
    }

    .topbar{
      padding:14px 16px 10px;
      padding-top:max(14px, env(safe-area-inset-top));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .topbar h1{
      margin:0;
      font-size:28px;
      font-weight:1000;
      letter-spacing:.2px;
    }

    .iconbtn{
      width:40px; height:40px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      display:grid; place-items:center;
      cursor:pointer;
    }

    .btn{
      width:100%;
      padding:12px 14px;
      border:none;
      border-radius:16px;
      font-weight:1000;
      color:white;
      background: linear-gradient(180deg, var(--blue), var(--blue2));
      cursor:pointer;
    }
    .btn.ghost{
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
    }

    .field{
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px;
      margin-bottom:10px;
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted2);
      font-weight:1000;
      margin-bottom:6px;
      text-transform:uppercase;
      letter-spacing:.4px;
    }
    .field input{
      width:100%;
      border:none; outline:none;
      background:transparent;
      color:var(--text);
      font-size:16px;
      font-weight:1000;
    }

    .hint{ color:var(--muted); font-weight:900; font-size:13px; }
    .err{ color:#fecaca; background: rgba(239,68,68,.14); border: 1px solid rgba(239,68,68,.25); padding:10px 12px; border-radius:16px; font-weight:1000; }
    .ok{  color:#bbf7d0; background: rgba(34,197,94,.12); border: 1px solid rgba(34,197,94,.22); padding:10px 12px; border-radius:16px; font-weight:1000; }
    .hidden{ display:none !important; }

    /* ---------- AUTH ---------- */
    #scr-auth{
      padding: 18px 14px;
      padding-top: max(18px, env(safe-area-inset-top));
      padding-bottom: max(18px, env(safe-area-inset-bottom));
      overflow:auto;
    }
    .brand{
      font-size:34px;
      font-weight:1100;
      letter-spacing:.2px;
      margin: 8px 6px 2px;
      background: linear-gradient(90deg, #60a5fa, #a78bfa, #22c55e);
      -webkit-background-clip:text;
      color:transparent;
    }
    .subtitle{
      margin: 0 6px 16px;
      color: var(--muted);
      font-weight:1000;
    }
    .authCard{
      border-radius: 22px;
      padding: 16px 14px;
    }
    .seg{
      display:flex;
      gap:8px;
      margin-bottom:12px;
    }
    .seg button{
      flex:1;
      border:none;
      border-radius: 16px;
      padding: 10px 12px;
      font-weight:1100;
      cursor:pointer;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color: var(--muted);
    }
    .seg button.active{
      background: rgba(43,134,255,.22);
      border:1px solid rgba(43,134,255,.35);
      color: var(--text);
    }

    .avatarPick{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    .avatar{
      width:54px; height:54px;
      border-radius:50%;
      object-fit:cover;
      background: rgba(255,255,255,.08);
      border:1px solid var(--line);
      flex:0 0 auto;
    }
    .avatar.big{ width:78px; height:78px; }
    .avatar.med{ width:72px; height:72px; }

    /* ===== –ù–û–í–´–ô LIQUID TABBAR (2 –≤–∫–ª–∞–¥–∫–∏) ===== */
    .nav{
      position:fixed;
      left:0; right:0; bottom:0;
      height: var(--tabbar-h);
      padding-bottom: max(10px, env(safe-area-inset-bottom));
      background: transparent;
      border-top: none;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
    }

    .tabbar{
      position:relative;
      width:320px;
      height:74px;
      border-radius:999px;
      background: var(--bar);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08), 0 18px 40px rgba(0,0,0,.65);
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      align-items:center;
      padding: var(--pad);
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      pointer-events: auto;
      margin-bottom: 8px;
    }

    /* ===== PILL ===== */
    .pill{
      position:absolute;
      left: var(--pad);
      top: 50%;
      transform: translateX(var(--x, 0px)) translateY(-50%) scale(1);

      width: calc((100% - (var(--pad) * 2)) / 2);
      height: var(--pillH);
      border-radius:999px;

      background: var(--idle-pill);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);

      transition:
        transform .42s cubic-bezier(.16, 1, .3, 1),
        background-color .18s ease,
        box-shadow .18s ease,
        border-radius .35s cubic-bezier(.2,.9,.2,1);

      z-index:1;
      pointer-events:none;
    }

    /* ===== WATER MODE ===== */
    .tabbar.is-water .pill{
      background: var(--water);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);

      transform:
        translateX(var(--x, 0px))
        translateY(-50%)
        scaleX(1.14)
        scaleY(1.18);

      box-shadow:
        0 12px 26px rgba(0,0,0,.38),
        0 0 0 1px rgba(255,255,255,.05),
        0 0 22px rgba(140,220,255,.26);

      border-radius: 34px;
    }

    /* ===== TAB ===== */
    .tab{
      position:relative;
      z-index:2;
      height: var(--pillH);
      border:0;
      background:transparent;
      cursor:pointer;

      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;

      color: var(--inactive);
      transition: color .18s ease;
    }

    .tab .icon{ font-size:22px; }
    .tab .label{ font-size:12px; font-weight:500; }

    .tab.active{ color: var(--active); }
    .tabbar.is-water .tab.is-hovered{ color: var(--active); }

    /* ---------- CHATS LIST ---------- */
    #scr-chats{ overflow:hidden; }
    .searchpill{
      margin: 0 16px 10px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      padding: 12px 12px;
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
      font-weight:1000;
      color: var(--muted);
    }
    .banner{
      margin: 12px 16px;
      border-radius: 18px;
      padding: 16px 14px;
      background: linear-gradient(135deg, #7c3aed 0%, #2563eb 55%, #0ea5e9 100%);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .banner::after{
      content:"";
      position:absolute; right:-60px; top:-60px;
      width:220px; height:220px;
      border-radius:50%;
      background: rgba(255,255,255,.18);
    }
    .bannerTitle{ margin:0; font-weight:1100; font-size:18px; }
    .bannerText{ margin:6px 0 0; font-weight:1000; opacity:.9; }

    .list{
      padding: 0 10px calc(var(--tabbar-h) + 16px + env(safe-area-inset-bottom));
      height: calc(100% - 176px);
      overflow:auto;
    }
    .row{
      display:flex;
      gap:12px;
      align-items:center;
      padding: 12px 8px;
      border-radius: 18px;
      cursor:pointer;
    }
    .row:active{ background: rgba(255,255,255,.05); }
    .meta{ flex:1; min-width:0; }
    .nameLine{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .name{
      font-size:16px;
      font-weight:1100;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .time{ color:var(--muted2); font-weight:1100; font-size:12px; }
    .preview{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:4px; }
    .snippet{
      color:var(--muted);
      font-weight:1000;
      font-size:14px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      min-width:0; flex:1;
    }

    /* ---------- SEARCH SCREEN ---------- */
    #scr-search{ overflow:hidden; }
    .searchTop{
      padding: 14px 16px 10px;
      padding-top:max(14px, env(safe-area-inset-top));
      display:flex; gap:10px; align-items:center;
    }
    .searchField{
      flex:1;
      display:flex; align-items:center; gap:10px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px;
      font-weight:1100;
    }
    .searchField input{
      flex:1;
      border:none; outline:none;
      background:transparent;
      color: var(--text);
      font-size:16px;
      font-weight:1100;
      min-width:0;
    }
    .cancel{
      font-weight:1100;
      color:var(--text);
      opacity:.9;
      cursor:pointer;
      user-select:none;
    }
    .sectionTitle{
      padding: 10px 16px 6px;
      color: var(--muted2);
      font-weight:1100;
      text-transform:uppercase;
      letter-spacing:.5px;
      font-size:12px;
    }
    .searchList{
      padding: 0 10px calc(var(--tabbar-h) + 16px + env(safe-area-inset-bottom));
      height: calc(100% - 58px);
      overflow:auto;
    }
    .statusDot{
      width:10px; height:10px;
      border-radius:50%;
      background: rgba(255,255,255,.25);
      border:1px solid rgba(255,255,255,.18);
      flex:0 0 auto;
    }
    .statusDot.on{
      background: var(--ok);
      border-color: rgba(34,197,94,.35);
    }
    .sub{ color: var(--muted2); font-weight:1000; font-size:12px; margin-top:2px; }

    /* ---------- CHAT SCREEN ---------- */
    #scr-chat{ overflow:hidden; }
    .chatWrap{
      height:100%;
      display:flex;
      flex-direction:column;
      background:
        radial-gradient(900px 620px at 10% 10%, rgba(43,134,255,.18), transparent 60%),
        radial-gradient(900px 650px at 90% 30%, rgba(168,85,247,.14), transparent 58%),
        radial-gradient(900px 650px at 50% 110%, rgba(34,197,94,.08), transparent 55%),
        #070a10;
    }
    .chatTop{
      padding: 12px 12px 10px;
      padding-top:max(12px, env(safe-area-inset-top));
      display:flex;
      align-items:center;
      gap:10px;
      background: rgba(10,14,22,.82);
      border-bottom: 1px solid var(--line);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .backBtn{
      width:40px; height:40px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      display:grid; place-items:center;
      cursor:pointer;
      font-weight:1100;
      color:var(--text);
    }
    .chatHead{ flex:1; min-width:0; display:flex; gap:10px; align-items:center; }
    .chatMeta{ min-width:0; }
    .chatName{
      font-weight:1100;
      font-size:16px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .chatStatus{
      color: var(--muted2);
      font-weight:1100;
      font-size:12px;
      margin-top:2px;
    }

    .msgs{
      flex:1;
      overflow:auto;
      padding: 14px 12px calc(var(--tabbar-h) + var(--composer-h) + 16px + env(safe-area-inset-bottom));
    }

    .bubble{
      max-width: 78%;
      padding: 10px 12px;
      margin: 6px 0;
      border-radius: 18px;
      background: rgba(255,255,255,.07);
      border:1px solid var(--line);
      box-shadow: 0 14px 26px rgba(0,0,0,.22);
      font-weight:1000;
      white-space:pre-wrap;
      word-break:break-word;
      position: relative;
      user-select: none;
      -webkit-user-select: none;
    }
    .bubble.me{
      margin-left:auto;
      border:none;
      background: linear-gradient(135deg, rgba(43,134,255,.98), rgba(168,85,247,.92));
    }
    .bubble .t{
      display:block;
      margin-top:6px;
      font-size:11px;
      color: rgba(255,255,255,.75);
      font-weight:1100;
      text-align:right;
    }
    .bubble.deleted {
      opacity: 0.5;
      font-style: italic;
      background: rgba(255,255,255,.03);
    }

    /* –°—Ç–∞—Ç—É—Å—ã —Å–æ–æ–±—â–µ–Ω–∏–π - –±–µ–ª—ã–µ –≥–∞–ª–æ—á–∫–∏ –≤ –ª–µ–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É */
    .message-status {
      display: inline-block;
      margin-left: 4px;
      font-size: 14px;
      color: rgba(255,255,255,0.9);
      vertical-align: middle;
    }
    
    .bubble .message-footer {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-top: 6px;
      gap: 4px;
    }
    
    .status-delivered {
      color: rgba(255,255,255,0.9);
    }
    
    .status-read {
      color: rgba(255,255,255,0.9);
    }
    
    /* –ö–Ω–æ–ø–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ */
    .block-btn {
      width:40px; height:40px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      display:grid; place-items:center;
      cursor:pointer;
      font-weight:1100;
      color:var(--text);
      margin-left: 8px;
    }
    
    .block-btn.blocked {
      background: rgba(239,68,68,.2);
      border-color: #ef4444;
      color: #ef4444;
    }

    /* ---------- –ù–û–í–´–ï –ö–ù–û–ü–ö–ò –î–õ–Ø –°–û–ó–î–ê–¢–ï–õ–Ø ---------- */
    .chat-actions {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }

    .action-btn {
      width: 40px;
      height: 40px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
    }

    .creator-action-btn {
      border: 2px solid #2b86ff;
      background: rgba(43,134,255,0.15);
      color: #2b86ff;
    }

    /* –ú–æ–¥–∞–ª–∫–∞ */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal.hidden {
      display: none;
    }

    .modal-content {
      background: var(--panel2);
      border: 1px solid var(--line);
      border-radius: 24px;
      padding: 24px;
      width: 90%;
      max-width: 340px;
    }

    .modal-content h3 {
      margin-bottom: 16px;
      text-align: center;
    }

    .modal-content input, .modal-content select {
      width: 100%;
      padding: 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      border-radius: 12px;
      color: var(--text);
      margin-bottom: 16px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
    }

    .modal-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 12px;
      font-weight: 1100;
      cursor: pointer;
    }

    .modal-btn.confirm {
      background: var(--blue);
      color: white;
    }

    .modal-btn.cancel {
      background: rgba(255,255,255,.1);
      color: var(--text);
    }

    /* ---------- COMPOSER ---------- */
    .composer{
      position: fixed;
      left: 0;
      right: 0;
      bottom: calc(var(--tabbar-h) + env(safe-area-inset-bottom));
      padding: 10px;
      background: rgba(10,14,22,.95);
      border-top: 1px solid var(--line);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      display:flex;
      gap:8px;
      align-items:center;
      z-index: 999;
    }
    .composerInput{
      flex:1;
      display:flex; align-items:center; gap:10px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius: 18px;
      padding: 10px 12px;
      min-width:0;
    }
    .composerInput input{
      flex:1;
      border:none; outline:none;
      background:transparent;
      color: var(--text);
      font-size:16px;
      font-weight:1100;
      min-width:0;
    }
    .composerInput select {
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      border-radius: 12px;
      color: var(--text);
      padding: 8px;
    }
    .sendBtn{
      width:46px; height:46px;
      border-radius: 18px;
      border:none;
      background: linear-gradient(180deg, var(--blue), var(--blue2));
      color:white;
      font-weight:1100;
      cursor:pointer;
      flex:0 0 auto;
      user-select:none;
    }
    .sendBtn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ---------- PROFILE SCREEN ---------- */
    #scr-profile{ overflow:auto; padding-bottom: calc(var(--tabbar-h) + env(safe-area-inset-bottom)); }
    .profilePad{
      padding: 14px 14px;
      padding-top:max(14px, env(safe-area-inset-top));
    }
    .profileCard{
      border-radius: 22px;
      padding: 16px 14px;
      margin-bottom: 16px;
    }
    .profileHead{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .pName{ margin:0; font-size:22px; font-weight:1100; }
    .pSub{ margin-top:4px; color:var(--muted); font-weight:1100; font-size:13px; }

    /* ---------- BALANCE SCREEN ---------- */
    #scr-balance {
      overflow: auto;
      padding: 20px;
      padding-top: max(20px, env(safe-area-inset-top));
      padding-bottom: max(20px, env(safe-area-inset-bottom));
      height: 100%;
    }
    
    .balance-header {
      display: flex;
      align-items: center;
      margin-bottom: 24px;
      gap: 16px;
    }
    
    .balance-back {
      width: 44px;
      height: 44px;
      border-radius: 22px;
      background: rgba(255,255,255,.08);
      border: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
    }
    
    .balance-title {
      font-size: 32px;
      font-weight: 1000;
      margin: 0;
      background: linear-gradient(135deg, #60a5fa, #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .balance-card {
      background: rgba(255,255,255,.05);
      border: 1px solid var(--line);
      border-radius: 24px;
      padding: 24px;
      margin-bottom: 24px;
      text-align: center;
    }
    
    .balance-amount {
      font-size: 48px;
      font-weight: 1000;
      color: var(--blue);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .balance-amount span {
      font-size: 40px;
    }
    
    .shop-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin: 24px 0;
    }
    
    .shop-item {
      background: rgba(255,255,255,.05);
      border: 1px solid var(--line);
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      position: relative;
    }
    
    .shop-item-price {
      color: var(--blue);
      font-weight: 1100;
      font-size: 20px;
      margin: 10px 0;
    }
    
    .shop-item-badge {
      font-size: 32px;
      margin-bottom: 10px;
    }
    
    .shop-item-badge img {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
    }
    
    .shop-item-expired {
      color: var(--red);
      font-size: 12px;
      margin-top: 8px;
    }
    
    .shop-item-actions {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 10px;
    }
    
    .shop-item-actions button {
      padding: 6px 12px;
      font-size: 14px;
    }
    
    .promo-section {
      background: rgba(255,255,255,.05);
      border: 1px solid var(--line);
      border-radius: 20px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .promo-stats {
      margin-top: 20px;
      font-size: 14px;
    }
    
    .promo-stat-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--line);
    }
    
    .status-selector {
      background: rgba(255,255,255,.05);
      border: 1px solid var(--line);
      border-radius: 20px;
      padding: 20px;
      margin: 20px 0;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ–ª–µ–∫—Ç–∞ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏ */
    .status-selector select {
      width: 100%;
      padding: 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      border-radius: 12px;
      color: var(--text);
    }
    
    .status-selector option {
      background: var(--panel2);
      color: var(--text);
      padding: 8px;
    }
    
    .status-selector option img {
      vertical-align: middle;
      margin-right: 8px;
      width: 20px;
      height: 20px;
      border-radius: 4px;
    }
    
    /* –°–µ–∫—Ü–∏—è –ø—Ä–æ–¥–∞–∂–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ */
    .sell-section {
      background: rgba(255,255,255,.05);
      border: 1px solid var(--line);
      border-radius: 20px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .sell-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid var(--line);
      cursor: pointer;
    }
    
    .sell-item:hover {
      background: rgba(255,255,255,.02);
    }
    
    .sell-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 12px;
      accent-color: var(--blue);
    }
    
    .sell-item label {
      flex: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sell-item-icon {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      object-fit: cover;
    }
    
    .sell-total {
      text-align: right;
      padding: 16px 0;
      font-weight: 1100;
      color: var(--blue);
    }
    
    .sell-btn {
      width: 100%;
      padding: 14px;
      background: var(--blue);
      border: none;
      border-radius: 16px;
      color: white;
      font-weight: 1100;
      cursor: pointer;
    }
    
    .sell-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ---------- ABOUT SCREEN ---------- */
    #scr-about {
      overflow: auto;
      padding: 20px;
      padding-top: max(20px, env(safe-area-inset-top));
      padding-bottom: max(20px, env(safe-area-inset-bottom));
      height: 100%;
    }
    
    .about-header {
      display: flex;
      align-items: center;
      margin-bottom: 24px;
      gap: 16px;
    }
    
    .about-back {
      width: 44px;
      height: 44px;
      border-radius: 22px;
      background: rgba(255,255,255,.08);
      border: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
    }
    
    .about-title {
      font-size: 32px;
      font-weight: 1000;
      margin: 0;
      background: linear-gradient(135deg, #60a5fa, #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .feature-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin: 24px 0;
    }
    
    .feature-card {
      background: rgba(255,255,255,.05);
      border: 1px solid var(--line);
      border-radius: 24px;
      padding: 20px 16px;
      backdrop-filter: blur(10px);
    }
    
    .feature-icon {
      font-size: 36px;
      margin-bottom: 12px;
    }
    
    .feature-name {
      font-weight: 1100;
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--blue);
    }
    
    .feature-desc {
      font-size: 14px;
      color: var(--muted);
      line-height: 1.5;
      font-weight: 1000;
    }
    
    .tech-badge {
      background: rgba(43,134,255,.15);
      border: 1px solid rgba(43,134,255,.3);
      border-radius: 100px;
      padding: 6px 16px;
      display: inline-block;
      font-size: 14px;
      font-weight: 1100;
      margin: 4px;
    }
    
    .about-footer {
      margin-top: 32px;
      text-align: center;
      color: var(--muted2);
      font-size: 14px;
      font-weight: 1000;
      padding: 20px 0;
      border-top: 1px solid var(--line);
    }

  </style>
</head>

<body>
<div class="app">

  <!-- AUTH -->
  <section id="scr-auth" class="screen active">
    <div class="brand">LOL</div>
    <div class="subtitle">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>

    <div class="authCard glass">
      <div class="seg">
        <button id="segLogin" class="active" type="button">–í—Ö–æ–¥</button>
        <button id="segReg" type="button">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>

      <div id="authMsg" class="hidden"></div>

      <div class="field">
        <label>–õ–æ–≥–∏–Ω</label>
        <input id="loginLogin" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: l0l_user" autocomplete="username" />
      </div>

      <div class="field">
        <label>–ü–∞—Ä–æ–ª—å</label>
        <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
      </div>

      <div id="regExtra" class="hidden">
        <div class="avatarPick">
          <img id="regAvatarPreview" class="avatar med" alt="">
          <div style="flex:1">
            <div class="hint" style="font-weight:1100;margin-bottom:6px;">–ê–≤–∞—Ç–∞—Ä</div>
            <input id="regAvatarFile" type="file" accept="image/*"
              style="width:100%;padding:10px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid var(--line);color:var(--muted);" />
          </div>
        </div>

        <div class="field">
          <label>–ù–∏–∫–Ω–µ–π–º</label>
          <input id="regNick" placeholder="–∫–∞–∫ —Ç–µ–±—è –±—É–¥—É—Ç –≤–∏–¥–µ—Ç—å" autocomplete="nickname" />
        </div>

        <div class="field">
          <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
          <input id="regPhone" placeholder="+7 900 000-00-00" inputmode="tel" autocomplete="tel" />
        </div>
      </div>

      <button id="authBtn" class="btn" type="button">–í–æ–π—Ç–∏</button>

      <div class="hint" style="margin-top:10px;">
        * –≠—Ç–æ –≤—Ö–æ–¥ –ø–æ –ª–æ–≥–∏–Ω—É/–ø–∞—Ä–æ–ª—é –±–µ–∑ Firebase Auth (–ø–∞—Ä–æ–ª—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ SHA-256 —Ö—ç—à).
      </div>
    </div>
  </section>

  <!-- CHATS -->
  <section id="scr-chats" class="screen">
    <div class="topbar">
      <h1>–ß–∞—Ç—ã</h1>
      <button id="btnLogout" class="iconbtn" type="button" title="–í—ã–π—Ç–∏">‚éã</button>
    </div>

    <div id="openSearch" class="searchpill">üîé –ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫–Ω–µ–π–º—É</div>

    <div class="banner">
      <p class="bannerTitle">LOL Messenger</p>
      <p class="bannerText">–°—Ç–∞—Ç—É—Å—ã: –æ–¥–Ω–∞ ‚úî - –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ, –¥–≤–µ ‚úî‚úî - –ø—Ä–æ—á–∏—Ç–∞–Ω–æ</p>
    </div>

    <div id="chatList" class="list"></div>
  </section>

  <!-- SEARCH -->
  <section id="scr-search" class="screen">
    <div class="searchTop">
      <div class="searchField">
        üîé
        <input id="searchInput" placeholder="–ù–∏–∫–Ω–µ–π–º..." />
        <button id="clearSearch" class="iconbtn" type="button" style="width:34px;height:34px;border-radius:14px;">‚úï</button>
      </div>
      <div id="cancelSearch" class="cancel">–û—Ç–º–µ–Ω–∞</div>
    </div>

    <div class="searchList">
      <div class="sectionTitle">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
      <div id="searchResults"></div>
      <div id="searchEmpty" class="hint" style="padding:10px 16px; font-weight:1100;"></div>
    </div>
  </section>

  <!-- CHAT -->
  <section id="scr-chat" class="screen">
    <div class="chatWrap">
      <div class="chatTop">
        <div id="backToChats" class="backBtn">‚Äπ</div>

        <div class="chatHead">
          <img id="peerAvatar" class="avatar" alt="">
          <div class="chatMeta">
            <div id="peerNick" class="chatName">–ß–∞—Ç</div>
            <div id="peerStatus" class="chatStatus">‚Ä¶</div>
          </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ -->
        <div class="chat-actions" id="chatActions"></div>
        
        <button id="exitChat" class="iconbtn" type="button" title="–í—ã–π—Ç–∏ –∏–∑ —á–∞—Ç–∞">‚§¨</button>
      </div>

      <div id="msgList" class="msgs"></div>
    </div>

    <!-- composer -->
    <div class="composer" id="composer">
      <div class="composerInput">
        <input id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" />
        <button class="action-btn" id="giftBtn" style="width:auto; padding:0 10px;" onclick="showGiftModal()">üéÅ</button>
        <button class="action-btn" id="creatorGiftBtn" style="width:auto; padding:0 10px; display:none;" onclick="showCreatorGiftModal()">üéÅ‚ûï</button>
      </div>
      <button id="sendBtn" class="sendBtn" type="button" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
    </div>
  </section>

  <!-- PROFILE -->
  <section id="scr-profile" class="screen">
    <div class="profilePad">
      <div class="topbar" style="padding:0 2px 10px; padding-top:0;">
        <h1>–ü—Ä–æ—Ñ–∏–ª—å</h1>
        <button id="btnLogout2" class="iconbtn" type="button" title="–í—ã–π—Ç–∏">‚éã</button>
      </div>

      <div class="profileCard glass">
        <div class="profileHead">
          <img id="meAvatar" class="avatar big" alt="">
          <div style="flex:1; min-width:0;">
            <h2 id="meNick" class="pName">‚Ä¶</h2>
            <div id="mePhone" class="pSub">‚Ä¶</div>
            <div id="meLogin" class="pSub" style="opacity:.85;"></div>
          </div>
        </div>

        <div style="height:12px"></div>

        <!-- –ö–Ω–æ–ø–∫–∞ –±–∞–ª–∞–Ω—Å–∞ -->
        <button id="balanceBtn" class="btn ghost" type="button">ü§£ <span id="balanceDisplay">0</span> LOL</button>
        <div style="height:10px"></div>

        <div class="avatarPick" style="margin:0 0 10px;">
          <img id="editAvatarPreview" class="avatar med" alt="">
          <div style="flex:1">
            <div class="hint" style="font-weight:1100;margin-bottom:6px;">–°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</div>
            <input id="editAvatarFile" type="file" accept="image/*"
              style="width:100%;padding:10px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid var(--line);color:var(--muted);" />
          </div>
        </div>

        <div class="field">
          <label>–ù–∏–∫–Ω–µ–π–º</label>
          <input id="editNick" />
        </div>

        <div class="field">
          <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
          <input id="editPhone" />
        </div>

        <button id="saveProfileBtn" class="btn" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <div style="height:10px"></div>
        
        <!-- –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ "–ß—Ç–æ –∑–∞ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä?" -->
        <button id="aboutBtn" class="btn ghost" type="button">‚ùì –ß—Ç–æ –∑–∞ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä?</button>
        <div style="height:10px"></div>
        
        <!-- –ù–û–í–û–ï: –ö–Ω–æ–ø–∫–∞ —Å—Ç–∞—Ç—å/—É–±—Ä–∞—Ç—å —Å–æ–∑–¥–∞—Ç–µ–ª—è -->
        <button id="creatorBtn" class="btn ghost hidden" type="button">üî® –°—Ç–∞—Ç—å —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º</button>
        <div style="height:10px"></div>
        
        <button id="resetDeviceBtn" class="btn ghost" type="button">–°–±—Ä–æ—Å–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>

        <div id="profileMsg" class="hidden" style="margin-top:10px;"></div>
      </div>
    </div>
  </section>

  <!-- BALANCE SCREEN -->
  <section id="scr-balance" class="screen">
    <div class="balance-header">
      <div class="balance-back" id="balanceBackBtn">‚Üê</div>
      <h2 class="balance-title">LOL –ö–æ–∏–Ω</h2>
    </div>

    <!-- –ú–∞–≥–∞–∑–∏–Ω -->
    <div class="balance-card">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
        <h3>üõí –ú–∞–≥–∞–∑–∏–Ω</h3>
        <button id="addItemBtn" class="btn ghost" style="width:auto; padding:8px 16px; display:none;" onclick="showAddItemModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
      </div>
      
      <div id="shopItems" class="shop-grid">
        <!-- –°—é–¥–∞ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å—Ç–∞—Ç—É—Å—ã –∏–∑ –ë–î -->
      </div>
    </div>

    <!-- –ë–∞–ª–∞–Ω—Å -->
    <div class="balance-card">
      <div style="display:flex; align-items:center; justify-content:center; gap:20px;">
        <span class="balance-amount"><span>ü§£</span> <span id="balanceAmount">0</span></span>
        <button id="addBalanceBtn" class="btn ghost" style="width:auto; padding:10px 20px; display:none;">‚ûï</button>
      </div>
    </div>

    <!-- –ü—Ä–æ–º–æ–∫–æ–¥—ã -->
    <div class="promo-section">
      <h3 style="margin-bottom:20px;">üé´ –ü—Ä–æ–º–æ–∫–æ–¥</h3>
      <div style="display:flex; gap:10px;">
        <input type="text" id="promoCode" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" style="flex:1;">
        <button class="btn ghost" onclick="activatePromo()" style="width:auto;">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      
      <!-- –î–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è: —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ -->
      <div id="creatorPromoSection" style="margin-top:20px; display:none;">
        <button class="btn ghost" onclick="showCreatePromoModal()">‚ûï –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ</button>
        
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ -->
        <div class="promo-stats" id="promoStats">
          <h4>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</h4>
          <div id="promoStatsList"></div>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–æ–¥–∞–∂–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ -->
    <div class="sell-section" id="sellSection">
      <h3 style="margin-bottom:20px;">üí∞ –ü—Ä–æ–¥–∞—Ç—å —Å—Ç–∞—Ç—É—Å</h3>
      <div id="sellItems">
        <!-- –°—é–¥–∞ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å—Ç–∞—Ç—É—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
      </div>
      
      <div id="sellTotal" class="sell-total">
        –í—ã–±—Ä–∞–Ω–æ: 0 —Å—Ç–∞—Ç—É—Å–æ–≤ –Ω–∞ —Å—É–º–º—É 0 ü§£
      </div>
      
      <button class="sell-btn" id="sellBtn" onclick="sellSelected()" disabled>
        –ü–†–û–î–ê–¢–¨
      </button>
    </div>

    <!-- –í—ã–±–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
    <div class="status-selector">
      <h3 style="margin-bottom:20px;">‚ú® –í—ã–±—Ä–∞—Ç—å —Å—Ç–∞—Ç—É—Å</h3>
      <select id="statusSelect" onchange="changeStatus()">
        <option value="">üö´ –ù–µ—Ç —Å—Ç–∞—Ç—É—Å–∞</option>
        <!-- –°—é–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∫—É–ø–ª–µ–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã -->
      </select>
    </div>
  </section>

  <!-- ABOUT SCREEN (–Ω–æ–≤—ã–π —ç–∫—Ä–∞–Ω) -->
  <section id="scr-about" class="screen">
    <div class="about-header">
      <div class="about-back" id="aboutBackBtn">‚Üê</div>
      <h2 class="about-title">LOL Messenger</h2>
    </div>

    <div class="feature-grid">
      <div class="feature-card">
        <div class="feature-icon">üí¨</div>
        <div class="feature-name">–¢–µ–∫—Å—Ç–æ–≤—ã–µ —á–∞—Ç—ã</div>
        <div class="feature-desc">–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ–±–º–µ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ —Å –¥—Ä—É–∑—å—è–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</div>
      </div>

      <div class="feature-card">
        <div class="feature-icon">üîé</div>
        <div class="feature-name">–ü–æ–∏—Å–∫ –ª—é–¥–µ–π</div>
        <div class="feature-desc">–ù–∞—Ö–æ–¥–∏ –¥—Ä—É–∑–µ–π –ø–æ –Ω–∏–∫–Ω–µ–π–º—É –∏ –Ω–∞—á–∏–Ω–∞–π –æ–±—â–µ–Ω–∏–µ</div>
      </div>

      <div class="feature-card">
        <div class="feature-icon">üü¢</div>
        <div class="feature-name">–°—Ç–∞—Ç—É—Å "–æ–Ω–ª–∞–π–Ω"</div>
        <div class="feature-desc">–í–∏–¥–∏—à—å, –∫—Ç–æ —Å–µ–π—á–∞—Å –≤ —Å–µ—Ç–∏ –∏ –≥–æ—Ç–æ–≤ –æ–±—â–∞—Ç—å—Å—è</div>
      </div>

      <div class="feature-card">
        <div class="feature-icon">‚úèÔ∏è</div>
        <div class="feature-name">"–ü–µ—á–∞—Ç–∞–µ—Ç‚Ä¶"</div>
        <div class="feature-desc">–ó–Ω–∞–µ—à—å, –∫–æ–≥–¥–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–±–∏—Ä–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
      </div>

      <div class="feature-card">
        <div class="feature-icon">‚úî</div>
        <div class="feature-name">–°—Ç–∞—Ç—É—Å—ã –¥–æ—Å—Ç–∞–≤–∫–∏</div>
        <div class="feature-desc">–û–¥–Ω–∞ –≥–∞–ª–æ—á–∫–∞ - –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ, –¥–≤–µ –≥–∞–ª–æ—á–∫–∏ - –ø—Ä–æ—á–∏—Ç–∞–Ω–æ</div>
      </div>

      <div class="feature-card">
        <div class="feature-icon">üö´</div>
        <div class="feature-name">–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞</div>
        <div class="feature-desc">–ú–æ–∂–µ—à—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ª—é–±–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π</div>
      </div>

      <div class="feature-card">
        <div class="feature-icon">üñºÔ∏è</div>
        <div class="feature-name">–ê–≤–∞—Ç–∞—Ä—ã</div>
        <div class="feature-desc">–ó–∞–≥—Ä—É–∂–∞–π —Å–≤–æ–∏ —Ñ–æ—Ç–æ –∏ –º–µ–Ω—è–π –∏—Ö –∫–æ–≥–¥–∞ –∑–∞—Ö–æ—á–µ—à—å</div>
      </div>

      <div class="feature-card">
        <div class="feature-icon">‚ö°</div>
        <div class="feature-name">–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ</div>
        <div class="feature-desc">–í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏</div>
      </div>
    </div>

    <div style="margin: 24px 0; text-align: center;">
      <span class="tech-badge">üî• Firebase</span>
      <span class="tech-badge">üí® Firestore</span>
      <span class="tech-badge">üîê SHA-256</span>
      <span class="tech-badge">üì± PWA ready</span>
    </div>

    <div class="about-footer">
      <p>–í–µ—Ä—Å–∏—è 4.0 (2026)</p>
      <p style="font-size: 12px;">–°–æ–∑–¥–∞–Ω–æ —Å ‚ù§Ô∏è –¥–ª—è LOL Messenger</p>
      <p style="font-size: 11px; margin-top: 8px;">–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Firebase<br>–ü–æ–ª–Ω–æ—Å—Ç—å—é –±–µ—Å–ø–ª–∞—Ç–Ω–æ –Ω–∞ Spark –ø–ª–∞–Ω–µ</p>
    </div>
  </section>

  <!-- –ù–û–í–´–ô LIQUID TABBAR -->
  <nav id="bottomNav" class="nav hidden">
    <div class="tabbar" id="tabbar">
      <div class="pill" id="pill"></div>
      <button class="tab active" data-i="0" data-tab="chats">
        <div class="icon">üí¨</div>
        <div class="label">–ß–∞—Ç—ã</div>
      </button>
      <button class="tab" data-i="1" data-tab="profile">
        <div class="icon">üë§</div>
        <div class="label">–ü—Ä–æ—Ñ–∏–ª—å</div>
      </button>
    </div>
  </nav>

  <!-- –ú–æ–¥–∞–ª–∫–∏ -->
  <div id="muteModal" class="modal hidden">
    <div class="modal-content">
      <h3>–ù–∞ —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –∑–∞–≥–ª—É—à–∏—Ç—å?</h3>
      <input type="number" id="muteMinutes" min="1" value="5">
      <div class="modal-buttons">
        <button class="modal-btn confirm" onclick="confirmMute()">‚úÖ</button>
        <button class="modal-btn cancel" onclick="hideMuteModal()">‚ùå</button>
      </div>
    </div>
  </div>

  <!-- –ú–û–î–ê–õ–ö–ê –ü–û–î–ê–†–ö–ê - —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å—ã –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞ -->
  <div id="giftModal" class="modal hidden">
    <div class="modal-content">
      <h3>üéÅ –ü–æ–¥–∞—Ä–æ–∫</h3>
      <select id="giftType" style="width:100%; margin-bottom:16px;">
        <option value="coins">ü§£ LOL –∫–æ–∏–Ω—ã</option>
        <!-- –°—é–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—Ç–∞—Ç—É—Å—ã –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞ -->
      </select>
      <div id="giftCoinsInput">
        <input type="number" id="giftCoins" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤" min="1">
      </div>
      <div class="modal-buttons">
        <button class="modal-btn confirm" onclick="confirmGift()">üéÅ –ü–æ–¥–∞—Ä–∏—Ç—å</button>
        <button class="modal-btn cancel" onclick="hideGiftModal()">‚ùå</button>
      </div>
    </div>
  </div>

  <div id="creatorGiftModal" class="modal hidden">
    <div class="modal-content">
      <h3>üéÅ‚ûï –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–∏–Ω—ã</h3>
      <input type="number" id="creatorGiftCoins" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤" min="1">
      <div class="modal-buttons">
        <button class="modal-btn confirm" onclick="confirmCreatorGift()">üí∞ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button class="modal-btn cancel" onclick="hideCreatorGiftModal()">‚ùå</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ -->
  <div id="createPromoModal" class="modal hidden">
    <div class="modal-content">
      <h3>‚ûï –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</h3>
      
      <input type="text" id="promoCodeInput" placeholder="–ö–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞">
      <input type="number" id="promoAmount" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤">
      
      <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞ -->
      <div style="margin: 16px 0;">
        <label style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
          <input type="radio" name="promoType" value="date" checked onchange="togglePromoType()"> üìÖ –ü–æ –¥–∞—Ç–µ
        </label>
        <label style="display:flex; align-items:center; gap:10px;">
          <input type="radio" name="promoType" value="count" onchange="togglePromoType()"> üî¢ –ü–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É
        </label>
      </div>
      
      <!-- –ü–æ–ª—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ -->
      <div id="promoDateField">
        <input type="date" id="promoDate" style="width:100%;">
        <small style="color:var(--muted);">–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–µ–Ω –¥–æ —ç—Ç–æ–π –¥–∞—Ç—ã</small>
      </div>
      
      <div id="promoCountField" style="display:none;">
        <input type="number" id="promoActivations" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π" min="1">
        <small style="color:var(--muted);">–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –º–æ–∂–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</small>
      </div>
      
      <div class="modal-buttons" style="margin-top:20px;">
        <button class="modal-btn confirm" onclick="createPromo()">‚úÖ –°–æ–∑–¥–∞—Ç—å</button>
        <button class="modal-btn cancel" onclick="hideCreatePromoModal()">‚ùå –û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ -->
  <div id="addItemModal" class="modal hidden">
    <div class="modal-content">
      <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</h3>
      
      <div style="margin-bottom:16px;">
        <label style="display:block; margin-bottom:8px;">–¢–∏–ø:</label>
        <select id="itemIconType" onchange="toggleItemIconInput()">
          <option value="emoji">üòä –≠–º–æ–¥–∑–∏</option>
          <option value="image">üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</option>
        </select>
      </div>
      
      <div id="itemEmojiField">
        <input type="text" id="itemEmoji" placeholder="–í–≤–µ–¥–∏—Ç–µ —ç–º–æ–¥–∑–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä ‚≠êÔ∏è)" maxlength="2">
      </div>
      
      <div id="itemImageField" style="display:none;">
        <input type="file" id="itemImage" accept="image/*">
        <small style="color:var(--muted);">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞</small>
      </div>
      
      <input type="text" id="itemName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
      <input type="number" id="itemPrice" placeholder="–†—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞" min="1">
      
      <div style="margin: 16px 0;">
        <label style="display:flex; align-items:center; gap:10px;">
          <input type="checkbox" id="itemLimited" onchange="toggleItemLimited()"> –õ–∏–º–∏—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
        </label>
      </div>
      
      <div id="itemDateField" style="display:none;">
        <input type="date" id="itemExpiryDate">
        <small style="color:var(--muted);">–î–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –¥–æ —ç—Ç–æ–π –¥–∞—Ç—ã</small>
      </div>
      
      <div class="modal-buttons" style="margin-top:20px;">
        <button class="modal-btn confirm" onclick="createItem()">‚úÖ –°–æ–∑–¥–∞—Ç—å</button>
        <button class="modal-btn cancel" onclick="hideAddItemModal()">‚ùå –û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ -->
  <div id="editItemModal" class="modal hidden">
    <div class="modal-content">
      <h3>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å</h3>
      
      <input type="hidden" id="editItemId">
      
      <div style="margin-bottom:16px;">
        <label style="display:block; margin-bottom:8px;">–¢–∏–ø:</label>
        <select id="editIconType" onchange="toggleEditIconInput()">
          <option value="emoji">üòä –≠–º–æ–¥–∑–∏</option>
          <option value="image">üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</option>
        </select>
      </div>
      
      <div id="editEmojiField">
        <input type="text" id="editEmoji" placeholder="–í–≤–µ–¥–∏—Ç–µ —ç–º–æ–¥–∑–∏" maxlength="2">
      </div>
      
      <div id="editImageField" style="display:none;">
        <input type="file" id="editImage" accept="image/*">
        <small style="color:var(--muted);">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å</small>
      </div>
      
      <input type="text" id="editName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞">
      <input type="number" id="editPrice" placeholder="–†—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞" min="1">
      
      <div style="margin: 16px 0;">
        <label style="display:flex; align-items:center; gap:10px;">
          <input type="checkbox" id="editLimited" onchange="toggleEditLimited()"> –õ–∏–º–∏—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
        </label>
      </div>
      
      <div id="editDateField" style="display:none;">
        <input type="date" id="editExpiryDate">
        <small style="color:var(--muted);">–î–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –¥–æ —ç—Ç–æ–π –¥–∞—Ç—ã</small>
      </div>
      
      <div class="modal-buttons" style="margin-top:20px;">
        <button class="modal-btn confirm" onclick="saveItem()">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="modal-btn cancel" onclick="hideEditItemModal()">‚ùå –û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <div id="addBalanceModal" class="modal hidden">
    <div class="modal-content">
      <h3>‚ûï –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</h3>
      <input type="number" id="addBalanceAmount" placeholder="–°–∫–æ–ª—å–∫–æ –¥–æ–±–∞–≤–∏—Ç—å?" min="1">
      <div class="modal-buttons">
        <button class="modal-btn confirm" onclick="addBalance()">üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
        <button class="modal-btn cancel" onclick="hideAddBalanceModal()">‚ùå</button>
      </div>
    </div>
  </div>

</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
/* =========================
   Firebase init
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyCl9xOzUawqggpwyZQupGYm67RiWT42b7A",
  authDomain: "lol-messenger-76286.firebaseapp.com",
  projectId: "lol-messenger-76286",
  storageBucket: "lol-messenger-76286.firebasestorage.app",
  messagingSenderId: "573143866457",
  appId: "1:573143866457:web:fb7ed67ea66848e6da2548"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* =========================
   Helpers
========================= */
const $ = (id) => document.getElementById(id);
const now = () => Date.now();
const pad2 = (n)=> String(n).padStart(2,"0");
const fmtTime = (ms)=> { const d=new Date(ms); return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; };

function escapeHtml(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function showScreen(id){
  ["scr-auth","scr-chats","scr-search","scr-chat","scr-profile","scr-about","scr-balance"].forEach(x => $(x).classList.remove("active"));
  $(id).classList.add("active");
  $("composer").style.display = (id === "scr-chat") ? "flex" : "none";
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Ç–∞–±–±–∞—Ä
  if (id === "scr-auth" || id === "scr-about" || id === "scr-balance") {
    $("bottomNav").classList.add("hidden");
  } else {
    $("bottomNav").classList.remove("hidden");
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø—Ä–∏ –ø–æ–∫–∞–∑–µ —ç–∫—Ä–∞–Ω–∞ –±–∞–ª–∞–Ω—Å–∞
  if (id === "scr-balance") {
    updateBalanceScreen();
    updatePromoStats();
    loadShopItems();
    updateSellSection();
    updateStatusSelect();
  }
}

function setMsg(el, text, kind){
  el.className = (kind === "ok") ? "ok" : "err";
  el.textContent = text;
  el.classList.remove("hidden");
}
function clearMsg(el){
  el.textContent = "";
  el.classList.add("hidden");
}

function randId(prefix="u"){
  return prefix + "_" + Math.random().toString(36).slice(2) + "_" + Math.random().toString(36).slice(2);
}

async function sha256Hex(text){
  const enc = new TextEncoder();
  const data = enc.encode(text);
  const hash = await crypto.subtle.digest("SHA-256", data);
  const bytes = Array.from(new Uint8Array(hash));
  return bytes.map(b => b.toString(16).padStart(2,"0")).join("");
}

function chatIdFor(a,b){ return [a,b].sort().join("_"); }

function isOnline(u){
  const ls = u.lastSeen || 0;
  return !!u.online && (now() - ls) < 45000;
}

/* =========================
   –£–º–Ω—ã–π —Å—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω
========================= */
function onlineText(u) {
  if (isOnline(u)) {
    return 'üü¢ –æ–Ω–ª–∞–π–Ω';
  }
  
  const lastSeen = u.lastSeen || 0;
  if (!lastSeen) return '‚ö´ –æ—Ñ—Ñ–ª–∞–π–Ω';
  
  const now = Date.now();
  const diffMs = now - lastSeen;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  const lastDate = new Date(lastSeen);
  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  
  const timeStr = lastDate.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
  
  if (diffMins < 1) {
    return 'üîµ —Ç–æ–ª—å–∫–æ —á—Ç–æ';
  }
  
  if (diffMins < 60) {
    return `üîµ –±—ã–ª ${diffMins} ${getMinutesWord(diffMins)} –Ω–∞–∑–∞–¥`;
  }
  
  if (lastDate.toDateString() === today.toDateString()) {
    return `üîµ –±—ã–ª —Å–µ–≥–æ–¥–Ω—è –≤ ${timeStr}`;
  }
  
  if (lastDate.toDateString() === yesterday.toDateString()) {
    return `üîµ –±—ã–ª –≤—á–µ—Ä–∞ –≤ ${timeStr}`;
  }
  
  const dayNames = ['–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–≤—Ç–æ—Ä–Ω–∏–∫', '—Å—Ä–µ–¥—É', '—á–µ—Ç–≤–µ—Ä–≥', '–ø—è—Ç–Ω–∏—Ü—É', '—Å—É–±–±–æ—Ç—É'];
  const dayIndex = lastDate.getDay();
  const dayName = dayNames[dayIndex];
  
  if (diffDays < 7) {
    return `üîµ –±—ã–ª –≤ ${dayName} –≤ ${timeStr}`;
  }
  
  const dateStr = lastDate.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
  return `üîµ –±—ã–ª ${dateStr}`;
}

function getMinutesWord(minutes) {
  if (minutes >= 11 && minutes <= 14) return '–º–∏–Ω—É—Ç';
  const lastDigit = minutes % 10;
  if (lastDigit === 1) return '–º–∏–Ω—É—Ç—É';
  if (lastDigit >= 2 && lastDigit <= 4) return '–º–∏–Ω—É—Ç—ã';
  return '–º–∏–Ω—É—Ç';
}

/* =========================
   –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∫–∏
========================= */
async function uploadAvatar(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => resolve(e.target.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* =========================
   Default avatar
========================= */
const defaultAvatar = "data:image/svg+xml;base64," + btoa(`
<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#60a5fa"/>
      <stop offset="1" stop-color="#a78bfa"/>
    </linearGradient>
  </defs>
  <rect width="256" height="256" rx="80" fill="url(#g)"/>
  <circle cx="128" cy="104" r="44" fill="rgba(255,255,255,.85)"/>
  <path d="M48 218c18-44 54-66 80-66s62 22 80 66" fill="rgba(255,255,255,.78)"/>
</svg>
`);

/* =========================
   State
========================= */
let authMode = "login";
let session = null;
let me = null;
let usersCache = new Map();
let itemsCache = new Map(); // –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ –º–∞–≥–∞–∑–∏–Ω–µ
let selectedSellItems = new Set(); // –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ —Å—Ç–∞—Ç—É—Å—ã

let peer = null;
let currentChatId = null;

let unsubChatList = null;
let unsubMsgs = null;
let unsubPeer = null;

let heartbeatTimer = null;
let typingTimer = null;
let typingClearTimer = null;

let isBlocked = false;
let promosCache = new Map();

const CREATOR_PASSWORD = 'Sigmohibutlos67?!';
let muteTargetId = null;
let muteTimers = new Map();

/* =========================
   Session persistence
========================= */
function loadSession(){
  try{
    const s = JSON.parse(localStorage.getItem("lol_session") || "null");
    return s && s.uid ? s : null;
  }catch{ return null; }
}
function saveSession(s){ localStorage.setItem("lol_session", JSON.stringify(s)); }
function clearSession(){ localStorage.removeItem("lol_session"); }

/* =========================
   Auth UI
========================= */
function setAuthMode(mode){
  authMode = mode;
  $("segLogin").classList.toggle("active", mode==="login");
  $("segReg").classList.toggle("active", mode==="reg");
  $("regExtra").classList.toggle("hidden", mode!=="reg");
  $("authBtn").textContent = mode==="login" ? "–í–æ–π—Ç–∏" : "–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç";
  clearMsg($("authMsg"));
}
$("segLogin").addEventListener("click", ()=> setAuthMode("login"));
$("segReg").addEventListener("click", ()=> setAuthMode("reg"));

$("regAvatarPreview").src = defaultAvatar;

function bindAvatarInput(fileEl, imgEl){
  fileEl.addEventListener("change", (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = (ev)=> { imgEl.src = ev.target.result; };
    r.readAsDataURL(f);
  });
}
bindAvatarInput($("regAvatarFile"), $("regAvatarPreview"));
bindAvatarInput($("editAvatarFile"), $("editAvatarPreview"));

/* =========================
   Data access
========================= */
async function warmUsersCache(){
  const snap = await db.collection("users").get();
  usersCache.clear();
  snap.forEach(d => usersCache.set(d.id, { uid:d.id, ...d.data() }));
  if(session && usersCache.has(session.uid)) me = usersCache.get(session.uid);
}

async function loadMe(){
  const snap = await db.collection("users").doc(session.uid).get();
  if(!snap.exists) throw new Error("–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.");
  me = { uid: snap.id, ...snap.data() };
  
  // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –º–∞—Å—Å–∏–≤—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
  if (!me.customItems) me.customItems = [];
  if (!me.selectedStatus) me.selectedStatus = "";
  
  usersCache.set(me.uid, me);
}

async function findUserByLogin(login){
  const snap = await db.collection("users").where("login","==",login).limit(1).get();
  if (snap.empty) return null;
  const d = snap.docs[0];
  return { uid: d.id, data: d.data() };
}

/* =========================
   Online / heartbeat
========================= */
async function setOnline(flag){
  if(!session) return;
  try{
    await db.collection("users").doc(session.uid).set({
      online: !!flag,
      lastSeen: now()
    }, { merge:true });
  }catch{}
}

function startHeartbeat(){
  stopHeartbeat();
  heartbeatTimer = setInterval(()=> setOnline(true), 15000);
}
function stopHeartbeat(){
  if(heartbeatTimer){ clearInterval(heartbeatTimer); heartbeatTimer=null; }
}

window.addEventListener("beforeunload", ()=> setOnline(false));
document.addEventListener("visibilitychange", ()=>{
  if(document.hidden) setOnline(false);
  else setOnline(true);
});

/* =========================
   –§—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—è
========================= */
$("creatorBtn").addEventListener("click", async () => {
  if (me.role === "creator") {
    if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∞ —Å–æ–∑–¥–∞—Ç–µ–ª—è?")) {
      try {
        await db.collection("users").doc(me.uid).update({ role: "user" });
        me.role = "user";
        renderProfile();
        alert("üë§ –ü—Ä–∞–≤–∞ —Å–æ–∑–¥–∞—Ç–µ–ª—è —É–±—Ä–∞–Ω—ã");
      } catch (e) {
        alert("–û—à–∏–±–∫–∞: " + e.message);
      }
    }
  } else {
    const pass = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å —Å–æ–∑–¥–∞—Ç–µ–ª—è:");
    if (pass !== CREATOR_PASSWORD) {
      alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
      return;
    }

    try {
      await db.collection("users").doc(me.uid).update({ role: "creator" });
      me.role = "creator";
      renderProfile();
      alert("üéâ –¢–µ–ø–µ—Ä—å –≤—ã —Å–æ–∑–¥–∞—Ç–µ–ª—å!");
    } catch (e) {
      alert("–û—à–∏–±–∫–∞: " + e.message);
    }
  }
});

/* =========================
   –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
========================= */
async function toggleVerify(userId) {
  if (me?.role !== "creator") return;
  
  try {
    const userRef = db.collection("users").doc(userId);
    const userSnap = await userRef.get();
    await userRef.update({ verified: !userSnap.data().verified });
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏:", e);
  }
}

/* =========================
   –ú—É—Ç
========================= */
function showMuteModal(userId) {
  if (me?.role !== "creator") return;
  muteTargetId = userId;
  $("muteModal").classList.remove("hidden");
}

function hideMuteModal() {
  $("muteModal").classList.add("hidden");
  muteTargetId = null;
}

async function confirmMute() {
  if (!muteTargetId || me?.role !== "creator") {
    hideMuteModal();
    return;
  }

  const minutes = parseInt($("muteMinutes").value);
  if (isNaN(minutes) || minutes < 1) {
    alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω—É—Ç");
    return;
  }

  try {
    const userRef = db.collection("users").doc(muteTargetId);
    const userSnap = await userRef.get();
    const userData = userSnap.data();
    
    if (userData.mutedUntil && userData.mutedUntil > now()) {
      await userRef.update({
        mutedUntil: 0,
        mutedBy: null
      });
      
      if (muteTimers.has(muteTargetId)) {
        clearTimeout(muteTimers.get(muteTargetId));
        muteTimers.delete(muteTargetId);
      }
      
      alert(`üîä –ú—É—Ç —Å–Ω—è—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è`);
    } else {
      const mutedUntil = now() + minutes * 60 * 1000;
      await userRef.update({
        mutedUntil: mutedUntil,
        mutedBy: me.uid
      });
      
      const timer = setTimeout(async () => {
        try {
          await userRef.update({
            mutedUntil: 0,
            mutedBy: null
          });
          muteTimers.delete(muteTargetId);
        } catch (e) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Å–Ω—è—Ç–∏–∏ –º—É—Ç–∞:", e);
        }
      }, minutes * 60 * 1000);
      
      muteTimers.set(muteTargetId, timer);
      
      alert(`üîá –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥–ª—É—à–µ–Ω –Ω–∞ ${minutes} –º–∏–Ω—É—Ç`);
    }
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –º—É—Ç–∞:", e);
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏");
  }

  hideMuteModal();
}

async function checkMuteStatus(userId) {
  if (!userId) return false;
  
  try {
    const userSnap = await db.collection("users").doc(userId).get();
    if (!userSnap.exists) return false;
    
    const userData = userSnap.data();
    if (userData.mutedUntil && userData.mutedUntil > now()) {
      return true;
    }
    
    if (userData.mutedUntil && userData.mutedUntil <= now()) {
      await db.collection("users").doc(userId).update({
        mutedUntil: 0,
        mutedBy: null
      });
    }
    
    return false;
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –º—É—Ç–∞:", e);
    return false;
  }
}

/* =========================
   –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ —á–∞—Ç—É
========================= */
async function toggleBlockInChat() {
  if (!currentChatId || !me || !peer) return;

  const blockRef = db.collection("blocks").doc(currentChatId);
  await db.runTransaction(async (transaction) => {
    const blockDoc = await transaction.get(blockRef);
    const blockedBy = blockDoc.exists ? blockDoc.data().blockedBy || [] : [];
    
    if (blockedBy.includes(me.uid)) {
      transaction.set(blockRef, { blockedBy: blockedBy.filter(id => id !== me.uid) }, { merge: true });
      isBlocked = false;
      updateChatUI();
      alert("üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –≤ —ç—Ç–æ–º —á–∞—Ç–µ");
    } else {
      transaction.set(blockRef, { blockedBy: [...blockedBy, me.uid] }, { merge: true });
      isBlocked = true;
      updateChatUI();
      alert("üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –≤ —ç—Ç–æ–º —á–∞—Ç–µ");
    }
  });
}

async function checkChatBlockStatus() {
  if (!currentChatId || !me) return false;
  
  const blockRef = db.collection("blocks").doc(currentChatId);
  const blockDoc = await blockRef.get();
  
  if (blockDoc.exists) {
    const blockedBy = blockDoc.data().blockedBy || [];
    if (blockedBy.includes(me.uid)) {
      isBlocked = true;
      return true;
    }
  }
  
  isBlocked = false;
  return false;
}

/* =========================
   Tabs
========================= */
function setTab(tab){
  document.querySelectorAll(".navItem").forEach(x=>x.classList.remove("active"));
  
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(t => t.classList.remove('active'));
  
  if (tab === 'chats') {
    tabs[0].classList.add('active');
    showScreen('scr-chats');
    setTimeout(() => {
      const startIndex = 0;
      setPillToIndex(startIndex);
    }, 10);
  } else if (tab === 'profile') {
    tabs[1].classList.add('active');
    showScreen('scr-profile');
    setTimeout(() => {
      const startIndex = 1;
      setPillToIndex(startIndex);
    }, 10);
  }
}

// –¢–∞–±–±–∞—Ä
const bar = document.getElementById('tabbar');
const pill = document.getElementById('pill');
const tabs = Array.from(bar.querySelectorAll('.tab'));

let holding = false;
let dragged = false;
let downX = 0;
let lastIndex = 0;

const DRAG_THRESHOLD = 8;

function waterOn(){ bar.classList.add('is-water'); }
function waterOff(){
  bar.classList.remove('is-water');
  tabs.forEach(t => t.classList.remove('is-hovered'));
}

function setActiveIndex(i){
  tabs.forEach(t => t.classList.remove('active'));
  tabs[i].classList.add('active');
}

function setHoveredIndex(i){
  tabs.forEach(t => t.classList.remove('is-hovered'));
  tabs[i].classList.add('is-hovered');
}

function indexFromClientX(clientX){
  const r = bar.getBoundingClientRect();
  const x = Math.min(Math.max(clientX - r.left, 0), r.width);
  const colW = r.width / 2;
  let i = Math.floor(x / colW);
  return Math.max(0, Math.min(1, i));
}

function setPillToIndex(i){
  const barRect = bar.getBoundingClientRect();
  const tabRect = tabs[i].getBoundingClientRect();
  const pad = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--pad')) || 7;
  const x = tabRect.left - barRect.left - pad;
  pill.style.setProperty('--x', `${x}px`);
  lastIndex = i;
}

bar.addEventListener('pointerdown', (e) => {
  holding = true;
  dragged = false;
  downX = e.clientX;
  waterOn();
  const i = indexFromClientX(e.clientX);
  setHoveredIndex(i);
  setPillToIndex(i);
});

bar.addEventListener('pointermove', (e) => {
  if (!holding) return;
  const dx = Math.abs(e.clientX - downX);
  if (dx > DRAG_THRESHOLD) dragged = true;

  const i = indexFromClientX(e.clientX);
  setHoveredIndex(i);
  setPillToIndex(i);
});

bar.addEventListener('pointerup', (e) => {
  if (!holding) return;
  holding = false;

  const i = indexFromClientX(e.clientX);
  setActiveIndex(i);

  const tabName = i === 0 ? 'chats' : 'profile';
  setTab(tabName);

  if (!dragged){
    waterOn();
    setPillToIndex(i);
    setTimeout(waterOff, 400);
  } else {
    waterOff();
  }
});

const startIndex = tabs.findIndex(t => t.classList.contains('active'));
if (startIndex >= 0) {
  setPillToIndex(startIndex);
}

/* =========================
   Auth action
========================= */
$("authBtn").addEventListener("click", async ()=>{
  clearMsg($("authMsg"));
  const login = $("loginLogin").value.trim();
  const pass  = $("loginPass").value;

  if(!login || !pass){
    return setMsg($("authMsg"), "–ó–∞–ø–æ–ª–Ω–∏ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å.", "err");
  }

  try{
    if(authMode === "reg"){
      const nick = $("regNick").value.trim();
      const phone = $("regPhone").value.trim();
      const avatar = $("regAvatarPreview").src || defaultAvatar;

      if(!nick){
        return setMsg($("authMsg"), "–ù—É–∂–µ–Ω –Ω–∏–∫–Ω–µ–π–º.", "err");
      }

      const exists = await findUserByLogin(login);
      if(exists){
        return setMsg($("authMsg"), "–¢–∞–∫–æ–π –ª–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç.", "err");
      }

      const uid  = randId("u");
      const salt = randId("s");
      const passwordHash = await sha256Hex(`${login}:${pass}:${salt}`);

      await db.collection("users").doc(uid).set({
        login,
        salt,
        passwordHash,
        nick,
        phone,
        avatar,
        online: true,
        lastSeen: now(),
        typingTo: "",
        typingAt: 0,
        role: "user",
        star: false,
        customItems: [], // –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
        balance: 100,
        mutedUntil: 0,
        mutedBy: null,
        selectedStatus: ""
      });

      session = { uid, login };
      saveSession(session);
      await afterLogin();
      return;
    }

    const found = await findUserByLogin(login);
    if(!found){
      return setMsg($("authMsg"), "–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.", "err");
    }
    const { uid, data } = found;
    const calc = await sha256Hex(`${login}:${pass}:${data.salt}`);
    if(calc !== data.passwordHash){
      return setMsg($("authMsg"), "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.", "err");
    }

    session = { uid, login };
    saveSession(session);
    await afterLogin();
  }catch(e){
    setMsg($("authMsg"), "–û—à–∏–±–∫–∞: " + (e?.message || String(e)), "err");
  }
});

/* =========================
   After login / logout
========================= */
async function afterLogin(){
  $("bottomNav").classList.remove("hidden");
  await setOnline(true);
  startHeartbeat();

  await warmUsersCache();
  await loadMe();
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã
  const itemsSnap = await db.collection("items").get();
  itemsCache.clear();
  itemsSnap.forEach(doc => itemsCache.set(doc.id, { id: doc.id, ...doc.data() }));
  
  renderProfile();
  await updateStatusSelect(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç —Å—Ç–∞—Ç—É—Å–æ–≤

  bindChatListRealtime();

  showScreen("scr-chats");
  setTab("chats");
}

async function logout(){
  try{ await clearMyTyping(); }catch{}
  try{ await setOnline(false); }catch{}
  stopHeartbeat();

  if(unsubChatList){ unsubChatList(); unsubChatList=null; }
  if(unsubMsgs){ unsubMsgs(); unsubMsgs=null; }
  if(unsubPeer){ unsubPeer(); unsubPeer=null; }

  session=null; me=null; peer=null; currentChatId=null;
  usersCache.clear();

  clearSession();
  $("bottomNav").classList.add("hidden");
  showScreen("scr-auth");
}
$("btnLogout").addEventListener("click", logout);
$("btnLogout2").addEventListener("click", logout);

$("resetDeviceBtn").addEventListener("click", ()=>{
  localStorage.removeItem("lol_session");
  location.reload();
});

/* =========================
   About screen
========================= */
$("aboutBtn").addEventListener("click", ()=>{
  showScreen("scr-about");
});

$("aboutBackBtn").addEventListener("click", ()=>{
  showScreen("scr-profile");
});

/* =========================
   –ú–∞–≥–∞–∑–∏–Ω –∏ —Å—Ç–∞—Ç—É—Å—ã
========================= */
async function loadShopItems() {
  const snap = await db.collection("items").get();
  itemsCache.clear();
  snap.forEach(doc => itemsCache.set(doc.id, { id: doc.id, ...doc.data() }));
  
  const shopGrid = $("shopItems");
  shopGrid.innerHTML = "";
  
  itemsCache.forEach(item => {
    if (item.isActive === false) return; // —É–¥–∞–ª—ë–Ω–Ω—ã–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
    
    const isExpired = item.limited && item.expiresAt && item.expiresAt < now();
    const canBuy = !isExpired;
    
    const itemDiv = document.createElement("div");
    itemDiv.className = "shop-item";
    
    let iconHtml = '';
    if (item.iconType === 'image') {
      iconHtml = `<img src="${item.icon}" class="shop-item-badge" style="width:40px; height:40px; border-radius:8px;">`;
    } else {
      iconHtml = `<div class="shop-item-badge">${item.icon}</div>`;
    }
    
    let actions = "";
    if (me?.role === "creator") {
      actions = `
        <div class="shop-item-actions">
          <button class="btn ghost" style="padding:4px 8px;" onclick="editItem('${item.id}')">‚úèÔ∏è</button>
          <button class="btn ghost" style="padding:4px 8px;" onclick="deleteItem('${item.id}')">üóëÔ∏è</button>
        </div>
      `;
    }
    
    const priceDisplay = canBuy 
      ? `<div class="shop-item-price">${item.price} ü§£</div>`
      : `<div class="shop-item-price" style="color:var(--red);">${item.price} ü§£</div>`;
    
    const buyButton = canBuy
      ? `<button class="btn ghost" onclick="buyItem('${item.id}')" style="padding:8px;">–ö—É–ø–∏—Ç—å</button>`
      : `<div class="shop-item-expired">‚è∞ –°—Ä–æ–∫ –æ–∫–æ–Ω—á–µ–Ω</div>`;
    
    const nameHtml = item.name ? `<div style="margin-bottom:8px;">${escapeHtml(item.name)}</div>` : "";
    
    itemDiv.innerHTML = `
      ${iconHtml}
      ${nameHtml}
      ${priceDisplay}
      ${item.limited && item.expiresAt ? `<div style="font-size:11px; color:var(--muted);">–¥–æ ${new Date(item.expiresAt).toLocaleDateString()}</div>` : ''}
      ${buyButton}
      ${actions}
    `;
    
    shopGrid.appendChild(itemDiv);
  });
}

async function buyItem(itemId) {
  if (!me) return;
  
  const item = itemsCache.get(itemId);
  if (!item) return;
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ª–∏–º–∏—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –∏—Å—Ç—ë–∫—à–∏–π
  if (item.limited && item.expiresAt && item.expiresAt < now()) {
    alert("–°—Ä–æ–∫ –ø–æ–∫—É–ø–∫–∏ —ç—Ç–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –∏—Å—Ç—ë–∫");
    return;
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
  if (me.balance < item.price) {
    alert(`‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ LOL –∫–æ–∏–Ω–æ–≤! –ù—É–∂–Ω–æ ${item.price}, —É –≤–∞—Å ${me.balance}`);
    return;
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —Å—Ç–∞—Ç—É—Å
  if (itemId === 'star' && me.star) {
    alert("‚ùå –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∑–≤–µ–∑–¥–∞!");
    return;
  }
  
  if (me.customItems && me.customItems.includes(itemId)) {
    alert("‚ùå –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å —ç—Ç–æ—Ç —Å—Ç–∞—Ç—É—Å!");
    return;
  }
  
  if (!confirm(`–ö—É–ø–∏—Ç—å ${item.name || '—Å—Ç–∞—Ç—É—Å'} –∑–∞ ${item.price} ü§£?`)) return;
  
  try {
    await db.runTransaction(async (transaction) => {
      transaction.update(db.collection("users").doc(me.uid), {
        balance: firebase.firestore.FieldValue.increment(-item.price)
      });
      
      if (itemId === 'star') {
        transaction.update(db.collection("users").doc(me.uid), {
          star: true
        });
      } else {
        transaction.update(db.collection("users").doc(me.uid), {
          customItems: firebase.firestore.FieldValue.arrayUnion(itemId)
        });
      }
    });
    
    me.balance -= item.price;
    if (itemId === 'star') {
      me.star = true;
    } else {
      if (!me.customItems) me.customItems = [];
      me.customItems.push(itemId);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ UI —ç–ª–µ–º–µ–Ω—Ç—ã
    await updateSellSection();
    await updateStatusSelect();
    renderProfile();
    
    alert("‚úÖ –ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞!");
    updateBalanceScreen();
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏:", e);
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ");
  }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏)
function showAddItemModal() {
  if (me?.role !== "creator") return;
  $("addItemModal").classList.remove("hidden");
  $("itemEmoji").value = "";
  $("itemName").value = "";
  $("itemPrice").value = "";
  $("itemImage").value = "";
  $("itemExpiryDate").value = "";
  $("itemLimited").checked = false;
  toggleItemLimited();
  toggleItemIconInput();
}

function hideAddItemModal() {
  $("addItemModal").classList.add("hidden");
}

function toggleItemIconInput() {
  const type = $("itemIconType").value;
  if (type === 'emoji') {
    $("itemEmojiField").style.display = "block";
    $("itemImageField").style.display = "none";
  } else {
    $("itemEmojiField").style.display = "none";
    $("itemImageField").style.display = "block";
  }
}

function toggleItemLimited() {
  if ($("itemLimited").checked) {
    $("itemDateField").style.display = "block";
  } else {
    $("itemDateField").style.display = "none";
  }
}

async function createItem() {
  const type = $("itemIconType").value;
  const name = $("itemName").value.trim() || "";
  const price = parseInt($("itemPrice").value);
  const limited = $("itemLimited").checked;
  
  let icon = "";
  let iconType = type;
  
  if (type === 'emoji') {
    icon = $("itemEmoji").value.trim();
    if (!icon) {
      alert("–í–≤–µ–¥–∏—Ç–µ —ç–º–æ–¥–∑–∏");
      return;
    }
  } else {
    const file = $("itemImage").files[0];
    if (!file) {
      alert("–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ");
      return;
    }
    icon = await uploadAvatar(file);
  }
  
  if (!price || price < 1) {
    alert("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É");
    return;
  }
  
  let expiresAt = null;
  if (limited) {
    const date = $("itemExpiryDate").value;
    if (!date) {
      alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è");
      return;
    }
    expiresAt = new Date(date).getTime();
  }
  
  try {
    const itemRef = db.collection("items").doc();
    await itemRef.set({
      iconType,
      icon,
      name,
      price,
      limited,
      expiresAt,
      createdAt: now(),
      createdBy: me.uid,
      isActive: true
    });
    
    alert("‚úÖ –°—Ç–∞—Ç—É—Å —Å–æ–∑–¥–∞–Ω!");
    hideAddItemModal();
    loadShopItems();
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:", e);
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏");
  }
}

async function editItem(itemId) {
  if (me?.role !== "creator") return;
  
  const item = itemsCache.get(itemId);
  if (!item) return;
  
  $("editItemId").value = itemId;
  $("editName").value = item.name || "";
  $("editPrice").value = item.price;
  $("editLimited").checked = item.limited || false;
  
  if (item.iconType === 'emoji') {
    $("editIconType").value = 'emoji';
    $("editEmoji").value = item.icon;
  } else {
    $("editIconType").value = 'image';
  }
  
  toggleEditIconInput();
  toggleEditLimited();
  
  if (item.limited && item.expiresAt) {
    const date = new Date(item.expiresAt).toISOString().split('T')[0];
    $("editExpiryDate").value = date;
  }
  
  $("editItemModal").classList.remove("hidden");
}

function hideEditItemModal() {
  $("editItemModal").classList.add("hidden");
}

function toggleEditIconInput() {
  const type = $("editIconType").value;
  if (type === 'emoji') {
    $("editEmojiField").style.display = "block";
    $("editImageField").style.display = "none";
  } else {
    $("editEmojiField").style.display = "none";
    $("editImageField").style.display = "block";
  }
}

function toggleEditLimited() {
  if ($("editLimited").checked) {
    $("editDateField").style.display = "block";
  } else {
    $("editDateField").style.display = "none";
  }
}

async function saveItem() {
  const itemId = $("editItemId").value;
  const type = $("editIconType").value;
  const name = $("editName").value.trim() || "";
  const price = parseInt($("editPrice").value);
  const limited = $("editLimited").checked;
  
  let icon = null;
  let iconType = type;
  
  if (type === 'emoji') {
    icon = $("editEmoji").value.trim();
    if (!icon) {
      alert("–í–≤–µ–¥–∏—Ç–µ —ç–º–æ–¥–∑–∏");
      return;
    }
  } else {
    const file = $("editImage").files[0];
    if (file) {
      icon = await uploadAvatar(file);
    }
  }
  
  if (!price || price < 1) {
    alert("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É");
    return;
  }
  
  let expiresAt = null;
  if (limited) {
    const date = $("editExpiryDate").value;
    if (!date) {
      alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è");
      return;
    }
    expiresAt = new Date(date).getTime();
  }
  
  const updateData = {
    name,
    price,
    limited,
    expiresAt
  };
  
  if (icon) {
    updateData.iconType = iconType;
    updateData.icon = icon;
  }
  
  try {
    await db.collection("items").doc(itemId).update(updateData);
    
    alert("‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω!");
    hideEditItemModal();
    loadShopItems();
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:", e);
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏");
  }
}

async function deleteItem(itemId) {
  if (me?.role !== "creator") return;
  
  if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å—Ç–∞—Ç—É—Å –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞? –£ –∫–æ–≥–æ –æ–Ω —É–∂–µ –µ—Å—Ç—å ‚Äî –æ—Å—Ç–∞–Ω–µ—Ç—Å—è.")) return;
  
  try {
    await db.collection("items").doc(itemId).update({
      isActive: false
    });
    
    alert("‚úÖ –°—Ç–∞—Ç—É—Å —É–¥–∞–ª—ë–Ω –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞");
    loadShopItems();
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:", e);
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏");
  }
}

/* =========================
   –ü—Ä–æ–¥–∞–∂–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
========================= */
async function updateSellSection() {
  if (!me) return;
  
  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –∏–∑ –ë–î
  const itemsSnap = await db.collection("items").get();
  itemsCache.clear();
  itemsSnap.forEach(doc => itemsCache.set(doc.id, { id: doc.id, ...doc.data() }));
  
  const sellItemsDiv = $("sellItems");
  sellItemsDiv.innerHTML = "";
  selectedSellItems.clear();
  
  // –ó–≤–µ–∑–¥–∞
  if (me.star) {
    addSellItem('star', '‚≠êÔ∏è –ó–≤–µ–∑–¥–∞', 500);
  }
  
  // –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã
  if (me.customItems && me.customItems.length > 0) {
    me.customItems.forEach(itemId => {
      const item = itemsCache.get(itemId);
      if (item) {
        const displayName = item.name || '–°—Ç–∞—Ç—É—Å';
        let iconHtml = '';
        if (item.iconType === 'image') {
          iconHtml = `<img src="${item.icon}" class="sell-item-icon">`;
        } else {
          iconHtml = `<span style="font-size:20px;">${item.icon}</span>`;
        }
        addSellItem(itemId, `${iconHtml} ${displayName}`, item.price);
      }
    });
  }
  
  updateSellTotal();
}

function addSellItem(itemId, displayHtml, price) {
  const sellPrice = Math.floor(price * 0.8); // 20% –∫–æ–º–∏—Å—Å–∏—è
  
  const itemDiv = document.createElement("div");
  itemDiv.className = "sell-item";
  itemDiv.innerHTML = `
    <input type="checkbox" id="sell_${itemId}" value="${itemId}" data-price="${sellPrice}" onchange="updateSellSelection(this)">
    <label for="sell_${itemId}">${displayHtml} ‚Äî ${sellPrice} ü§£ (-20% –æ—Ç —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω—ã)</label>
  `;
  
  $("sellItems").appendChild(itemDiv);
}

function updateSellSelection(checkbox) {
  const price = parseInt(checkbox.dataset.price);
  if (checkbox.checked) {
    selectedSellItems.add({
      id: checkbox.value,
      price: price
    });
  } else {
    selectedSellItems.forEach(item => {
      if (item.id === checkbox.value) selectedSellItems.delete(item);
    });
  }
  
  updateSellTotal();
}

function updateSellTotal() {
  const total = Array.from(selectedSellItems).reduce((sum, item) => sum + item.price, 0);
  const count = selectedSellItems.size;
  
  $("sellTotal").innerHTML = `–í—ã–±—Ä–∞–Ω–æ: ${count} —Å—Ç–∞—Ç—É—Å${count !== 1 ? '–æ–≤' : ''} –Ω–∞ —Å—É–º–º—É ${total} ü§£`;
  $("sellBtn").disabled = count === 0;
}

async function sellSelected() {
  if (selectedSellItems.size === 0) return;
  
  const total = Array.from(selectedSellItems).reduce((sum, item) => sum + item.price, 0);
  
  if (!confirm(`–ü—Ä–æ–¥–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∑–∞ ${total} ü§£? –û–Ω–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –Ω–∞–≤—Å–µ–≥–¥–∞.`)) return;
  
  try {
    await db.runTransaction(async (transaction) => {
      // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
      transaction.update(db.collection("users").doc(me.uid), {
        balance: firebase.firestore.FieldValue.increment(total)
      });
      
      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã
      for (const item of selectedSellItems) {
        if (item.id === 'star') {
          transaction.update(db.collection("users").doc(me.uid), {
            star: false
          });
        } else {
          transaction.update(db.collection("users").doc(me.uid), {
            customItems: firebase.firestore.FieldValue.arrayRemove(item.id)
          });
        }
      }
    });
    
    // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –û–ë–ù–û–í–õ–Ø–ï–ú –î–ê–ù–ù–´–ï –ò–ó –ë–î
    const freshUser = await db.collection("users").doc(me.uid).get();
    me = { uid: me.uid, ...freshUser.data() };
    
    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –º–∞—Å—Å–∏–≤—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
    if (!me.customItems) me.customItems = [];
    if (!me.selectedStatus) me.selectedStatus = "";
    
    usersCache.set(me.uid, me);
    
    selectedSellItems.clear();
    alert(`‚úÖ –ü—Ä–æ–¥–∞–Ω–æ! –ü–æ–ª—É—á–µ–Ω–æ ${total} ü§£`);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ UI —ç–ª–µ–º–µ–Ω—Ç—ã
    await updateSellSection();
    await updateBalanceScreen();
    await updateStatusSelect();
    renderProfile();
    
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ:", e);
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ");
  }
}

/* =========================
   Balance screen
========================= */
$("balanceBtn").addEventListener("click", ()=>{
  showScreen("scr-balance");
  updateBalanceScreen();
});

$("balanceBackBtn").addEventListener("click", ()=>{
  showScreen("scr-profile");
});

async function updateBalanceScreen() {
  if (!me) return;
  
  $("balanceAmount").textContent = me.balance || 0;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è
  if (me.role === "creator") {
    $("addBalanceBtn").style.display = "inline-block";
    $("addItemBtn").style.display = "inline-block";
    $("creatorPromoSection").style.display = "block";
    $("addBalanceBtn").onclick = showAddBalanceModal;
  } else {
    $("addBalanceBtn").style.display = "none";
    $("addItemBtn").style.display = "none";
    $("creatorPromoSection").style.display = "none";
  }
}

async function updateStatusSelect() {
  // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –∏–∑ –ë–î
  const itemsSnap = await db.collection("items").get();
  itemsCache.clear();
  itemsSnap.forEach(doc => itemsCache.set(doc.id, { id: doc.id, ...doc.data() }));
  
  const statusSelect = $("statusSelect");
  
  // –û—á–∏—â–∞–µ–º –≤—Å–µ –æ–ø—Ü–∏–∏ –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π
  while (statusSelect.options.length > 1) {
    statusSelect.remove(1);
  }
  
  console.log("–ú–æ–∏ —Å—Ç–∞—Ç—É—Å—ã:", me.customItems); // –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  console.log("–ö—ç—à —Å—Ç–∞—Ç—É—Å–æ–≤:", Array.from(itemsCache.keys())); // –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∑–≤–µ–∑–¥—É, –µ—Å–ª–∏ –µ—Å—Ç—å
  if (me.star) {
    const option = document.createElement("option");
    option.value = "star";
    option.textContent = "‚≠êÔ∏è –ó–≤–µ–∑–¥–∞";
    if (me.selectedStatus === "star") option.selected = true;
    statusSelect.appendChild(option);
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã
  if (me.customItems && me.customItems.length > 0) {
    me.customItems.forEach(itemId => {
      const item = itemsCache.get(itemId);
      if (item) {
        const option = document.createElement("option");
        option.value = itemId;
        
        if (item.iconType === 'image') {
          // –î–ª—è —Ñ–æ—Ç–æ —Å–æ–∑–¥–∞—ë–º –∫–∞—Å—Ç–æ–º–Ω—É—é –æ–ø—Ü–∏—é —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π
          option.style.backgroundImage = `url('${item.icon}')`;
          option.style.backgroundSize = '20px';
          option.style.backgroundRepeat = 'no-repeat';
          option.style.backgroundPosition = 'left center';
          option.style.paddingLeft = '30px';
          option.textContent = item.name || '–°—Ç–∞—Ç—É—Å';
        } else {
          option.textContent = `${item.icon} ${item.name || '–°—Ç–∞—Ç—É—Å'}`;
        }
        
        if (me.selectedStatus === itemId) option.selected = true;
        statusSelect.appendChild(option);
      }
    });
  }
}

async function changeStatus() {
  const statusSelect = $("statusSelect");
  const newStatus = statusSelect.value;
  
  await db.collection("users").doc(me.uid).update({
    selectedStatus: newStatus
  });
  
  me.selectedStatus = newStatus;
  renderProfile(); // –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∏–∫–∞
}

/* =========================
   –ü—Ä–æ–º–æ–∫–æ–¥—ã
========================= */
function togglePromoType() {
  const type = document.querySelector('input[name="promoType"]:checked').value;
  if (type === 'date') {
    $("promoDateField").style.display = "block";
    $("promoCountField").style.display = "none";
  } else {
    $("promoDateField").style.display = "none";
    $("promoCountField").style.display = "block";
  }
}

async function activatePromo() {
  const code = $("promoCode").value.trim();
  if (!code) return;
  
  const promoRef = db.collection("promocodes").doc(code);
  const promoDoc = await promoRef.get();
  
  if (!promoDoc.exists) {
    alert("–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω");
    return;
  }
  
  const promo = promoDoc.data();
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
  if (promo.type === 'date') {
    if (promo.expiresAt < now()) {
      alert("–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏—Å—Ç—ë–∫");
      return;
    }
  } else {
    if (promo.activationsLeft <= 0) {
      alert("–ü—Ä–æ–º–æ–∫–æ–¥ –±–æ–ª—å—à–µ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω");
      return;
    }
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  const userPromoRef = db.collection("userPromocodes").doc(`${me.uid}_${code}`);
  const userPromoDoc = await userPromoRef.get();
  
  if (userPromoDoc.exists) {
    alert("‚ùå –í—ã —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥");
    return;
  }
  
  try {
    await db.runTransaction(async (transaction) => {
      if (promo.type !== 'date') {
        transaction.update(promoRef, {
          activationsLeft: promo.activationsLeft - 1
        });
      }
      
      transaction.set(userPromoRef, {
        userId: me.uid,
        promoCode: code,
        activatedAt: now()
      });
      
      transaction.update(db.collection("users").doc(me.uid), {
        balance: firebase.firestore.FieldValue.increment(promo.amount)
      });
    });
    
    me.balance += promo.amount;
    alert(`‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! +${promo.amount} LOL`);
    updateBalanceScreen();
    $("promoCode").value = "";
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞:", e);
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏");
  }
}

function showCreatePromoModal() {
  if (me?.role !== "creator") return;
  $("createPromoModal").classList.remove("hidden");
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª—è
  $("promoCodeInput").value = "";
  $("promoAmount").value = "";
  $("promoDate").value = "";
  $("promoActivations").value = "";
  document.querySelector('input[name="promoType"][value="date"]').checked = true;
  togglePromoType();
}

function hideCreatePromoModal() {
  $("createPromoModal").classList.add("hidden");
}

async function createPromo() {
  const code = $("promoCodeInput").value.trim();
  const amount = parseInt($("promoAmount").value);
  const type = document.querySelector('input[name="promoType"]:checked').value;
  
  let promoData = {
    code,
    amount,
    type,
    createdBy: me.uid,
    createdAt: now()
  };
  
  if (type === 'date') {
    const date = $("promoDate").value;
    if (!date) {
      alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è");
      return;
    }
    promoData.expiresAt = new Date(date).getTime();
    promoData.activationsLeft = 999999; // –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
  } else {
    const activations = parseInt($("promoActivations").value);
    if (!activations || activations < 1) {
      alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π");
      return;
    }
    promoData.activationsTotal = activations;
    promoData.activationsLeft = activations;
  }
  
  if (!code || !amount) {
    alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
    return;
  }
  
  try {
    await db.collection("promocodes").doc(code).set(promoData);
    alert("‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ–∑–¥–∞–Ω!");
    hideCreatePromoModal();
    updatePromoStats();
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞:", e);
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏");
  }
}

async function updatePromoStats() {
  if (!me || me.role !== "creator") return;
  
  const promosSnapshot = await db.collection("promocodes").get();
  const statsList = $("promoStatsList");
  statsList.innerHTML = "";
  
  promosSnapshot.forEach(doc => {
    const promo = doc.data();
    const row = document.createElement("div");
    row.className = "promo-stat-row";
    
    let statusText = "";
    if (promo.type === 'date') {
      const expiryDate = new Date(promo.expiresAt).toLocaleDateString('ru-RU');
      statusText = `–¥–æ ${expiryDate}`;
    } else {
      statusText = `${promo.activationsLeft}/${promo.activationsTotal}`;
    }
    
    row.innerHTML = `
      <span>${promo.code}</span>
      <span>${promo.amount} ü§£</span>
      <span>${promo.type === 'date' ? 'üìÖ' : 'üî¢'}</span>
      <span>${statusText}</span>
    `;
    statsList.appendChild(row);
  });
}

function showAddBalanceModal() {
  if (me?.role !== "creator") return;
  $("addBalanceModal").classList.remove("hidden");
  $("addBalanceAmount").value = "";
}

function hideAddBalanceModal() {
  $("addBalanceModal").classList.add("hidden");
}

async function addBalance() {
  const amount = parseInt($("addBalanceAmount").value);
  if (!amount || amount < 1) return;
  
  try {
    await db.collection("users").doc(me.uid).update({
      balance: firebase.firestore.FieldValue.increment(amount)
    });
    
    me.balance += amount;
    alert(`‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${amount} LOL`);
    hideAddBalanceModal();
    updateBalanceScreen();
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:", e);
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏");
  }
}

/* =========================
   –ü–æ–¥–∞—Ä–∫–∏ –≤ —á–∞—Ç–µ
========================= */
async function loadGiftItems() {
  const giftType = $("giftType");
  
  // –û—á–∏—â–∞–µ–º –≤—Å–µ –æ–ø—Ü–∏–∏ –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π (–∫–æ–∏–Ω—ã)
  while (giftType.options.length > 1) {
    giftType.remove(1);
  }
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞
  const itemsSnap = await db.collection("items").where("isActive", "==", true).get();
  itemsSnap.forEach(doc => {
    const item = doc.data();
    const isExpired = item.limited && item.expiresAt && item.expiresAt < now();
    if (!isExpired) {
      const option = document.createElement("option");
      option.value = doc.id;
      const icon = item.iconType === 'image' ? 'üñºÔ∏è' : item.icon;
      const name = item.name || '–°—Ç–∞—Ç—É—Å';
      option.textContent = `${icon} ${name} (${item.price} ü§£)`;
      giftType.appendChild(option);
    }
  });
}

function showGiftModal() {
  if (!peer) return;
  loadGiftItems();
  $("giftModal").classList.remove("hidden");
  $("giftCoinsInput").style.display = 'block';
}

function hideGiftModal() {
  $("giftModal").classList.add("hidden");
}

async function confirmGift() {
  const type = $("giftType").value;
  const coins = type === 'coins' ? parseInt($("giftCoins").value) : 0;
  
  if (type === 'coins' && (!coins || coins < 1)) {
    alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤");
    return;
  }
  
  let cost = 0;
  let itemId = null;
  
  if (type === 'coins') {
    cost = coins;
  } else {
    itemId = type;
    const item = itemsCache.get(itemId);
    if (!item) {
      alert("–°—Ç–∞—Ç—É—Å –Ω–µ –Ω–∞–π–¥–µ–Ω");
      return;
    }
    cost = item.price;
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –¥–∞—Ä–∏—Ç–µ–ª—è
  if (me.balance < cost) {
    alert("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ LOL –∫–æ–∏–Ω–æ–≤! –£ –≤–∞—Å —Ç–æ–ª—å–∫–æ " + me.balance);
    return;
  }
  
  // –ü–û–õ–£–ß–ê–ï–ú –ê–ö–¢–£–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï –ü–û–õ–£–ß–ê–¢–ï–õ–Ø
  const peerSnap = await db.collection("users").doc(peer.uid).get();
  const freshPeer = peerSnap.data();
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ —É –¥—Ä—É–≥–∞ —É–∂–µ —Ç–∞–∫–æ–π —Å—Ç–∞—Ç—É—Å
  if (itemId) {
    if (itemId === 'star' && freshPeer.star) {
      alert(`‚ùå –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${peer.nick} —É–∂–µ –µ—Å—Ç—å –∑–≤–µ–∑–¥–∞!`);
      return;
    }
    if (freshPeer.customItems && freshPeer.customItems.includes(itemId)) {
      alert(`‚ùå –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${peer.nick} —É–∂–µ –µ—Å—Ç—å —ç—Ç–æ—Ç —Å—Ç–∞—Ç—É—Å!`);
      return;
    }
  }
  
  if (!confirm(`–ü–æ–¥–∞—Ä–∏—Ç—å ${type === 'coins' ? coins + ' LOL' : '—Å—Ç–∞—Ç—É—Å'} –∑–∞ ${cost} ü§£?`)) return;
  
  try {
    await db.runTransaction(async (transaction) => {
      transaction.update(db.collection("users").doc(me.uid), {
        balance: firebase.firestore.FieldValue.increment(-cost)
      });
      
      if (type === 'coins') {
        transaction.update(db.collection("users").doc(peer.uid), {
          balance: firebase.firestore.FieldValue.increment(coins)
        });
      } else {
        transaction.update(db.collection("users").doc(peer.uid), {
          customItems: firebase.firestore.FieldValue.arrayUnion(itemId)
        });
      }
      
      const giftRef = db.collection("gifts").doc();
      transaction.set(giftRef, {
        from: me.uid,
        to: peer.uid,
        type: type === 'coins' ? 'coins' : 'item',
        itemId: itemId,
        amount: cost,
        time: now()
      });
    });
    
    me.balance -= cost;
    alert(`‚úÖ –ü–æ–¥–∞—Ä–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!`);
    hideGiftModal();
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∞—Ä–∫–µ:", e);
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–æ–¥–∞—Ä–∫–∞");
  }
}

function showCreatorGiftModal() {
  if (!peer || me?.role !== "creator") return;
  $("creatorGiftModal").classList.remove("hidden");
  $("creatorGiftCoins").value = "";
}

function hideCreatorGiftModal() {
  $("creatorGiftModal").classList.add("hidden");
}

async function confirmCreatorGift() {
  const coins = parseInt($("creatorGiftCoins").value);
  if (!coins || coins < 1) return;
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ —Å–æ–∑–¥–∞—Ç–µ–ª—è
  if (me.balance < coins) {
    alert("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ LOL –∫–æ–∏–Ω–æ–≤! –£ –≤–∞—Å —Ç–æ–ª—å–∫–æ " + me.balance);
    return;
  }
  
  if (!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å ${coins} LOL –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${peer.nick}?`)) return;
  
  try {
    await db.runTransaction(async (transaction) => {
      transaction.update(db.collection("users").doc(me.uid), {
        balance: firebase.firestore.FieldValue.increment(-coins)
      });
      
      transaction.update(db.collection("users").doc(peer.uid), {
        balance: firebase.firestore.FieldValue.increment(coins)
      });
      
      const giftRef = db.collection("gifts").doc();
      transaction.set(giftRef, {
        from: me.uid,
        to: peer.uid,
        type: 'coins',
        amount: coins,
        time: now(),
        creatorGift: true
      });
    });
    
    me.balance -= coins;
    alert(`‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${coins} LOL`);
    hideCreatorGiftModal();
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ:", e);
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ");
  }
}

/* =========================
   Profile
========================= */
function renderProfile(){
  if(!me) return;
  $("meAvatar").src = me.avatar || defaultAvatar;
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–∏–∫ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º
  let nickHtml = escapeHtml(me.nick || "–ö—Ç–æ-—Ç–æ");
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å
  if (me.selectedStatus === 'star' && me.star) {
    nickHtml += ' <span style="font-size:18px;">‚≠êÔ∏è</span>';
  } else if (me.selectedStatus && me.customItems && me.customItems.includes(me.selectedStatus)) {
    const item = itemsCache.get(me.selectedStatus);
    if (item) {
      if (item.iconType === 'image') {
        nickHtml += ` <img src="${item.icon}" style="width:20px; height:20px; border-radius:4px; vertical-align:middle;">`;
      } else {
        nickHtml += ` <span style="font-size:18px;">${item.icon}</span>`;
      }
    }
  }
  
  if (me.role === "creator") nickHtml += ' <span style="font-size:20px;">üî®</span>';
  $("meNick").innerHTML = nickHtml;
  
  $("mePhone").textContent = me.phone || "";
  $("meLogin").textContent = "–õ–æ–≥–∏–Ω: " + (me.login || "");
  $("balanceDisplay").textContent = me.balance || 0;

  $("editAvatarPreview").src = me.avatar || defaultAvatar;
  $("editNick").value = me.nick || "";
  $("editPhone").value = me.phone || "";

  const creatorBtn = $("creatorBtn");
  if (me.role === "creator") {
    creatorBtn.textContent = "üî® –£–±—Ä–∞—Ç—å —Å–æ–∑–¥–∞—Ç–µ–ª—è";
    creatorBtn.classList.remove("hidden");
  } else {
    creatorBtn.textContent = "üî® –°—Ç–∞—Ç—å —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º";
    creatorBtn.classList.remove("hidden");
  }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É üéÅ‚ûï —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è
  if (me.role === "creator") {
    $("creatorGiftBtn").style.display = "inline-block";
  } else {
    $("creatorGiftBtn").style.display = "none";
  }
}

$("saveProfileBtn").addEventListener("click", async ()=>{
  clearMsg($("profileMsg"));
  const nick = $("editNick").value.trim() || "–ö—Ç–æ-—Ç–æ";
  const phone = $("editPhone").value.trim() || "";
  
  let avatar = $("editAvatarPreview").src;
  const fileInput = $("editAvatarFile");
  
  if (fileInput.files && fileInput.files[0]) {
    try {
      avatar = await uploadAvatar(fileInput.files[0]);
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏:", e);
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∫–∏");
      return;
    }
  }

  try{
    await db.collection("users").doc(me.uid).set({ 
      nick, 
      phone, 
      avatar 
    }, { merge:true });
    
    me.nick = nick; 
    me.phone = phone; 
    me.avatar = avatar;
    usersCache.set(me.uid, me);
    renderProfile();
    setMsg($("profileMsg"), "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ", "ok");
  }catch(e){
    setMsg($("profileMsg"), "–û—à–∏–±–∫–∞: " + (e?.message || String(e)), "err");
  }
});

/* =========================
   Chats list realtime
========================= */
function bindChatListRealtime(){
  if(!me) return;
  if(unsubChatList){ unsubChatList(); unsubChatList=null; }

  unsubChatList = db.collection("chats")
    .where("participants", "array-contains", me.uid)
    .onSnapshot(async (snap)=>{
      await warmUsersCache();

      let items=[];
      snap.forEach(d=>{
        const c=d.data();
        if((c.lastTime||0) > 0){
          items.push({ id:d.id, ...c });
        }
      });
      items.sort((a,b)=>(b.lastTime||0)-(a.lastTime||0));

      const box = $("chatList");
      box.innerHTML = "";

      if(items.length===0){
        const div=document.createElement("div");
        div.style.padding="10px 16px";
        div.style.color="rgba(234,241,255,.55)";
        div.style.fontWeight="1100";
        div.textContent="–ü–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤. –ù–∞–∂–º–∏ –ø–æ–∏—Å–∫ –∏ –Ω–∞–ø–∏—à–∏ –∫–æ–º—É-–Ω–∏–±—É–¥—å.";
        box.appendChild(div);
        return;
      }

      for(const c of items){
        const peerId = (c.participants||[]).find(x=>x!==me.uid);
        const u = usersCache.get(peerId) || { nick:"–ö—Ç–æ-—Ç–æ", avatar: defaultAvatar, online:false, lastSeen:0 };

        const row=document.createElement("div");
        row.className="row";
        
        let nameHtml = escapeHtml(u.nick || "–ö—Ç–æ-—Ç–æ");
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (u.selectedStatus === 'star' && u.star) {
          nameHtml += ' <span style="font-size:16px;">‚≠êÔ∏è</span>';
        } else if (u.selectedStatus && u.customItems && u.customItems.includes(u.selectedStatus)) {
          const item = itemsCache.get(u.selectedStatus);
          if (item) {
            if (item.iconType === 'image') {
              nameHtml += ` <img src="${item.icon}" style="width:16px; height:16px; border-radius:4px; vertical-align:middle;">`;
            } else {
              nameHtml += ` <span style="font-size:16px;">${item.icon}</span>`;
            }
          }
        }
        
        row.innerHTML = `
          <img class="avatar" src="${escapeHtml(u.avatar || defaultAvatar)}" alt="">
          <div class="meta">
            <div class="nameLine">
              <div class="name">${nameHtml}</div>
              <div class="time">${c.lastTime ? fmtTime(c.lastTime) : ""}</div>
            </div>
            <div class="preview">
              <div class="snippet">${escapeHtml(c.lastText || "")}</div>
            </div>
          </div>
        `;
        row.addEventListener("click", ()=> openChat(peerId));
        box.appendChild(row);
      }
    }, (err)=>{
      $("chatList").innerHTML = `<div class="err" style="margin:10px;">–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —á–∞—Ç–æ–≤: ${escapeHtml(err?.message || String(err))}</div>`;
    });
}

/* =========================
   Search screen
========================= */
$("openSearch").addEventListener("click", async ()=>{
  await warmUsersCache();
  $("searchInput").value = "";
  $("searchResults").innerHTML = "";
  $("searchEmpty").textContent = "–ù–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º‚Ä¶";
  showScreen("scr-search");
  $("searchInput").focus();
});

$("cancelSearch").addEventListener("click", ()=> showScreen("scr-chats"));

$("clearSearch").addEventListener("click", ()=>{
  $("searchInput").value = "";
  $("searchResults").innerHTML = "";
  $("searchEmpty").textContent = "–ù–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º‚Ä¶";
  $("searchInput").focus();
});

$("searchInput").addEventListener("input", ()=>{
  const q = $("searchInput").value.trim().toLowerCase();
  const box = $("searchResults");
  box.innerHTML = "";

  if(!q){
    $("searchEmpty").textContent = "–ù–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º‚Ä¶";
    return;
  }

  let found=[];
  for(const [uid,u] of usersCache.entries()){
    if(!me) continue;
    if(uid === me.uid) continue;
    if((u.login||"") === (me.login||"")) continue;

    const nick = (u.nick||"").toLowerCase();
    if(nick.includes(q)) found.push(u);
  }

  found.sort((a,b)=>{
    const ao = isOnline(a) ? 1 : 0;
    const bo = isOnline(b) ? 1 : 0;
    if(ao !== bo) return bo - ao;
    return (a.nick||"").localeCompare(b.nick||"", "ru");
  });

  $("searchEmpty").textContent = found.length ? "" : "–ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ";

  for(const u of found.slice(0, 40)){
    const row=document.createElement("div");
    row.className="row";
    
    let nameHtml = escapeHtml(u.nick || "–ö—Ç–æ-—Ç–æ");
    if (u.selectedStatus === 'star' && u.star) {
      nameHtml += ' <span style="font-size:16px;">‚≠êÔ∏è</span>';
    } else if (u.selectedStatus && u.customItems && u.customItems.includes(u.selectedStatus)) {
      const item = itemsCache.get(u.selectedStatus);
      if (item) {
        if (item.iconType === 'image') {
          nameHtml += ` <img src="${item.icon}" style="width:16px; height:16px; border-radius:4px; vertical-align:middle;">`;
        } else {
          nameHtml += ` <span style="font-size:16px;">${item.icon}</span>`;
        }
      }
    }
    
    row.innerHTML = `
      <img class="avatar" src="${escapeHtml(u.avatar || defaultAvatar)}" alt="">
      <div class="meta">
        <div class="nameLine" style="justify-content:flex-start; gap:10px;">
          <div class="name" style="max-width:68%;">${nameHtml}</div>
          <div class="statusDot ${isOnline(u) ? "on" : ""}" title="${isOnline(u) ? "–æ–Ω–ª–∞–π–Ω" : "–æ—Ñ—Ñ–ª–∞–π–Ω"}"></div>
        </div>
        <div class="sub">${isOnline(u) ? "–æ–Ω–ª–∞–π–Ω" : onlineText(u)}</div>
      </div>
    `;
    row.addEventListener("click", ()=> openChat(u.uid));
    box.appendChild(row);
  }
});

/* =========================
   Chat: open / close / messages
========================= */
function stopPeerWatch(){
  if(unsubPeer){ unsubPeer(); unsubPeer=null; }
}

function stopMsgWatch(){
  if(unsubMsgs){ unsubMsgs(); unsubMsgs=null; }
}

async function markAsRead(messageIds) {
  if (!messageIds || messageIds.length === 0) return;
  
  const chatRef = db.collection("chats").doc(currentChatId);
  const batch = db.batch();
  
  messageIds.forEach(id => {
    const msgRef = chatRef.collection("messages").doc(id);
    batch.update(msgRef, {
      readBy: firebase.firestore.FieldValue.arrayUnion(me.uid)
    });
  });
  
  await batch.commit();
}

async function openChat(peerId){
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º —á–∞—Ç–∞
  const itemsSnap = await db.collection("items").get();
  itemsCache.clear();
  itemsSnap.forEach(doc => itemsCache.set(doc.id, { id: doc.id, ...doc.data() }));
  
  await warmUsersCache();
  const u = usersCache.get(peerId);
  if(!u){ alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"); return; }

  peer = u;
  currentChatId = chatIdFor(me.uid, peerId);

  $("peerAvatar").src = peer.avatar || defaultAvatar;
  
  let nickHtml = escapeHtml(peer.nick || "–ö—Ç–æ-—Ç–æ");
  if (peer.selectedStatus === 'star' && peer.star) {
    nickHtml += ' <span style="font-size:16px;">‚≠êÔ∏è</span>';
  } else if (peer.selectedStatus && peer.customItems && peer.customItems.includes(peer.selectedStatus)) {
    const item = itemsCache.get(peer.selectedStatus);
    if (item) {
      if (item.iconType === 'image') {
        nickHtml += ` <img src="${item.icon}" style="width:16px; height:16px; border-radius:4px; vertical-align:middle;">`;
      } else {
        nickHtml += ` <span style="font-size:16px;">${item.icon}</span>`;
      }
    }
  }
  $("peerNick").innerHTML = nickHtml;
  
  const actions = $("chatActions");
  actions.innerHTML = "";

  const blockBtn = document.createElement("div");
  blockBtn.className = "action-btn";
  blockBtn.innerHTML = "üö´";
  blockBtn.title = "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤ —ç—Ç–æ–º —á–∞—Ç–µ";
  blockBtn.onclick = toggleBlockInChat;
  actions.appendChild(blockBtn);

  if (me.role === "creator") {
    const verifyBtn = document.createElement("div");
    verifyBtn.className = "action-btn creator-action-btn";
    verifyBtn.innerHTML = "‚úÖ";
    verifyBtn.title = "–í—ã–¥–∞—Ç—å/–∑–∞–±—Ä–∞—Ç—å —Å–∏–Ω—é—é –≥–∞–ª–æ—á–∫—É";
    verifyBtn.onclick = () => toggleVerify(peer.uid);
    actions.appendChild(verifyBtn);

    const muteBtn = document.createElement("div");
    muteBtn.className = "action-btn creator-action-btn";
    muteBtn.innerHTML = "üö´";
    muteBtn.title = "–û–≥–ª—É—à–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è";
    muteBtn.onclick = () => showMuteModal(peer.uid);
    actions.appendChild(muteBtn);
  }

  await checkChatBlockStatus();
  
  stopPeerWatch();
  unsubPeer = db.collection("users").doc(peerId).onSnapshot(async (snap)=>{
    if(!snap.exists) return;
    peer = { uid: snap.id, ...snap.data() };
    usersCache.set(peer.uid, peer);

    const typing = (peer.typingTo === me.uid) && ((now() - (peer.typingAt||0)) < 4000);
    
    const blockedByPeer = await checkChatBlockStatus();
    
    const isMuted = peer.mutedUntil && peer.mutedUntil > now();
    
    if (isMuted) {
      const minutesLeft = Math.ceil((peer.mutedUntil - now()) / 60000);
      $("peerStatus").textContent = `üîá –ó–∞–≥–ª—É—à–µ–Ω (–µ—â—ë ${minutesLeft} –º–∏–Ω)`;
    } else if (blockedByPeer) {
      $("peerStatus").textContent = "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —ç—Ç–∏–º —á–µ–ª–æ–≤–µ–∫–æ–º";
    } else if (typing) {
      $("peerStatus").textContent = "–ü–µ—á–∞—Ç–∞–µ—Ç‚Ä¶";
    } else {
      $("peerStatus").textContent = onlineText(peer);
    }

    let nickHtml = escapeHtml(peer.nick || "–ö—Ç–æ-—Ç–æ");
    if (peer.selectedStatus === 'star' && peer.star) {
      nickHtml += ' <span style="font-size:16px;">‚≠êÔ∏è</span>';
    } else if (peer.selectedStatus && peer.customItems && peer.customItems.includes(peer.selectedStatus)) {
      const item = itemsCache.get(peer.selectedStatus);
      if (item) {
        if (item.iconType === 'image') {
          nickHtml += ` <img src="${item.icon}" style="width:16px; height:16px; border-radius:4px; vertical-align:middle;">`;
        } else {
          nickHtml += ` <span style="font-size:16px;">${item.icon}</span>`;
        }
      }
    }
    $("peerNick").innerHTML = nickHtml;
  });

  const chatRef = db.collection("chats").doc(currentChatId);
  const chatSnap = await chatRef.get();
  if(!chatSnap.exists){
    await chatRef.set({
      participants:[me.uid, peerId],
      lastText:"",
      lastTime:0
    });
  }

  stopMsgWatch();
  let unreadMessageIds = [];
  
  unsubMsgs = chatRef.collection("messages").orderBy("time").onSnapshot((ss)=>{
    const box = $("msgList");
    box.innerHTML = "";
    unreadMessageIds = [];

    ss.forEach(doc => {
      const m = doc.data();
      const b = document.createElement("div");
      b.className = "bubble" + (m.sender === me.uid ? " me" : "");
      
      const textDiv = document.createElement("div");
      textDiv.textContent = m.text || "";
      b.appendChild(textDiv);

      const footerDiv = document.createElement("div");
      footerDiv.className = "message-footer";
      
      const timeSpan = document.createElement("span");
      timeSpan.className = "t";
      timeSpan.textContent = m.time ? fmtTime(m.time) : "";
      footerDiv.appendChild(timeSpan);

      if (m.sender === me.uid) {
        const statusSpan = document.createElement("span");
        statusSpan.className = "message-status";
        
        const isRead = m.readBy && m.readBy.includes(peer.uid);
        
        if (isRead) {
          statusSpan.innerHTML = '‚úî‚úî';
          statusSpan.classList.add("status-read");
        } else {
          statusSpan.innerHTML = '‚úî';
          statusSpan.classList.add("status-delivered");
        }
        
        footerDiv.appendChild(statusSpan);
      } else {
        if (!m.readBy || !m.readBy.includes(me.uid)) {
          unreadMessageIds.push(doc.id);
        }
      }

      b.appendChild(footerDiv);
      box.appendChild(b);
    });

    if (unreadMessageIds.length > 0) {
      markAsRead(unreadMessageIds);
    }

    box.scrollTop = box.scrollHeight;
  });

  $("msgInput").value = "";
  await clearMyTyping();
  updateChatUI();

  showScreen("scr-chat");
  $("msgInput").focus();
}

function closeChat(){
  clearMyTyping();
  showScreen("scr-chats");
}

$("backToChats").addEventListener("click", closeChat);
$("exitChat").addEventListener("click", closeChat);

function updateChatUI() {
  const sendBtn = $("sendBtn");
  const msgInput = $("msgInput");
  
  if (isBlocked) {
    sendBtn.disabled = true;
    msgInput.disabled = true;
    msgInput.placeholder = "–í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ —ç—Ç–æ–º —á–∞—Ç–µ";
  } else {
    sendBtn.disabled = false;
    msgInput.disabled = false;
    msgInput.placeholder = "–°–æ–æ–±—â–µ–Ω–∏–µ";
  }
}

async function sendMessage(){
  if (isBlocked) {
    alert("–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —ç—Ç–æ–º —á–∞—Ç–µ");
    return;
  }
  
  const isMuted = await checkMuteStatus(me.uid);
  if (isMuted) {
    alert("–í—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–≥–ª—É—à–µ–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è");
    return;
  }
  
  const text = $("msgInput").value.trim();
  if(!text || !currentChatId || !peer) return;

  $("msgInput").value = "";
  const chatRef = db.collection("chats").doc(currentChatId);

  const msgData = {
    text,
    sender: me.uid,
    time: now(),
    readBy: [me.uid]
  };

  await chatRef.collection("messages").add(msgData);

  await chatRef.set({
    participants: [me.uid, peer.uid],
    lastText: text,
    lastTime: now()
  }, { merge:true });

  await clearMyTyping();
}

$("sendBtn").addEventListener("click", sendMessage);
$("msgInput").addEventListener("keydown", (e)=>{
  if(e.key === "Enter") sendMessage();
});

/* =========================
   Typing
========================= */
async function setMyTyping(){
  if(!peer || !session || isBlocked) return;
  const isMuted = await checkMuteStatus(me.uid);
  if (isMuted) return;
  
  try{
    await db.collection("users").doc(me.uid).set({
      typingTo: peer.uid,
      typingAt: now()
    }, { merge:true });
  }catch{}
}

async function clearMyTyping(){
  if(!session || !me) return;
  try{
    await db.collection("users").doc(me.uid).set({
      typingTo: "",
      typingAt: 0
    }, { merge:true });
  }catch{}
}

$("msgInput").addEventListener("input", ()=>{
  if(!peer || isBlocked) return;

  if(!typingTimer){
    typingTimer = setTimeout(async ()=>{
      typingTimer = null;
      await setMyTyping();
    }, 150);
  }

  if(typingClearTimer) clearTimeout(typingClearTimer);
  typingClearTimer = setTimeout(()=> clearMyTyping(), 1200);
});

/* =========================
   Boot
========================= */
(async ()=>{
  $("composer").style.display = "none";

  const s = loadSession();
  if(s && s.uid){
    session = s;
    try{
      await afterLogin();
    }catch(e){
      await logout();
      setAuthMode("login");
      setMsg($("authMsg"), "–°–µ—Å—Å–∏—è —É—Å—Ç–∞—Ä–µ–ª–∞. –í–æ–π–¥–∏ –∑–∞–Ω–æ–≤–æ.", "err");
    }
  }else{
    setAuthMode("login");
  }

  $("muteModal").addEventListener("click", (e) => {
    if (e.target === $("muteModal")) hideMuteModal();
  });
  
  $("giftModal").addEventListener("click", (e) => {
    if (e.target === $("giftModal")) hideGiftModal();
  });
  
  $("creatorGiftModal").addEventListener("click", (e) => {
    if (e.target === $("creatorGiftModal")) hideCreatorGiftModal();
  });
  
  $("createPromoModal").addEventListener("click", (e) => {
    if (e.target === $("createPromoModal")) hideCreatePromoModal();
  });
  
  $("addItemModal").addEventListener("click", (e) => {
    if (e.target === $("addItemModal")) hideAddItemModal();
  });
  
  $("editItemModal").addEventListener("click", (e) => {
    if (e.target === $("editItemModal")) hideEditItemModal();
  });
  
  $("addBalanceModal").addEventListener("click", (e) => {
    if (e.target === $("addBalanceModal")) hideAddBalanceModal();
  });
})();
</script>
</body>
</html>
