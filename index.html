<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LOL Messenger</title>

  <style>
    :root{
      --bg:#070a10;
      --panel:rgba(18,24,38,.72);
      --panel2:rgba(10,14,22,.88);
      --line:rgba(255,255,255,.08);
      --text:#eaf1ff;
      --muted:rgba(234,241,255,.62);
      --muted2:rgba(234,241,255,.40);
      --blue:#2b86ff;
      --blue2:#1f6bff;
      --ok:#22c55e;
      --shadow:0 18px 45px rgba(0,0,0,.45);

      --tabbar-h:72px;          /* –≤—ã—Å–æ—Ç–∞ —Ç–∞–±–±–∞—Ä–∞ */
      --composer-h:72px;        /* –≤–∏–∑—É–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–æ–º–ø–æ–∑–µ—Ä–∞ (–¥–ª—è –æ—Ç—Å—Ç—É–ø–æ–≤) */
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% -10%, rgba(43,134,255,.22), transparent 60%),
        radial-gradient(850px 550px at 85% 0%, rgba(168,85,247,.18), transparent 58%),
        radial-gradient(900px 700px at 60% 110%, rgba(34,197,94,.10), transparent 55%),
        var(--bg);
      overflow:hidden;
    }

    .app{ height:100%; display:flex; flex-direction:column; }
    .screen{ display:none; height:100%; overflow:hidden; }
    .screen.active{ display:block; }

    .glass{
      background:var(--panel);
      border:1px solid var(--line);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: var(--shadow);
    }

    .topbar{
      padding:14px 16px 10px;
      padding-top:max(14px, env(safe-area-inset-top));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .topbar h1{
      margin:0;
      font-size:28px;
      font-weight:1000;
      letter-spacing:.2px;
    }

    .iconbtn{
      width:40px; height:40px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      display:grid; place-items:center;
      cursor:pointer;
    }

    .btn{
      width:100%;
      padding:12px 14px;
      border:none;
      border-radius:16px;
      font-weight:1000;
      color:white;
      background: linear-gradient(180deg, var(--blue), var(--blue2));
      cursor:pointer;
    }
    .btn.ghost{
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
    }

    .field{
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px;
      margin-bottom:10px;
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted2);
      font-weight:1000;
      margin-bottom:6px;
      text-transform:uppercase;
      letter-spacing:.4px;
    }
    .field input{
      width:100%;
      border:none; outline:none;
      background:transparent;
      color:var(--text);
      font-size:16px;
      font-weight:1000;
    }

    .hint{ color:var(--muted); font-weight:900; font-size:13px; }
    .err{ color:#fecaca; background: rgba(239,68,68,.14); border: 1px solid rgba(239,68,68,.25); padding:10px 12px; border-radius:16px; font-weight:1000; }
    .ok{  color:#bbf7d0; background: rgba(34,197,94,.12); border: 1px solid rgba(34,197,94,.22); padding:10px 12px; border-radius:16px; font-weight:1000; }
    .hidden{ display:none !important; }

    /* ---------- AUTH ---------- */
    #scr-auth{
      padding: 18px 14px;
      padding-top: max(18px, env(safe-area-inset-top));
      padding-bottom: max(18px, env(safe-area-inset-bottom));
      overflow:auto;
    }
    .brand{
      font-size:34px;
      font-weight:1100;
      letter-spacing:.2px;
      margin: 8px 6px 2px;
      background: linear-gradient(90deg, #60a5fa, #a78bfa, #22c55e);
      -webkit-background-clip:text;
      color:transparent;
    }
    .subtitle{
      margin: 0 6px 16px;
      color: var(--muted);
      font-weight:1000;
    }
    .authCard{
      border-radius: 22px;
      padding: 16px 14px;
    }
    .seg{
      display:flex;
      gap:8px;
      margin-bottom:12px;
    }
    .seg button{
      flex:1;
      border:none;
      border-radius: 16px;
      padding: 10px 12px;
      font-weight:1100;
      cursor:pointer;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color: var(--muted);
    }
    .seg button.active{
      background: rgba(43,134,255,.22);
      border:1px solid rgba(43,134,255,.35);
      color: var(--text);
    }

    .avatarPick{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    .avatar{
      width:54px; height:54px;
      border-radius:50%;
      object-fit:cover;
      background: rgba(255,255,255,.08);
      border:1px solid var(--line);
      flex:0 0 auto;
    }
    .avatar.big{ width:78px; height:78px; }
    .avatar.med{ width:72px; height:72px; }

    /* ---------- TABBAR ---------- */
    .nav{
      position:fixed;
      left:0; right:0; bottom:0;
      height: var(--tabbar-h);
      padding-bottom: max(10px, env(safe-area-inset-bottom));
      background: var(--panel2);
      border-top: 1px solid var(--line);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      z-index: 1000;
    }
    .navWrap{
      height: calc(var(--tabbar-h) - max(10px, env(safe-area-inset-bottom)));
      display:flex;
      padding: 10px 10px 0;
      justify-content:space-around;
      align-items:flex-start;
    }
    .navItem{
      width:50%;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      cursor:pointer;
      color: var(--muted2);
      font-weight:1100;
      font-size:12px;
      user-select:none;
    }
    .navItem.active{ color: var(--blue); }
    .navIcon{ width:26px; height:26px; display:grid; place-items:center; }

    /* ---------- CHATS LIST ---------- */
    #scr-chats{ overflow:hidden; }
    .searchpill{
      margin: 0 16px 10px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      padding: 12px 12px;
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
      font-weight:1000;
      color: var(--muted);
    }
    .banner{
      margin: 12px 16px;
      border-radius: 18px;
      padding: 16px 14px;
      background: linear-gradient(135deg, #7c3aed 0%, #2563eb 55%, #0ea5e9 100%);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .banner::after{
      content:"";
      position:absolute; right:-60px; top:-60px;
      width:220px; height:220px;
      border-radius:50%;
      background: rgba(255,255,255,.18);
    }
    .bannerTitle{ margin:0; font-weight:1100; font-size:18px; }
    .bannerText{ margin:6px 0 0; font-weight:1000; opacity:.9; }

    .list{
      padding: 0 10px calc(var(--tabbar-h) + 16px + env(safe-area-inset-bottom));
      height: calc(100% - 176px);
      overflow:auto;
    }
    .row{
      display:flex;
      gap:12px;
      align-items:center;
      padding: 12px 8px;
      border-radius: 18px;
      cursor:pointer;
    }
    .row:active{ background: rgba(255,255,255,.05); }
    .meta{ flex:1; min-width:0; }
    .nameLine{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .name{
      font-size:16px;
      font-weight:1100;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .time{ color:var(--muted2); font-weight:1100; font-size:12px; }
    .preview{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:4px; }
    .snippet{
      color:var(--muted);
      font-weight:1000;
      font-size:14px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      min-width:0; flex:1;
    }

    /* ---------- SEARCH SCREEN ---------- */
    #scr-search{ overflow:hidden; }
    .searchTop{
      padding: 14px 16px 10px;
      padding-top:max(14px, env(safe-area-inset-top));
      display:flex; gap:10px; align-items:center;
    }
    .searchField{
      flex:1;
      display:flex; align-items:center; gap:10px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px;
      font-weight:1100;
    }
    .searchField input{
      flex:1;
      border:none; outline:none;
      background:transparent;
      color: var(--text);
      font-size:16px;
      font-weight:1100;
      min-width:0;
    }
    .cancel{
      font-weight:1100;
      color:var(--text);
      opacity:.9;
      cursor:pointer;
      user-select:none;
    }
    .sectionTitle{
      padding: 10px 16px 6px;
      color: var(--muted2);
      font-weight:1100;
      text-transform:uppercase;
      letter-spacing:.5px;
      font-size:12px;
    }
    .searchList{
      padding: 0 10px calc(var(--tabbar-h) + 16px + env(safe-area-inset-bottom));
      height: calc(100% - 58px);
      overflow:auto;
    }
    .statusDot{
      width:10px; height:10px; border-radius:50%;
      background: rgba(255,255,255,.25);
      border:1px solid rgba(255,255,255,.18);
      flex:0 0 auto;
    }
    .statusDot.on{
      background: var(--ok);
      border-color: rgba(34,197,94,.35);
    }
    .sub{ color: var(--muted2); font-weight:1000; font-size:12px; margin-top:2px; }

    /* ---------- CHAT SCREEN ---------- */
    #scr-chat{ overflow:hidden; }
    .chatWrap{
      height:100%;
      display:flex;
      flex-direction:column;
      background:
        radial-gradient(900px 620px at 10% 10%, rgba(43,134,255,.18), transparent 60%),
        radial-gradient(900px 650px at 90% 30%, rgba(168,85,247,.14), transparent 58%),
        radial-gradient(900px 650px at 50% 110%, rgba(34,197,94,.08), transparent 55%),
        #070a10;
    }
    .chatTop{
      padding: 12px 12px 10px;
      padding-top:max(12px, env(safe-area-inset-top));
      display:flex;
      align-items:center;
      gap:10px;
      background: rgba(10,14,22,.82);
      border-bottom: 1px solid var(--line);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .backBtn{
      width:40px; height:40px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      display:grid; place-items:center;
      cursor:pointer;
      font-weight:1100;
      color:var(--text);
    }
    .chatHead{ flex:1; min-width:0; display:flex; gap:10px; align-items:center; }
    .chatMeta{ min-width:0; }
    .chatName{
      font-weight:1100;
      font-size:16px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .chatStatus{
      color: var(--muted2);
      font-weight:1100;
      font-size:12px;
      margin-top:2px;
    }

    .msgs{
      flex:1;
      overflow:auto;
      padding: 14px 12px calc(var(--tabbar-h) + var(--composer-h) + 16px + env(safe-area-inset-bottom));
    }

    .bubble{
      max-width: 78%;
      padding: 10px 12px;
      margin: 6px 0;
      border-radius: 18px;
      background: rgba(255,255,255,.07);
      border:1px solid var(--line);
      box-shadow: 0 14px 26px rgba(0,0,0,.22);
      font-weight:1000;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .bubble.me{
      margin-left:auto;
      border:none;
      background: linear-gradient(135deg, rgba(43,134,255,.98), rgba(168,85,247,.92));
    }
    .bubble .t{
      display:block;
      margin-top:6px;
      font-size:11px;
      color: rgba(255,255,255,.75);
      font-weight:1100;
      text-align:right;
    }

    /* ‚úÖ –ì–ª–∞–≤–Ω–æ–µ: –∫–æ–º–ø–æ–∑–µ—Ä –≤—Å–µ–≥–¥–∞ –ù–ê–î —Ç–∞–±–±–∞—Ä–æ–º */
    .composer{
      position: fixed;
      left: 0;
      right: 0;
      bottom: calc(var(--tabbar-h) + env(safe-area-inset-bottom));
      padding: 10px;
      background: rgba(10,14,22,.95);
      border-top: 1px solid var(--line);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      display:flex;
      gap:8px;
      align-items:center;
      z-index: 999;
    }
    .toolBtn{
      width:40px; height:40px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      display:grid; place-items:center;
      cursor:pointer;
      flex:0 0 auto;
      user-select:none;
    }
    .composerInput{
      flex:1;
      display:flex; align-items:center; gap:10px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius: 18px;
      padding: 10px 12px;
      min-width:0;
    }
    .composerInput input{
      flex:1;
      border:none; outline:none;
      background:transparent;
      color: var(--text);
      font-size:16px;
      font-weight:1100;
      min-width:0;
    }
    .sendBtn{
      width:46px; height:46px;
      border-radius: 18px;
      border:none;
      background: linear-gradient(180deg, var(--blue), var(--blue2));
      color:white;
      font-weight:1100;
      cursor:pointer;
      flex:0 0 auto;
      user-select:none;
    }

    /* ---------- PROFILE ---------- */
    #scr-profile{ overflow:auto; padding-bottom: calc(var(--tabbar-h) + env(safe-area-inset-bottom)); }
    .profilePad{
      padding: 14px 14px;
      padding-top:max(14px, env(safe-area-inset-top));
    }
    .profileCard{
      border-radius: 22px;
      padding: 16px 14px;
    }
    .profileHead{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .pName{ margin:0; font-size:22px; font-weight:1100; }
    .pSub{ margin-top:4px; color:var(--muted); font-weight:1100; font-size:13px; }

  </style>
</head>

<body>
<div class="app">

  <!-- AUTH -->
  <section id="scr-auth" class="screen active">
    <div class="brand">LOL</div>
    <div class="subtitle">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>

    <div class="authCard glass">
      <div class="seg">
        <button id="segLogin" class="active" type="button">–í—Ö–æ–¥</button>
        <button id="segReg" type="button">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>

      <div id="authMsg" class="hidden"></div>

      <div class="field">
        <label>–õ–æ–≥–∏–Ω</label>
        <input id="loginLogin" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: l0l_user" autocomplete="username" />
      </div>

      <div class="field">
        <label>–ü–∞—Ä–æ–ª—å</label>
        <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
      </div>

      <div id="regExtra" class="hidden">
        <div class="avatarPick">
          <img id="regAvatarPreview" class="avatar med" alt="">
          <div style="flex:1">
            <div class="hint" style="font-weight:1100;margin-bottom:6px;">–ê–≤–∞—Ç–∞—Ä</div>
            <input id="regAvatarFile" type="file" accept="image/*"
              style="width:100%;padding:10px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid var(--line);color:var(--muted);" />
          </div>
        </div>

        <div class="field">
          <label>–ù–∏–∫–Ω–µ–π–º</label>
          <input id="regNick" placeholder="–∫–∞–∫ —Ç–µ–±—è –±—É–¥—É—Ç –≤–∏–¥–µ—Ç—å" autocomplete="nickname" />
        </div>

        <div class="field">
          <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
          <input id="regPhone" placeholder="+7 900 000-00-00" inputmode="tel" autocomplete="tel" />
        </div>
      </div>

      <button id="authBtn" class="btn" type="button">–í–æ–π—Ç–∏</button>

      <div class="hint" style="margin-top:10px;">
        * –≠—Ç–æ –≤—Ö–æ–¥ –ø–æ –ª–æ–≥–∏–Ω—É/–ø–∞—Ä–æ–ª—é –±–µ–∑ Firebase Auth (–ø–∞—Ä–æ–ª—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ SHA-256 —Ö—ç—à).
      </div>
    </div>
  </section>

  <!-- CHATS -->
  <section id="scr-chats" class="screen">
    <div class="topbar">
      <h1>–ß–∞—Ç—ã</h1>
      <button id="btnLogout" class="iconbtn" type="button" title="–í—ã–π—Ç–∏">‚éã</button>
    </div>

    <div id="openSearch" class="searchpill">üîé –ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫–Ω–µ–π–º—É</div>

    <div class="banner">
      <p class="bannerTitle">LOL Messenger</p>
      <p class="bannerText">—á–∞—Ç—ã, —Å—Ç–∞—Ç—É—Å—ã –∏ typing üòé</p>
    </div>

    <div id="chatList" class="list"></div>
  </section>

  <!-- SEARCH -->
  <section id="scr-search" class="screen">
    <div class="searchTop">
      <div class="searchField">
        üîé
        <input id="searchInput" placeholder="–ù–∏–∫–Ω–µ–π–º..." />
        <button id="clearSearch" class="iconbtn" type="button" style="width:34px;height:34px;border-radius:14px;">‚úï</button>
      </div>
      <div id="cancelSearch" class="cancel">–û—Ç–º–µ–Ω–∞</div>
    </div>

    <div class="searchList">
      <div class="sectionTitle">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
      <div id="searchResults"></div>
      <div id="searchEmpty" class="hint" style="padding:10px 16px; font-weight:1100;"></div>
    </div>
  </section>

  <!-- CHAT -->
  <section id="scr-chat" class="screen">
    <div class="chatWrap">
      <div class="chatTop">
        <div id="backToChats" class="backBtn">‚Äπ</div>

        <div class="chatHead">
          <img id="peerAvatar" class="avatar" alt="">
          <div class="chatMeta">
            <div id="peerNick" class="chatName">–ß–∞—Ç</div>
            <div id="peerStatus" class="chatStatus">‚Ä¶</div>
          </div>
        </div>

        <button id="exitChat" class="iconbtn" type="button" title="–í—ã–π—Ç–∏ –∏–∑ —á–∞—Ç–∞">‚§¨</button>
      </div>

      <div id="msgList" class="msgs"></div>
    </div>

    <!-- composer –≤—ã–Ω–µ—Å–µ–Ω –∏–∑ chatWrap –∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω: –ù–ê–î —Ç–∞–±–±–∞—Ä–æ–º -->
    <div class="composer" id="composer">
      <div class="toolBtn" title="–§–æ—Ç–æ/–≤–∏–¥–µ–æ">üìé</div>
      <div class="composerInput">
        <input id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" />
        <span title="–°–º–∞–π–ª–∏–∫–∏" style="opacity:.85; user-select:none;">üòä</span>
        <span title="–§–æ—Ç–æ/–≤–∏–¥–µ–æ" style="opacity:.85; user-select:none;">üì∑</span>
      </div>
      <button id="sendBtn" class="sendBtn" type="button" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
    </div>
  </section>

  <!-- PROFILE -->
  <section id="scr-profile" class="screen">
    <div class="profilePad">
      <div class="topbar" style="padding:0 2px 10px; padding-top:0;">
        <h1>–ü—Ä–æ—Ñ–∏–ª—å</h1>
        <button id="btnLogout2" class="iconbtn" type="button" title="–í—ã–π—Ç–∏">‚éã</button>
      </div>

      <div class="profileCard glass">
        <div class="profileHead">
          <img id="meAvatar" class="avatar big" alt="">
          <div style="flex:1; min-width:0;">
            <h2 id="meNick" class="pName">‚Ä¶</h2>
            <div id="mePhone" class="pSub">‚Ä¶</div>
            <div id="meLogin" class="pSub" style="opacity:.85;"></div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="avatarPick" style="margin:0 0 10px;">
          <img id="editAvatarPreview" class="avatar med" alt="">
          <div style="flex:1">
            <div class="hint" style="font-weight:1100;margin-bottom:6px;">–°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</div>
            <input id="editAvatarFile" type="file" accept="image/*"
              style="width:100%;padding:10px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid var(--line);color:var(--muted);" />
          </div>
        </div>

        <div class="field">
          <label>–ù–∏–∫–Ω–µ–π–º</label>
          <input id="editNick" />
        </div>

        <div class="field">
          <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
          <input id="editPhone" />
        </div>

        <button id="saveProfileBtn" class="btn" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <div style="height:10px"></div>
        <button id="resetDeviceBtn" class="btn ghost" type="button">–°–±—Ä–æ—Å–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>

        <div id="profileMsg" class="hidden" style="margin-top:10px;"></div>
      </div>
    </div>
  </section>

  <!-- TABBAR -->
  <nav id="bottomNav" class="nav hidden">
    <div class="navWrap">
      <div class="navItem active" data-tab="chats">
        <div class="navIcon">üí¨</div>
        <div>–ß–∞—Ç—ã</div>
      </div>
      <div class="navItem" data-tab="profile">
        <div class="navIcon">üë§</div>
        <div>–ü—Ä–æ—Ñ–∏–ª—å</div>
      </div>
    </div>
  </nav>

</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
/* =========================
   Firebase init
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyCl9xOzUawqggpwyZQupGYm67RiWT42b7A",
  authDomain: "lol-messenger-76286.firebaseapp.com",
  projectId: "lol-messenger-76286",
  storageBucket: "lol-messenger-76286.firebasestorage.app",
  messagingSenderId: "573143866457",
  appId: "1:573143866457:web:fb7ed67ea66848e6da2548"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* =========================
   Helpers
========================= */
const $ = (id) => document.getElementById(id);
const now = () => Date.now();
const pad2 = (n)=> String(n).padStart(2,"0");
const fmtTime = (ms)=> { const d=new Date(ms); return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; };

function escapeHtml(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function showScreen(id){
  ["scr-auth","scr-chats","scr-search","scr-chat","scr-profile"].forEach(x => $(x).classList.remove("active"));
  $(id).classList.add("active");

  // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–ø–æ–∑–µ—Ä —Ç–æ–ª—å–∫–æ –≤ —á–∞—Ç–µ
  $("composer").style.display = (id === "scr-chat") ? "flex" : "none";
}

function setMsg(el, text, kind){
  el.className = (kind === "ok") ? "ok" : "err";
  el.textContent = text;
  el.classList.remove("hidden");
}
function clearMsg(el){
  el.textContent = "";
  el.classList.add("hidden");
}

function randId(prefix="u"){
  return prefix + "_" + Math.random().toString(36).slice(2) + "_" + Math.random().toString(36).slice(2);
}

async function sha256Hex(text){
  const enc = new TextEncoder();
  const data = enc.encode(text);
  const hash = await crypto.subtle.digest("SHA-256", data);
  const bytes = Array.from(new Uint8Array(hash));
  return bytes.map(b => b.toString(16).padStart(2,"0")).join("");
}

function chatIdFor(a,b){ return [a,b].sort().join("_"); }

function isOnline(u){
  const ls = u.lastSeen || 0;
  return !!u.online && (now() - ls) < 45000;
}
function onlineText(u){
  return isOnline(u) ? "–æ–Ω–ª–∞–π–Ω" : "–æ—Ñ—Ñ–ª–∞–π–Ω";
}

/* =========================
   Default avatar (inline svg)
========================= */
const defaultAvatar = "data:image/svg+xml;base64," + btoa(`
<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#60a5fa"/>
      <stop offset="1" stop-color="#a78bfa"/>
    </linearGradient>
  </defs>
  <rect width="256" height="256" rx="80" fill="url(#g)"/>
  <circle cx="128" cy="104" r="44" fill="rgba(255,255,255,.85)"/>
  <path d="M48 218c18-44 54-66 80-66s62 22 80 66" fill="rgba(255,255,255,.78)"/>
</svg>
`);

/* =========================
   State
========================= */
let authMode = "login"; // login | reg
let session = null;     // { uid, login }
let me = null;          // { uid, ... }
let usersCache = new Map();

let peer = null;        // {uid,...}
let currentChatId = null;

let unsubChatList = null;
let unsubMsgs = null;
let unsubPeer = null;

let heartbeatTimer = null;
let typingTimer = null;
let typingClearTimer = null;

/* =========================
   Session persistence
========================= */
function loadSession(){
  try{
    const s = JSON.parse(localStorage.getItem("lol_session") || "null");
    return s && s.uid ? s : null;
  }catch{ return null; }
}
function saveSession(s){ localStorage.setItem("lol_session", JSON.stringify(s)); }
function clearSession(){ localStorage.removeItem("lol_session"); }

/* =========================
   Auth UI
========================= */
function setAuthMode(mode){
  authMode = mode;
  $("segLogin").classList.toggle("active", mode==="login");
  $("segReg").classList.toggle("active", mode==="reg");
  $("regExtra").classList.toggle("hidden", mode!=="reg");
  $("authBtn").textContent = mode==="login" ? "–í–æ–π—Ç–∏" : "–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç";
  clearMsg($("authMsg"));
}
$("segLogin").addEventListener("click", ()=> setAuthMode("login"));
$("segReg").addEventListener("click", ()=> setAuthMode("reg"));

$("regAvatarPreview").src = defaultAvatar;

function bindAvatarInput(fileEl, imgEl){
  fileEl.addEventListener("change", (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = (ev)=> { imgEl.src = ev.target.result; };
    r.readAsDataURL(f);
  });
}
bindAvatarInput($("regAvatarFile"), $("regAvatarPreview"));
bindAvatarInput($("editAvatarFile"), $("editAvatarPreview"));

/* =========================
   Data access
========================= */
async function warmUsersCache(){
  const snap = await db.collection("users").get();
  usersCache.clear();
  snap.forEach(d => usersCache.set(d.id, { uid:d.id, ...d.data() }));
  if(session && usersCache.has(session.uid)) me = usersCache.get(session.uid);
}

async function loadMe(){
  const snap = await db.collection("users").doc(session.uid).get();
  if(!snap.exists) throw new Error("–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.");
  me = { uid: snap.id, ...snap.data() };
  usersCache.set(me.uid, me);
}

async function findUserByLogin(login){
  const snap = await db.collection("users").where("login","==",login).limit(1).get();
  if (snap.empty) return null;
  const d = snap.docs[0];
  return { uid: d.id, data: d.data() };
}

/* =========================
   Online / heartbeat
========================= */
async function setOnline(flag){
  if(!session) return;
  try{
    await db.collection("users").doc(session.uid).set({
      online: !!flag,
      lastSeen: now()
    }, { merge:true });
  }catch{}
}

function startHeartbeat(){
  stopHeartbeat();
  heartbeatTimer = setInterval(()=> setOnline(true), 15000);
}
function stopHeartbeat(){
  if(heartbeatTimer){ clearInterval(heartbeatTimer); heartbeatTimer=null; }
}

window.addEventListener("beforeunload", ()=> setOnline(false));
document.addEventListener("visibilitychange", ()=>{
  if(document.hidden) setOnline(false);
  else setOnline(true);
});

/* =========================
   Tabs
========================= */
function setTab(tab){
  document.querySelectorAll(".navItem").forEach(x=>x.classList.remove("active"));
  document.querySelector(`.navItem[data-tab="${tab}"]`)?.classList.add("active");
  if(tab==="chats") showScreen("scr-chats");
  if(tab==="profile") showScreen("scr-profile");
}
document.querySelectorAll(".navItem").forEach(el=>{
  el.addEventListener("click", ()=> setTab(el.getAttribute("data-tab")));
});

/* =========================
   Auth action
========================= */
$("authBtn").addEventListener("click", async ()=>{
  clearMsg($("authMsg"));
  const login = $("loginLogin").value.trim();
  const pass  = $("loginPass").value;

  if(!login || !pass){
    return setMsg($("authMsg"), "–ó–∞–ø–æ–ª–Ω–∏ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å.", "err");
  }

  try{
    if(authMode === "reg"){
      const nick = $("regNick").value.trim();
      const phone = $("regPhone").value.trim();
      const avatar = $("regAvatarPreview").src || defaultAvatar;

      if(!nick){
        return setMsg($("authMsg"), "–ù—É–∂–µ–Ω –Ω–∏–∫–Ω–µ–π–º.", "err");
      }

      const exists = await findUserByLogin(login);
      if(exists){
        return setMsg($("authMsg"), "–¢–∞–∫–æ–π –ª–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç.", "err");
      }

      const uid  = randId("u");
      const salt = randId("s");
      const passwordHash = await sha256Hex(`${login}:${pass}:${salt}`);

      await db.collection("users").doc(uid).set({
        login,
        salt,
        passwordHash,
        nick,
        phone,
        avatar,
        online: true,
        lastSeen: now(),
        typingTo: "",
        typingAt: 0
      });

      session = { uid, login };
      saveSession(session);
      await afterLogin();
      return;
    }

    // login
    const found = await findUserByLogin(login);
    if(!found){
      return setMsg($("authMsg"), "–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.", "err");
    }
    const { uid, data } = found;
    const calc = await sha256Hex(`${login}:${pass}:${data.salt}`);
    if(calc !== data.passwordHash){
      return setMsg($("authMsg"), "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.", "err");
    }

    session = { uid, login };
    saveSession(session);
    await afterLogin();
  }catch(e){
    setMsg($("authMsg"), "–û—à–∏–±–∫–∞: " + (e?.message || String(e)), "err");
  }
});

/* =========================
   After login / logout
========================= */
async function afterLogin(){
  $("bottomNav").classList.remove("hidden");
  await setOnline(true);
  startHeartbeat();

  await warmUsersCache();
  await loadMe();
  renderProfile();

  bindChatListRealtime();

  showScreen("scr-chats");
  setTab("chats");
}

async function logout(){
  try{ await clearMyTyping(); }catch{}
  try{ await setOnline(false); }catch{}
  stopHeartbeat();

  if(unsubChatList){ unsubChatList(); unsubChatList=null; }
  if(unsubMsgs){ unsubMsgs(); unsubMsgs=null; }
  if(unsubPeer){ unsubPeer(); unsubPeer=null; }

  session=null; me=null; peer=null; currentChatId=null;
  usersCache.clear();

  clearSession();
  $("bottomNav").classList.add("hidden");
  showScreen("scr-auth");
}
$("btnLogout").addEventListener("click", logout);
$("btnLogout2").addEventListener("click", logout);

$("resetDeviceBtn").addEventListener("click", ()=>{
  localStorage.removeItem("lol_session");
  location.reload();
});

/* =========================
   Profile
========================= */
function renderProfile(){
  if(!me) return;
  $("meAvatar").src = me.avatar || defaultAvatar;
  $("meNick").textContent = me.nick || "–ö—Ç–æ-—Ç–æ";
  $("mePhone").textContent = me.phone || "";
  $("meLogin").textContent = "–õ–æ–≥–∏–Ω: " + (me.login || "");

  $("editAvatarPreview").src = me.avatar || defaultAvatar;
  $("editNick").value = me.nick || "";
  $("editPhone").value = me.phone || "";
}

$("saveProfileBtn").addEventListener("click", async ()=>{
  clearMsg($("profileMsg"));
  const nick = $("editNick").value.trim() || "–ö—Ç–æ-—Ç–æ";
  const phone = $("editPhone").value.trim() || "";
  const avatar = $("editAvatarPreview").src || defaultAvatar;

  try{
    await db.collection("users").doc(me.uid).set({ nick, phone, avatar }, { merge:true });
    me.nick = nick; me.phone = phone; me.avatar = avatar;
    usersCache.set(me.uid, me);
    renderProfile();
    setMsg($("profileMsg"), "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ", "ok");
  }catch(e){
    setMsg($("profileMsg"), "–û—à–∏–±–∫–∞: " + (e?.message || String(e)), "err");
  }
});

/* =========================
   Chats list realtime
   (—á–∞—Ç –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: lastTime > 0)
========================= */
function bindChatListRealtime(){
  if(!me) return;
  if(unsubChatList){ unsubChatList(); unsubChatList=null; }

  unsubChatList = db.collection("chats")
    .where("participants", "array-contains", me.uid)
    .onSnapshot(async (snap)=>{
      await warmUsersCache();

      let items=[];
      snap.forEach(d=>{
        const c=d.data();
        if((c.lastTime||0) > 0){
          items.push({ id:d.id, ...c });
        }
      });
      items.sort((a,b)=>(b.lastTime||0)-(a.lastTime||0));

      const box = $("chatList");
      box.innerHTML = "";

      if(items.length===0){
        const div=document.createElement("div");
        div.style.padding="10px 16px";
        div.style.color="rgba(234,241,255,.55)";
        div.style.fontWeight="1100";
        div.textContent="–ü–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤. –ù–∞–∂–º–∏ –ø–æ–∏—Å–∫ –∏ –Ω–∞–ø–∏—à–∏ –∫–æ–º—É-–Ω–∏–±—É–¥—å.";
        box.appendChild(div);
        return;
      }

      for(const c of items){
        const peerId = (c.participants||[]).find(x=>x!==me.uid);
        const u = usersCache.get(peerId) || { nick:"–ö—Ç–æ-—Ç–æ", avatar: defaultAvatar, online:false, lastSeen:0 };

        const row=document.createElement("div");
        row.className="row";
        row.innerHTML=`
          <img class="avatar" src="${escapeHtml(u.avatar || defaultAvatar)}" alt="">
          <div class="meta">
            <div class="nameLine">
              <div class="name">${escapeHtml(u.nick || "–ö—Ç–æ-—Ç–æ")}</div>
              <div class="time">${c.lastTime ? fmtTime(c.lastTime) : ""}</div>
            </div>
            <div class="preview">
              <div class="snippet">${escapeHtml(c.lastText || "")}</div>
            </div>
          </div>
        `;
        row.addEventListener("click", ()=> openChat(peerId));
        box.appendChild(row);
      }
    }, (err)=>{
      $("chatList").innerHTML = `<div class="err" style="margin:10px;">–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —á–∞—Ç–æ–≤: ${escapeHtml(err?.message || String(err))}</div>`;
    });
}

/* =========================
   Search screen
========================= */
$("openSearch").addEventListener("click", async ()=>{
  await warmUsersCache();
  $("searchInput").value = "";
  $("searchResults").innerHTML = "";
  $("searchEmpty").textContent = "–ù–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º‚Ä¶";
  showScreen("scr-search");
  $("searchInput").focus();
});

$("cancelSearch").addEventListener("click", ()=> showScreen("scr-chats"));

$("clearSearch").addEventListener("click", ()=>{
  $("searchInput").value = "";
  $("searchResults").innerHTML = "";
  $("searchEmpty").textContent = "–ù–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º‚Ä¶";
  $("searchInput").focus();
});

$("searchInput").addEventListener("input", ()=>{
  const q = $("searchInput").value.trim().toLowerCase();
  const box = $("searchResults");
  box.innerHTML = "";

  if(!q){
    $("searchEmpty").textContent = "–ù–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º‚Ä¶";
    return;
  }

  let found=[];
  for(const [uid,u] of usersCache.entries()){
    if(!me) continue;
    if(uid === me.uid) continue;
    if((u.login||"") === (me.login||"")) continue;

    const nick = (u.nick||"").toLowerCase();
    if(nick.includes(q)) found.push(u);
  }

  found.sort((a,b)=>{
    const ao = isOnline(a) ? 1 : 0;
    const bo = isOnline(b) ? 1 : 0;
    if(ao !== bo) return bo - ao;
    return (a.nick||"").localeCompare(b.nick||"", "ru");
  });

  $("searchEmpty").textContent = found.length ? "" : "–ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ";

  for(const u of found.slice(0, 40)){
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <img class="avatar" src="${escapeHtml(u.avatar || defaultAvatar)}" alt="">
      <div class="meta">
        <div class="nameLine" style="justify-content:flex-start; gap:10px;">
          <div class="name" style="max-width:68%;">${escapeHtml(u.nick || "–ö—Ç–æ-—Ç–æ")}</div>
          <div class="statusDot ${isOnline(u) ? "on" : ""}" title="${isOnline(u) ? "–æ–Ω–ª–∞–π–Ω" : "–æ—Ñ—Ñ–ª–∞–π–Ω"}"></div>
        </div>
        <div class="sub">${isOnline(u) ? "–æ–Ω–ª–∞–π–Ω" : "–æ—Ñ—Ñ–ª–∞–π–Ω"}</div>
      </div>
    `;
    row.addEventListener("click", ()=> openChat(u.uid));
    box.appendChild(row);
  }
});

/* =========================
   Chat: open / close / messages
========================= */
function stopPeerWatch(){
  if(unsubPeer){ unsubPeer(); unsubPeer=null; }
}

function stopMsgWatch(){
  if(unsubMsgs){ unsubMsgs(); unsubMsgs=null; }
}

async function openChat(peerId){
  await warmUsersCache();
  const u = usersCache.get(peerId);
  if(!u){ alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"); return; }

  peer = u;
  currentChatId = chatIdFor(me.uid, peerId);

  $("peerAvatar").src = peer.avatar || defaultAvatar;
  $("peerNick").textContent = peer.nick || "–ö—Ç–æ-—Ç–æ";
  $("peerStatus").textContent = onlineText(peer);

  // watch peer online + typing
  stopPeerWatch();
  unsubPeer = db.collection("users").doc(peerId).onSnapshot((snap)=>{
    if(!snap.exists) return;
    peer = { uid: snap.id, ...snap.data() };
    usersCache.set(peer.uid, peer);

    const typing = (peer.typingTo === me.uid) && ((now() - (peer.typingAt||0)) < 4000);
    $("peerStatus").textContent = typing ? "–ü–µ—á–∞—Ç–∞–µ—Ç‚Ä¶" : onlineText(peer);
  });

  // ensure chat doc exists
  const chatRef = db.collection("chats").doc(currentChatId);
  const chatSnap = await chatRef.get();
  if(!chatSnap.exists){
    await chatRef.set({
      participants:[me.uid, peerId],
      lastText:"",
      lastTime:0
    });
  }

  // watch messages
  stopMsgWatch();
  unsubMsgs = chatRef.collection("messages").orderBy("time").onSnapshot((ss)=>{
    const box = $("msgList");
    box.innerHTML = "";
    ss.forEach(doc=>{
      const m = doc.data();
      const b = document.createElement("div");
      b.className = "bubble" + (m.sender === me.uid ? " me" : "");
      b.textContent = (m.text || "");
      const t = document.createElement("span");
      t.className = "t";
      t.textContent = m.time ? fmtTime(m.time) : "";
      b.appendChild(t);
      box.appendChild(b);
    });
    box.scrollTop = box.scrollHeight;
  });

  $("msgInput").value = "";
  await clearMyTyping();

  showScreen("scr-chat");
  $("msgInput").focus();
}

function closeChat(){
  clearMyTyping();
  showScreen("scr-chats");
}

$("backToChats").addEventListener("click", closeChat);
$("exitChat").addEventListener("click", closeChat);

async function sendMessage(){
  const text = $("msgInput").value.trim();
  if(!text || !currentChatId || !peer) return;

  $("msgInput").value = "";
  const chatRef = db.collection("chats").doc(currentChatId);

  await chatRef.collection("messages").add({
    text,
    sender: me.uid,
    time: now()
  });

  // chat appears in list after first message (lastTime > 0)
  await chatRef.set({
    participants: [me.uid, peer.uid],
    lastText: text,
    lastTime: now()
  }, { merge:true });

  await clearMyTyping();
}

$("sendBtn").addEventListener("click", sendMessage);
$("msgInput").addEventListener("keydown", (e)=>{
  if(e.key === "Enter") sendMessage();
});

/* =========================
   Typing ("–ü–µ—á–∞—Ç–∞–µ—Ç‚Ä¶")
========================= */
async function setMyTyping(){
  if(!peer || !session) return;
  try{
    await db.collection("users").doc(me.uid).set({
      typingTo: peer.uid,
      typingAt: now()
    }, { merge:true });
  }catch{}
}

async function clearMyTyping(){
  if(!session || !me) return;
  try{
    await db.collection("users").doc(me.uid).set({
      typingTo: "",
      typingAt: 0
    }, { merge:true });
  }catch{}
}

$("msgInput").addEventListener("input", ()=>{
  if(!peer) return;

  // throttle sending typing
  if(!typingTimer){
    typingTimer = setTimeout(async ()=>{
      typingTimer = null;
      await setMyTyping();
    }, 150);
  }

  // clear after idle
  if(typingClearTimer) clearTimeout(typingClearTimer);
  typingClearTimer = setTimeout(()=> clearMyTyping(), 1200);
});

/* =========================
   Boot
========================= */
(async ()=>{
  // composer hidden until chat
  $("composer").style.display = "none";

  const s = loadSession();
  if(s && s.uid){
    session = s;
    try{
      await afterLogin();
    }catch(e){
      await logout();
      setAuthMode("login");
      setMsg($("authMsg"), "–°–µ—Å—Å–∏—è —É—Å—Ç–∞—Ä–µ–ª–∞. –í–æ–π–¥–∏ –∑–∞–Ω–æ–≤–æ.", "err");
    }
  }else{
    setAuthMode("login");
  }
})();
</script>
</body>
</html>
