<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LOL Messenger PRO</title>

  <style>
    :root{
      --bg:#070a10;
      --panel:rgba(18,24,38,.72);
      --panel2:rgba(10,14,22,.88);
      --line:rgba(255,255,255,.08);
      --text:#eaf1ff;
      --muted:rgba(234,241,255,.62);
      --muted2:rgba(234,241,255,.40);
      --blue:#2b86ff;
      --blue2:#1f6bff;
      --ok:#22c55e;
      --red:#ef4444;
      --shadow:0 18px 45px rgba(0,0,0,.45);

      --tabbar-h:72px;
      --composer-h:72px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% -10%, rgba(43,134,255,.22), transparent 60%),
        radial-gradient(850px 550px at 85% 0%, rgba(168,85,247,.18), transparent 58%),
        radial-gradient(900px 700px at 60% 110%, rgba(34,197,94,.10), transparent 55%),
        var(--bg);
      overflow:hidden;
    }

    .app{ height:100%; display:flex; flex-direction:column; }
    .screen{ display:none; height:100%; overflow-y:auto; overflow-x:hidden; }
    .screen.active{ display:block; }

    .glass{
      background:var(--panel);
      border:1px solid var(--line);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: var(--shadow);
    }

    .topbar{
      padding:14px 16px 10px;
      padding-top:max(14px, env(safe-area-inset-top));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .topbar h1{
      margin:0;
      font-size:28px;
      font-weight:1000;
      letter-spacing:.2px;
    }

    .iconbtn{
      width:40px; height:40px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      display:grid; place-items:center;
      cursor:pointer;
    }

    .btn{
      width:100%;
      padding:12px 14px;
      border:none;
      border-radius:16px;
      font-weight:1000;
      color:white;
      background: linear-gradient(180deg, var(--blue), var(--blue2));
      cursor:pointer;
    }
    .btn.ghost{
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
    }

    .field{
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px;
      margin-bottom:10px;
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted2);
      font-weight:1000;
      margin-bottom:6px;
      text-transform:uppercase;
      letter-spacing:.4px;
    }
    .field input{
      width:100%;
      border:none; outline:none;
      background:transparent;
      color:var(--text);
      font-size:16px;
      font-weight:1000;
    }

    .hint{ color:var(--muted); font-weight:900; font-size:13px; }
    .err{ color:#fecaca; background: rgba(239,68,68,.14); border: 1px solid rgba(239,68,68,.25); padding:10px 12px; border-radius:16px; font-weight:1000; }
    .ok{  color:#bbf7d0; background: rgba(34,197,94,.12); border: 1px solid rgba(34,197,94,.22); padding:10px 12px; border-radius:16px; font-weight:1000; }
    .hidden{ display:none !important; }

    /* ---------- AUTH ---------- */
    #scr-auth{
      padding: 18px 14px;
      padding-top: max(18px, env(safe-area-inset-top));
      padding-bottom: max(18px, env(safe-area-inset-bottom));
      overflow:auto;
    }
    .brand{
      font-size:34px;
      font-weight:1100;
      letter-spacing:.2px;
      margin: 8px 6px 2px;
      background: linear-gradient(90deg, #60a5fa, #a78bfa, #22c55e);
      -webkit-background-clip:text;
      color:transparent;
    }
    .subtitle{
      margin: 0 6px 16px;
      color: var(--muted);
      font-weight:1000;
    }
    .authCard{
      border-radius: 22px;
      padding: 16px 14px;
    }
    .seg{
      display:flex;
      gap:8px;
      margin-bottom:12px;
    }
    .seg button{
      flex:1;
      border:none;
      border-radius: 16px;
      padding: 10px 12px;
      font-weight:1100;
      cursor:pointer;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color: var(--muted);
    }
    .seg button.active{
      background: rgba(43,134,255,.22);
      border:1px solid rgba(43,134,255,.35);
      color: var(--text);
    }

    .avatarPick{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    .avatar{
      width:54px; height:54px;
      border-radius:50%;
      object-fit:cover;
      background: rgba(255,255,255,.08);
      border:1px solid var(--line);
      flex:0 0 auto;
    }
    .avatar.big{ width:78px; height:78px; }
    .avatar.med{ width:72px; height:72px; }

    /* ---------- TABBAR ---------- */
    .nav{
      position:fixed;
      left:0; right:0; bottom:0;
      height: var(--tabbar-h);
      padding-bottom: max(10px, env(safe-area-inset-bottom));
      background: var(--panel2);
      border-top: 1px solid var(--line);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      z-index: 1000;
    }
    .navWrap{
      height: calc(var(--tabbar-h) - max(10px, env(safe-area-inset-bottom)));
      display:flex;
      padding: 10px 10px 0;
      justify-content:space-around;
      align-items:flex-start;
    }
    .navItem{
      width:50%;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      cursor:pointer;
      color: var(--muted2);
      font-weight:1100;
      font-size:12px;
      user-select:none;
    }
    .navItem.active{ color: var(--blue); }
    .navIcon{ width:26px; height:26px; display:grid; place-items:center; }

    /* ---------- CHATS LIST ---------- */
    #scr-chats{ overflow:hidden; }
    .searchpill{
      margin: 0 16px 10px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      padding: 12px 12px;
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
      font-weight:1000;
      color: var(--muted);
    }
    .banner{
      margin: 12px 16px;
      border-radius: 18px;
      padding: 16px 14px;
      background: linear-gradient(135deg, #7c3aed 0%, #2563eb 55%, #0ea5e9 100%);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .banner::after{
      content:"";
      position:absolute; right:-60px; top:-60px;
      width:220px; height:220px;
      border-radius:50%;
      background: rgba(255,255,255,.18);
    }
    .bannerTitle{ margin:0; font-weight:1100; font-size:18px; }
    .bannerText{ margin:6px 0 0; font-weight:1000; opacity:.9; }

    .list{
      padding: 0 10px calc(var(--tabbar-h) + 16px + env(safe-area-inset-bottom));
      height: calc(100% - 176px);
      overflow:auto;
    }
    .row{
      display:flex;
      gap:12px;
      align-items:center;
      padding: 12px 8px;
      border-radius: 18px;
      cursor:pointer;
    }
    .row:active{ background: rgba(255,255,255,.05); }
    .meta{ flex:1; min-width:0; }
    .nameLine{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .name{
      font-size:16px;
      font-weight:1100;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .time{ color:var(--muted2); font-weight:1100; font-size:12px; }
    .preview{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:4px; }
    .snippet{
      color:var(--muted);
      font-weight:1000;
      font-size:14px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      min-width:0; flex:1;
    }

    /* ---------- SEARCH SCREEN ---------- */
    #scr-search{ overflow:hidden; }
    .searchTop{
      padding: 14px 16px 10px;
      padding-top:max(14px, env(safe-area-inset-top));
      display:flex; gap:10px; align-items:center;
    }
    .searchField{
      flex:1;
      display:flex; align-items:center; gap:10px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px;
      font-weight:1100;
    }
    .searchField input{
      flex:1;
      border:none; outline:none;
      background:transparent;
      color: var(--text);
      font-size:16px;
      font-weight:1100;
      min-width:0;
    }
    .cancel{
      font-weight:1100;
      color:var(--text);
      opacity:.9;
      cursor:pointer;
      user-select:none;
    }
    .sectionTitle{
      padding: 10px 16px 6px;
      color: var(--muted2);
      font-weight:1100;
      text-transform:uppercase;
      letter-spacing:.5px;
      font-size:12px;
    }
    .searchList{
      padding: 0 10px calc(var(--tabbar-h) + 16px + env(safe-area-inset-bottom));
      height: calc(100% - 58px);
      overflow:auto;
    }
    .statusDot{
      width:10px; height:10px; border-radius:50%;
      background: rgba(255,255,255,.25);
      border:1px solid rgba(255,255,255,.18);
      flex:0 0 auto;
    }
    .statusDot.on{
      background: var(--ok);
      border-color: rgba(34,197,94,.35);
    }
    .sub{ color: var(--muted2); font-weight:1000; font-size:12px; margin-top:2px; }

    /* ---------- CHAT SCREEN ---------- */
    #scr-chat{ overflow:hidden; }
    .chatWrap{
      height:100%;
      display:flex;
      flex-direction:column;
      background:
        radial-gradient(900px 620px at 10% 10%, rgba(43,134,255,.18), transparent 60%),
        radial-gradient(900px 650px at 90% 30%, rgba(168,85,247,.14), transparent 58%),
        radial-gradient(900px 650px at 50% 110%, rgba(34,197,94,.08), transparent 55%),
        #070a10;
    }
    .chatTop{
      padding: 12px 12px 10px;
      padding-top:max(12px, env(safe-area-inset-top));
      display:flex;
      align-items:center;
      gap:10px;
      background: rgba(10,14,22,.82);
      border-bottom: 1px solid var(--line);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .backBtn{
      width:40px; height:40px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      display:grid; place-items:center;
      cursor:pointer;
      font-weight:1100;
      color:var(--text);
    }
    .chatHead{ flex:1; min-width:0; display:flex; gap:10px; align-items:center; }
    .chatMeta{ min-width:0; }
    .chatName{
      font-weight:1100;
      font-size:16px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .chatStatus{
      color: var(--muted2);
      font-weight:1100;
      font-size:12px;
      margin-top:2px;
    }

    .msgs{
      flex:1;
      overflow:auto;
      padding: 14px 12px calc(var(--tabbar-h) + var(--composer-h) + 16px + env(safe-area-inset-bottom));
    }

    .bubble{
      max-width: 78%;
      padding: 10px 12px;
      margin: 6px 0;
      border-radius: 18px;
      background: rgba(255,255,255,.07);
      border:1px solid var(--line);
      box-shadow: 0 14px 26px rgba(0,0,0,.22);
      font-weight:1000;
      white-space:pre-wrap;
      word-break:break-word;
      position: relative;
      user-select: none;
      -webkit-user-select: none;
    }
    .bubble.me{
      margin-left:auto;
      border:none;
      background: linear-gradient(135deg, rgba(43,134,255,.98), rgba(168,85,247,.92));
    }
    .bubble .t{
      display:block;
      margin-top:6px;
      font-size:11px;
      color: rgba(255,255,255,.75);
      font-weight:1100;
      text-align:right;
    }
    .bubble.deleted {
      opacity: 0.5;
      font-style: italic;
      background: rgba(255,255,255,.03);
    }

    /* –°—Ç–∞—Ç—É—Å—ã —Å–æ–æ–±—â–µ–Ω–∏–π - –±–µ–ª—ã–µ –≥–∞–ª–æ—á–∫–∏ –≤ –ª–µ–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É */
    .message-status {
      display: inline-block;
      margin-left: 4px;
      font-size: 14px;
      color: rgba(255,255,255,0.9);
      vertical-align: middle;
    }
    
    .bubble .message-footer {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-top: 6px;
      gap: 4px;
    }
    
    .status-delivered {
      color: rgba(255,255,255,0.9);
    }
    
    .status-read {
      color: rgba(255,255,255,0.9);
    }
    
    /* –ö–Ω–æ–ø–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ */
    .block-btn {
      width:40px; height:40px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      display:grid; place-items:center;
      cursor:pointer;
      font-weight:1100;
      color:var(--text);
      margin-left: 8px;
    }
    
    .block-btn.blocked {
      background: rgba(239,68,68,.2);
      border-color: #ef4444;
      color: #ef4444;
    }

    /* ---------- –ù–û–í–´–ï –ö–ù–û–ü–ö–ò –î–õ–Ø –°–û–ó–î–ê–¢–ï–õ–Ø ---------- */
    .chat-actions {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }

    .action-btn {
      width: 40px;
      height: 40px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
    }

    .creator-action-btn {
      border: 2px solid #2b86ff;
      background: rgba(43,134,255,0.15);
      color: #2b86ff;
    }

    /* –ú–æ–¥–∞–ª–∫–∞ */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal.hidden {
      display: none;
    }

    .modal-content {
      background: var(--panel2);
      border: 1px solid var(--line);
      border-radius: 24px;
      padding: 24px;
      width: 90%;
      max-width: 320px;
    }

    .modal-content h3 {
      margin-bottom: 16px;
      text-align: center;
    }

    .modal-content input {
      width: 100%;
      padding: 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      border-radius: 12px;
      color: var(--text);
      margin-bottom: 16px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
    }

    .modal-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 12px;
      font-weight: 1100;
      cursor: pointer;
    }

    .modal-btn.confirm {
      background: var(--blue);
      color: white;
    }

    .modal-btn.cancel {
      background: rgba(255,255,255,.1);
      color: var(--text);
    }

    /* ---------- COMPOSER ---------- */
    .composer{
      position: fixed;
      left: 0;
      right: 0;
      bottom: calc(var(--tabbar-h) + env(safe-area-inset-bottom));
      padding: 10px;
      background: rgba(10,14,22,.95);
      border-top: 1px solid var(--line);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      display:flex;
      gap:8px;
      align-items:center;
      z-index: 999;
    }
    .composerInput{
      flex:1;
      display:flex; align-items:center; gap:10px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius: 18px;
      padding: 10px 12px;
      min-width:0;
    }
    .composerInput input{
      flex:1;
      border:none; outline:none;
      background:transparent;
      color: var(--text);
      font-size:16px;
      font-weight:1100;
      min-width:0;
    }
    .sendBtn{
      width:46px; height:46px;
      border-radius: 18px;
      border:none;
      background: linear-gradient(180deg, var(--blue), var(--blue2));
      color:white;
      font-weight:1100;
      cursor:pointer;
      flex:0 0 auto;
      user-select:none;
    }
    .sendBtn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ---------- PROFILE SCREEN ---------- */
    #scr-profile{ overflow:auto; padding-bottom: calc(var(--tabbar-h) + env(safe-area-inset-bottom)); }
    .profilePad{
      padding: 14px 14px;
      padding-top:max(14px, env(safe-area-inset-top));
    }
    .profileCard{
      border-radius: 22px;
      padding: 16px 14px;
      margin-bottom: 16px;
    }
    .profileHead{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .pName{ margin:0; font-size:22px; font-weight:1100; }
    .pSub{ margin-top:4px; color:var(--muted); font-weight:1100; font-size:13px; }

    /* ---------- ABOUT SCREEN ---------- */
    #scr-about {
      overflow: auto;
      padding: 20px;
      padding-top: max(20px, env(safe-area-inset-top));
      padding-bottom: max(20px, env(safe-area-inset-bottom));
      height: 100%;
    }
    
    .about-header {
      display: flex;
      align-items: center;
      margin-bottom: 24px;
      gap: 16px;
    }
    
    .about-back {
      width: 44px;
      height: 44px;
      border-radius: 22px;
      background: rgba(255,255,255,.08);
      border: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
    }
    
    .about-title {
      font-size: 32px;
      font-weight: 1000;
      margin: 0;
      background: linear-gradient(135deg, #60a5fa, #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .feature-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin: 24px 0;
    }
    
    .feature-card {
      background: rgba(255,255,255,.05);
      border: 1px solid var(--line);
      border-radius: 24px;
      padding: 20px 16px;
      backdrop-filter: blur(10px);
    }
    
    .feature-icon {
      font-size: 36px;
      margin-bottom: 12px;
    }
    
    .feature-name {
      font-weight: 1100;
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--blue);
    }
    
    .feature-desc {
      font-size: 14px;
      color: var(--muted);
      line-height: 1.5;
      font-weight: 1000;
    }
    
    .tech-badge {
      background: rgba(43,134,255,.15);
      border: 1px solid rgba(43,134,255,.3);
      border-radius: 100px;
      padding: 6px 16px;
      display: inline-block;
      font-size: 14px;
      font-weight: 1100;
      margin: 4px;
    }
    
    .about-footer {
      margin-top: 32px;
      text-align: center;
      color: var(--muted2);
      font-size: 14px;
      font-weight: 1000;
      padding: 20px 0;
      border-top: 1px solid var(--line);
    }

  </style>
</head>

<body>
<div class="app">

  <!-- AUTH -->
  <section id="scr-auth" class="screen active">
    <div class="brand">LOL</div>
    <div class="subtitle">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>

    <div class="authCard glass">
      <div class="seg">
        <button id="segLogin" class="active" type="button">–í—Ö–æ–¥</button>
        <button id="segReg" type="button">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>

      <div id="authMsg" class="hidden"></div>

      <div class="field">
        <label>–õ–æ–≥–∏–Ω</label>
        <input id="loginLogin" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: l0l_user" autocomplete="username" />
      </div>

      <div class="field">
        <label>–ü–∞—Ä–æ–ª—å</label>
        <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
      </div>

      <div id="regExtra" class="hidden">
        <div class="avatarPick">
          <img id="regAvatarPreview" class="avatar med" alt="">
          <div style="flex:1">
            <div class="hint" style="font-weight:1100;margin-bottom:6px;">–ê–≤–∞—Ç–∞—Ä</div>
            <input id="regAvatarFile" type="file" accept="image/*"
              style="width:100%;padding:10px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid var(--line);color:var(--muted);" />
          </div>
        </div>

        <div class="field">
          <label>–ù–∏–∫–Ω–µ–π–º</label>
          <input id="regNick" placeholder="–∫–∞–∫ —Ç–µ–±—è –±—É–¥—É—Ç –≤–∏–¥–µ—Ç—å" autocomplete="nickname" />
        </div>

        <div class="field">
          <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
          <input id="regPhone" placeholder="+7 900 000-00-00" inputmode="tel" autocomplete="tel" />
        </div>
      </div>

      <button id="authBtn" class="btn" type="button">–í–æ–π—Ç–∏</button>

      <div class="hint" style="margin-top:10px;">
        * –≠—Ç–æ –≤—Ö–æ–¥ –ø–æ –ª–æ–≥–∏–Ω—É/–ø–∞—Ä–æ–ª—é –±–µ–∑ Firebase Auth (–ø–∞—Ä–æ–ª—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ SHA-256 —Ö—ç—à).
      </div>
    </div>
  </section>

  <!-- CHATS -->
  <section id="scr-chats" class="screen">
    <div class="topbar">
      <h1>–ß–∞—Ç—ã</h1>
      <button id="btnLogout" class="iconbtn" type="button" title="–í—ã–π—Ç–∏">‚éã</button>
    </div>

    <div id="openSearch" class="searchpill">üîé –ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫–Ω–µ–π–º—É</div>

    <div class="banner">
      <p class="bannerTitle">LOL Messenger</p>
      <p class="bannerText">–°—Ç–∞—Ç—É—Å—ã: –æ–¥–Ω–∞ ‚úî - –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ, –¥–≤–µ ‚úî‚úî - –ø—Ä–æ—á–∏—Ç–∞–Ω–æ</p>
    </div>

    <div id="chatList" class="list"></div>
  </section>

  <!-- SEARCH -->
  <section id="scr-search" class="screen">
    <div class="searchTop">
      <div class="searchField">
        üîé
        <input id="searchInput" placeholder="–ù–∏–∫–Ω–µ–π–º..." />
        <button id="clearSearch" class="iconbtn" type="button" style="width:34px;height:34px;border-radius:14px;">‚úï</button>
      </div>
      <div id="cancelSearch" class="cancel">–û—Ç–º–µ–Ω–∞</div>
    </div>

    <div class="searchList">
      <div class="sectionTitle">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
      <div id="searchResults"></div>
      <div id="searchEmpty" class="hint" style="padding:10px 16px; font-weight:1100;"></div>
    </div>
  </section>

  <!-- CHAT -->
  <section id="scr-chat" class="screen">
    <div class="chatWrap">
      <div class="chatTop">
        <div id="backToChats" class="backBtn">‚Äπ</div>

        <div class="chatHead">
          <img id="peerAvatar" class="avatar" alt="">
          <div class="chatMeta">
            <div id="peerNick" class="chatName">–ß–∞—Ç</div>
            <div id="peerStatus" class="chatStatus">‚Ä¶</div>
          </div>
        </div>

        <!-- –ù–û–í–û–ï: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ -->
        <div class="chat-actions" id="chatActions"></div>
        
        <button id="exitChat" class="iconbtn" type="button" title="–í—ã–π—Ç–∏ –∏–∑ —á–∞—Ç–∞">‚§¨</button>
      </div>

      <div id="msgList" class="msgs"></div>
    </div>

    <!-- composer -->
    <div class="composer" id="composer">
      <div class="composerInput">
        <input id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" />
      </div>
      <button id="sendBtn" class="sendBtn" type="button" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
    </div>
  </section>

  <!-- PROFILE -->
  <section id="scr-profile" class="screen">
    <div class="profilePad">
      <div class="topbar" style="padding:0 2px 10px; padding-top:0;">
        <h1>–ü—Ä–æ—Ñ–∏–ª—å</h1>
        <button id="btnLogout2" class="iconbtn" type="button" title="–í—ã–π—Ç–∏">‚éã</button>
      </div>

      <div class="profileCard glass">
        <div class="profileHead">
          <img id="meAvatar" class="avatar big" alt="">
          <div style="flex:1; min-width:0;">
            <h2 id="meNick" class="pName">‚Ä¶</h2>
            <div id="mePhone" class="pSub">‚Ä¶</div>
            <div id="meLogin" class="pSub" style="opacity:.85;"></div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="avatarPick" style="margin:0 0 10px;">
          <img id="editAvatarPreview" class="avatar med" alt="">
          <div style="flex:1">
            <div class="hint" style="font-weight:1100;margin-bottom:6px;">–°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</div>
            <input id="editAvatarFile" type="file" accept="image/*"
              style="width:100%;padding:10px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid var(--line);color:var(--muted);" />
          </div>
        </div>

        <div class="field">
          <label>–ù–∏–∫–Ω–µ–π–º</label>
          <input id="editNick" />
        </div>

        <div class="field">
          <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
          <input id="editPhone" />
        </div>

        <button id="saveProfileBtn" class="btn" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <div style="height:10px"></div>
        
        <!-- –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ "–ß—Ç–æ –∑–∞ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä?" -->
        <button id="aboutBtn" class="btn ghost" type="button">‚ùì –ß—Ç–æ –∑–∞ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä?</button>
        <div style="height:10px"></div>
        
        <!-- –ù–û–í–û–ï: –ö–Ω–æ–ø–∫–∞ —Å—Ç–∞—Ç—å/—É–±—Ä–∞—Ç—å —Å–æ–∑–¥–∞—Ç–µ–ª—è -->
        <button id="creatorBtn" class="btn ghost hidden" type="button">üî® –°—Ç–∞—Ç—å —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º</button>
        <div style="height:10px"></div>
        
        <button id="resetDeviceBtn" class="btn ghost" type="button">–°–±—Ä–æ—Å–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>

        <div id="profileMsg" class="hidden" style="margin-top:10px;"></div>
      </div>
    </div>
  </section>

  <!-- ABOUT SCREEN (–Ω–æ–≤—ã–π —ç–∫—Ä–∞–Ω) -->
  <section id="scr-about" class="screen">
    <div class="about-header">
      <div class="about-back" id="aboutBackBtn">‚Üê</div>
      <h2 class="about-title">LOL Messenger</h2>
    </div>

    <div class="feature-grid">
      <div class="feature-card">
        <div class="feature-icon">üí¨</div>
        <div class="feature-name">–¢–µ–∫—Å—Ç–æ–≤—ã–µ —á–∞—Ç—ã</div>
        <div class="feature-desc">–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ–±–º–µ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ —Å –¥—Ä—É–∑—å—è–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</div>
      </div>

      <div class="feature-card">
        <div class="feature-icon">üîé</div>
        <div class="feature-name">–ü–æ–∏—Å–∫ –ª—é–¥–µ–π</div>
        <div class="feature-desc">–ù–∞—Ö–æ–¥–∏ –¥—Ä—É–∑–µ–π –ø–æ –Ω–∏–∫–Ω–µ–π–º—É –∏ –Ω–∞—á–∏–Ω–∞–π –æ–±—â–µ–Ω–∏–µ</div>
      </div>

      <div class="feature-card">
        <div class="feature-icon">üü¢</div>
        <div class="feature-name">–°—Ç–∞—Ç—É—Å "–æ–Ω–ª–∞–π–Ω"</div>
        <div class="feature-desc">–í–∏–¥–∏—à—å, –∫—Ç–æ —Å–µ–π—á–∞—Å –≤ —Å–µ—Ç–∏ –∏ –≥–æ—Ç–æ–≤ –æ–±—â–∞—Ç—å—Å—è</div>
      </div>

      <div class="feature-card">
        <div class="feature-icon">‚úèÔ∏è</div>
        <div class="feature-name">"–ü–µ—á–∞—Ç–∞–µ—Ç‚Ä¶"</div>
        <div class="feature-desc">–ó–Ω–∞–µ—à—å, –∫–æ–≥–¥–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–±–∏—Ä–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
      </div>

      <div class="feature-card">
        <div class="feature-icon">‚úî</div>
        <div class="feature-name">–°—Ç–∞—Ç—É—Å—ã –¥–æ—Å—Ç–∞–≤–∫–∏</div>
        <div class="feature-desc">–û–¥–Ω–∞ –≥–∞–ª–æ—á–∫–∞ - –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ, –¥–≤–µ –≥–∞–ª–æ—á–∫–∏ - –ø—Ä–æ—á–∏—Ç–∞–Ω–æ</div>
      </div>

      <div class="feature-card">
        <div class="feature-icon">üö´</div>
        <div class="feature-name">–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞</div>
        <div class="feature-desc">–ú–æ–∂–µ—à—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ª—é–±–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π</div>
      </div>

      <div class="feature-card">
        <div class="feature-icon">üñºÔ∏è</div>
        <div class="feature-name">–ê–≤–∞—Ç–∞—Ä—ã</div>
        <div class="feature-desc">–ó–∞–≥—Ä—É–∂–∞–π —Å–≤–æ–∏ —Ñ–æ—Ç–æ –∏ –º–µ–Ω—è–π –∏—Ö –∫–æ–≥–¥–∞ –∑–∞—Ö–æ—á–µ—à—å</div>
      </div>

      <div class="feature-card">
        <div class="feature-icon">‚ö°</div>
        <div class="feature-name">–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ</div>
        <div class="feature-desc">–í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏</div>
      </div>
    </div>

    <div style="margin: 24px 0; text-align: center;">
      <span class="tech-badge">üî• Firebase</span>
      <span class="tech-badge">üí® Firestore</span>
      <span class="tech-badge">üîê SHA-256</span>
      <span class="tech-badge">üì± PWA ready</span>
    </div>

    <div class="about-footer">
      <p>–í–µ—Ä—Å–∏—è 2.0 (2026)</p>
      <p style="font-size: 12px;">–°–æ–∑–¥–∞–Ω–æ —Å ‚ù§Ô∏è –¥–ª—è LOL Messenger</p>
      <p style="font-size: 11px; margin-top: 8px;">–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Firebase<br>–ü–æ–ª–Ω–æ—Å—Ç—å—é –±–µ—Å–ø–ª–∞—Ç–Ω–æ –Ω–∞ Spark –ø–ª–∞–Ω–µ</p>
    </div>
  </section>

  <!-- TABBAR -->
  <nav id="bottomNav" class="nav hidden">
    <div class="navWrap">
      <div class="navItem active" data-tab="chats">
        <div class="navIcon">üí¨</div>
        <div>–ß–∞—Ç—ã</div>
      </div>
      <div class="navItem" data-tab="profile">
        <div class="navIcon">üë§</div>
        <div>–ü—Ä–æ—Ñ–∏–ª—å</div>
      </div>
    </div>
  </nav>

  <!-- –ù–û–í–û–ï: –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –º—É—Ç–∞ -->
  <div id="muteModal" class="modal hidden">
    <div class="modal-content">
      <h3>–ù–∞ —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –∑–∞–≥–ª—É—à–∏—Ç—å?</h3>
      <input type="number" id="muteMinutes" min="1" value="5">
      <div class="modal-buttons">
        <button class="modal-btn confirm" onclick="confirmMute()">‚úÖ</button>
        <button class="modal-btn cancel" onclick="hideMuteModal()">‚ùå</button>
      </div>
    </div>
  </div>

</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
/* =========================
   Firebase init
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyCl9xOzUawqggpwyZQupGYm67RiWT42b7A",
  authDomain: "lol-messenger-76286.firebaseapp.com",
  projectId: "lol-messenger-76286",
  storageBucket: "lol-messenger-76286.firebasestorage.app",
  messagingSenderId: "573143866457",
  appId: "1:573143866457:web:fb7ed67ea66848e6da2548"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* =========================
   Helpers
========================= */
const $ = (id) => document.getElementById(id);
const now = () => Date.now();
const pad2 = (n)=> String(n).padStart(2,"0");
const fmtTime = (ms)=> { const d=new Date(ms); return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; };

function escapeHtml(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function showScreen(id){
  ["scr-auth","scr-chats","scr-search","scr-chat","scr-profile","scr-about"].forEach(x => $(x).classList.remove("active"));
  $(id).classList.add("active");
  $("composer").style.display = (id === "scr-chat") ? "flex" : "none";
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Ç–∞–±–±–∞—Ä
  if (id === "scr-auth" || id === "scr-about") {
    $("bottomNav").classList.add("hidden");
  } else {
    $("bottomNav").classList.remove("hidden");
  }
}

function setMsg(el, text, kind){
  el.className = (kind === "ok") ? "ok" : "err";
  el.textContent = text;
  el.classList.remove("hidden");
}
function clearMsg(el){
  el.textContent = "";
  el.classList.add("hidden");
}

function randId(prefix="u"){
  return prefix + "_" + Math.random().toString(36).slice(2) + "_" + Math.random().toString(36).slice(2);
}

async function sha256Hex(text){
  const enc = new TextEncoder();
  const data = enc.encode(text);
  const hash = await crypto.subtle.digest("SHA-256", data);
  const bytes = Array.from(new Uint8Array(hash));
  return bytes.map(b => b.toString(16).padStart(2,"0")).join("");
}

function chatIdFor(a,b){ return [a,b].sort().join("_"); }

function isOnline(u){
  const ls = u.lastSeen || 0;
  return !!u.online && (now() - ls) < 45000;
}
function onlineText(u){
  return isOnline(u) ? "–æ–Ω–ª–∞–π–Ω" : "–æ—Ñ—Ñ–ª–∞–π–Ω";
}

/* =========================
   Default avatar (inline svg)
========================= */
const defaultAvatar = "data:image/svg+xml;base64," + btoa(`
<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#60a5fa"/>
      <stop offset="1" stop-color="#a78bfa"/>
    </linearGradient>
  </defs>
  <rect width="256" height="256" rx="80" fill="url(#g)"/>
  <circle cx="128" cy="104" r="44" fill="rgba(255,255,255,.85)"/>
  <path d="M48 218c18-44 54-66 80-66s62 22 80 66" fill="rgba(255,255,255,.78)"/>
</svg>
`);

/* =========================
   State
========================= */
let authMode = "login"; // login | reg
let session = null;     // { uid, login }
let me = null;          // { uid, ... }
let usersCache = new Map();

let peer = null;        // {uid,...}
let currentChatId = null;

let unsubChatList = null;
let unsubMsgs = null;
let unsubPeer = null;

let heartbeatTimer = null;
let typingTimer = null;
let typingClearTimer = null;

let isBlocked = false;  // –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

/* =========================
   –ù–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
========================= */
const CREATOR_PASSWORD = 'Sigmohibutlos67?!';
let muteTargetId = null;
let muteTimers = new Map(); // –¥–ª—è –∞–≤—Ç–æ—Å–Ω—è—Ç–∏—è –º—É—Ç–∞

/* =========================
   Session persistence
========================= */
function loadSession(){
  try{
    const s = JSON.parse(localStorage.getItem("lol_session") || "null");
    return s && s.uid ? s : null;
  }catch{ return null; }
}
function saveSession(s){ localStorage.setItem("lol_session", JSON.stringify(s)); }
function clearSession(){ localStorage.removeItem("lol_session"); }

/* =========================
   Auth UI
========================= */
function setAuthMode(mode){
  authMode = mode;
  $("segLogin").classList.toggle("active", mode==="login");
  $("segReg").classList.toggle("active", mode==="reg");
  $("regExtra").classList.toggle("hidden", mode!=="reg");
  $("authBtn").textContent = mode==="login" ? "–í–æ–π—Ç–∏" : "–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç";
  clearMsg($("authMsg"));
}
$("segLogin").addEventListener("click", ()=> setAuthMode("login"));
$("segReg").addEventListener("click", ()=> setAuthMode("reg"));

$("regAvatarPreview").src = defaultAvatar;

function bindAvatarInput(fileEl, imgEl){
  fileEl.addEventListener("change", (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = (ev)=> { imgEl.src = ev.target.result; };
    r.readAsDataURL(f);
  });
}
bindAvatarInput($("regAvatarFile"), $("regAvatarPreview"));
bindAvatarInput($("editAvatarFile"), $("editAvatarPreview"));

/* =========================
   Data access
========================= */
async function warmUsersCache(){
  const snap = await db.collection("users").get();
  usersCache.clear();
  snap.forEach(d => usersCache.set(d.id, { uid:d.id, ...d.data() }));
  if(session && usersCache.has(session.uid)) me = usersCache.get(session.uid);
}

async function loadMe(){
  const snap = await db.collection("users").doc(session.uid).get();
  if(!snap.exists) throw new Error("–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.");
  me = { uid: snap.id, ...snap.data() };
  usersCache.set(me.uid, me);
}

async function findUserByLogin(login){
  const snap = await db.collection("users").where("login","==",login).limit(1).get();
  if (snap.empty) return null;
  const d = snap.docs[0];
  return { uid: d.id, data: d.data() };
}

/* =========================
   Online / heartbeat
========================= */
async function setOnline(flag){
  if(!session) return;
  try{
    await db.collection("users").doc(session.uid).set({
      online: !!flag,
      lastSeen: now()
    }, { merge:true });
  }catch{}
}

function startHeartbeat(){
  stopHeartbeat();
  heartbeatTimer = setInterval(()=> setOnline(true), 15000);
}
function stopHeartbeat(){
  if(heartbeatTimer){ clearInterval(heartbeatTimer); heartbeatTimer=null; }
}

window.addEventListener("beforeunload", ()=> setOnline(false));
document.addEventListener("visibilitychange", ()=>{
  if(document.hidden) setOnline(false);
  else setOnline(true);
});

/* =========================
   –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò - –°–û–ó–î–ê–¢–ï–õ–¨ (—Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Å–Ω—è—Ç—å)
========================= */
$("creatorBtn").addEventListener("click", async () => {
  if (me.role === "creator") {
    // –°–Ω–∏–º–∞–µ–º —Å–æ–∑–¥–∞—Ç–µ–ª—è
    if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∞ —Å–æ–∑–¥–∞—Ç–µ–ª—è?")) {
      try {
        await db.collection("users").doc(me.uid).update({ role: "user" });
        me.role = "user";
        renderProfile();
        alert("üë§ –ü—Ä–∞–≤–∞ —Å–æ–∑–¥–∞—Ç–µ–ª—è —É–±—Ä–∞–Ω—ã");
      } catch (e) {
        alert("–û—à–∏–±–∫–∞: " + e.message);
      }
    }
  } else {
    // –°—Ç–∞–Ω–æ–≤–∏–º—Å—è —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º
    const pass = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å —Å–æ–∑–¥–∞—Ç–µ–ª—è:");
    if (pass !== CREATOR_PASSWORD) {
      alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
      return;
    }

    try {
      await db.collection("users").doc(me.uid).update({ role: "creator" });
      me.role = "creator";
      renderProfile();
      alert("üéâ –¢–µ–ø–µ—Ä—å –≤—ã —Å–æ–∑–¥–∞—Ç–µ–ª—å!");
    } catch (e) {
      alert("–û—à–∏–±–∫–∞: " + e.message);
    }
  }
});

/* =========================
   –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò - –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø
========================= */
async function toggleVerify(userId) {
  if (me?.role !== "creator") return;
  
  try {
    const userRef = db.collection("users").doc(userId);
    const userSnap = await userRef.get();
    await userRef.update({ verified: !userSnap.data().verified });
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏:", e);
  }
}

/* =========================
   –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò - –ú–£–¢ (—Ä–∞–±–æ—á–∏–π)
========================= */
function showMuteModal(userId) {
  if (me?.role !== "creator") return;
  muteTargetId = userId;
  $("muteModal").classList.remove("hidden");
}

function hideMuteModal() {
  $("muteModal").classList.add("hidden");
  muteTargetId = null;
}

async function confirmMute() {
  if (!muteTargetId || me?.role !== "creator") {
    hideMuteModal();
    return;
  }

  const minutes = parseInt($("muteMinutes").value);
  if (isNaN(minutes) || minutes < 1) {
    alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω—É—Ç");
    return;
  }

  try {
    const userRef = db.collection("users").doc(muteTargetId);
    const userSnap = await userRef.get();
    const userData = userSnap.data();
    
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞–≥–ª—É—à–µ–Ω - —Å–Ω–∏–º–∞–µ–º –º—É—Ç
    if (userData.mutedUntil && userData.mutedUntil > now()) {
      await userRef.update({
        mutedUntil: 0,
        mutedBy: null
      });
      
      // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –±—ã–ª
      if (muteTimers.has(muteTargetId)) {
        clearTimeout(muteTimers.get(muteTargetId));
        muteTimers.delete(muteTargetId);
      }
      
      alert(`üîä –ú—É—Ç —Å–Ω—è—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è`);
    } else {
      // –°—Ç–∞–≤–∏–º –º—É—Ç
      const mutedUntil = now() + minutes * 60 * 1000;
      await userRef.update({
        mutedUntil: mutedUntil,
        mutedBy: me.uid
      });
      
      // –°—Ç–∞–≤–∏–º —Ç–∞–π–º–µ—Ä –Ω–∞ –∞–≤—Ç–æ—Å–Ω—è—Ç–∏–µ
      const timer = setTimeout(async () => {
        try {
          await userRef.update({
            mutedUntil: 0,
            mutedBy: null
          });
          muteTimers.delete(muteTargetId);
        } catch (e) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Å–Ω—è—Ç–∏–∏ –º—É—Ç–∞:", e);
        }
      }, minutes * 60 * 1000);
      
      muteTimers.set(muteTargetId, timer);
      
      alert(`üîá –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥–ª—É—à–µ–Ω –Ω–∞ ${minutes} –º–∏–Ω—É—Ç`);
    }
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –º—É—Ç–∞:", e);
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏");
  }

  hideMuteModal();
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –º—É—Ç–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
async function checkMuteStatus(userId) {
  if (!userId) return false;
  
  try {
    const userSnap = await db.collection("users").doc(userId).get();
    if (!userSnap.exists) return false;
    
    const userData = userSnap.data();
    if (userData.mutedUntil && userData.mutedUntil > now()) {
      return true; // –∑–∞–≥–ª—É—à–µ–Ω
    }
    
    // –ï—Å–ª–∏ –≤—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ, –Ω–æ –≤ –±–∞–∑–µ –µ—â—ë –Ω–µ –æ–±–Ω–æ–≤–∏–ª–æ—Å—å - –æ—á–∏—â–∞–µ–º
    if (userData.mutedUntil && userData.mutedUntil <= now()) {
      await db.collection("users").doc(userId).update({
        mutedUntil: 0,
        mutedBy: null
      });
    }
    
    return false;
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –º—É—Ç–∞:", e);
    return false;
  }
}

/* =========================
   –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò - –ë–õ–û–ö–ò–†–û–í–ö–ê –ü–û –ß–ê–¢–£
========================= */
async function toggleBlockInChat() {
  if (!currentChatId || !me || !peer) return;

  const blockRef = db.collection("blocks").doc(currentChatId);
  await db.runTransaction(async (transaction) => {
    const blockDoc = await transaction.get(blockRef);
    const blockedBy = blockDoc.exists ? blockDoc.data().blockedBy || [] : [];
    
    if (blockedBy.includes(me.uid)) {
      transaction.set(blockRef, { blockedBy: blockedBy.filter(id => id !== me.uid) }, { merge: true });
      isBlocked = false;
      updateChatUI();
      alert("üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –≤ —ç—Ç–æ–º —á–∞—Ç–µ");
    } else {
      transaction.set(blockRef, { blockedBy: [...blockedBy, me.uid] }, { merge: true });
      isBlocked = true;
      updateChatUI();
      alert("üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –≤ —ç—Ç–æ–º —á–∞—Ç–µ");
    }
  });
}

async function checkChatBlockStatus() {
  if (!currentChatId || !me) return false;
  
  const blockRef = db.collection("blocks").doc(currentChatId);
  const blockDoc = await blockRef.get();
  
  if (blockDoc.exists) {
    const blockedBy = blockDoc.data().blockedBy || [];
    if (blockedBy.includes(me.uid)) {
      isBlocked = true;
      return true;
    }
  }
  
  isBlocked = false;
  return false;
}

/* =========================
   Tabs
========================= */
function setTab(tab){
  document.querySelectorAll(".navItem").forEach(x=>x.classList.remove("active"));
  document.querySelector(`.navItem[data-tab="${tab}"]`)?.classList.add("active");
  if(tab==="chats") showScreen("scr-chats");
  if(tab==="profile") showScreen("scr-profile");
}
document.querySelectorAll(".navItem").forEach(el=>{
  el.addEventListener("click", ()=> setTab(el.getAttribute("data-tab")));
});

/* =========================
   Auth action
========================= */
$("authBtn").addEventListener("click", async ()=>{
  clearMsg($("authMsg"));
  const login = $("loginLogin").value.trim();
  const pass  = $("loginPass").value;

  if(!login || !pass){
    return setMsg($("authMsg"), "–ó–∞–ø–æ–ª–Ω–∏ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å.", "err");
  }

  try{
    if(authMode === "reg"){
      const nick = $("regNick").value.trim();
      const phone = $("regPhone").value.trim();
      const avatar = $("regAvatarPreview").src || defaultAvatar;

      if(!nick){
        return setMsg($("authMsg"), "–ù—É–∂–µ–Ω –Ω–∏–∫–Ω–µ–π–º.", "err");
      }

      const exists = await findUserByLogin(login);
      if(exists){
        return setMsg($("authMsg"), "–¢–∞–∫–æ–π –ª–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç.", "err");
      }

      const uid  = randId("u");
      const salt = randId("s");
      const passwordHash = await sha256Hex(`${login}:${pass}:${salt}`);

      await db.collection("users").doc(uid).set({
        login,
        salt,
        passwordHash,
        nick,
        phone,
        avatar,
        online: true,
        lastSeen: now(),
        typingTo: "",
        typingAt: 0,
        role: "user",
        verified: false,
        mutedUntil: 0,
        mutedBy: null
      });

      session = { uid, login };
      saveSession(session);
      await afterLogin();
      return;
    }

    // login
    const found = await findUserByLogin(login);
    if(!found){
      return setMsg($("authMsg"), "–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.", "err");
    }
    const { uid, data } = found;
    const calc = await sha256Hex(`${login}:${pass}:${data.salt}`);
    if(calc !== data.passwordHash){
      return setMsg($("authMsg"), "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.", "err");
    }

    session = { uid, login };
    saveSession(session);
    await afterLogin();
  }catch(e){
    setMsg($("authMsg"), "–û—à–∏–±–∫–∞: " + (e?.message || String(e)), "err");
  }
});

/* =========================
   After login / logout
========================= */
async function afterLogin(){
  $("bottomNav").classList.remove("hidden");
  await setOnline(true);
  startHeartbeat();

  await warmUsersCache();
  await loadMe();
  renderProfile();

  bindChatListRealtime();

  showScreen("scr-chats");
  setTab("chats");
}

async function logout(){
  try{ await clearMyTyping(); }catch{}
  try{ await setOnline(false); }catch{}
  stopHeartbeat();

  if(unsubChatList){ unsubChatList(); unsubChatList=null; }
  if(unsubMsgs){ unsubMsgs(); unsubMsgs=null; }
  if(unsubPeer){ unsubPeer(); unsubPeer=null; }

  session=null; me=null; peer=null; currentChatId=null;
  usersCache.clear();

  clearSession();
  $("bottomNav").classList.add("hidden");
  showScreen("scr-auth");
}
$("btnLogout").addEventListener("click", logout);
$("btnLogout2").addEventListener("click", logout);

$("resetDeviceBtn").addEventListener("click", ()=>{
  localStorage.removeItem("lol_session");
  location.reload();
});

/* =========================
   About screen
========================= */
$("aboutBtn").addEventListener("click", ()=>{
  showScreen("scr-about");
});

$("aboutBackBtn").addEventListener("click", ()=>{
  showScreen("scr-profile");
});

/* =========================
   Profile (–ò–ó–ú–ï–ù–ï–ù–û –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–ª–æ—Ç–æ—á–∫–∞ –∏ –≥–∞–ª–æ—á–∫–∏)
========================= */
function renderProfile(){
  if(!me) return;
  $("meAvatar").src = me.avatar || defaultAvatar;
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–∏–∫ —Å –≥–∞–ª–æ—á–∫–æ–π –∏ –º–æ–ª–æ—Ç–æ—á–∫–æ–º
  let nickHtml = escapeHtml(me.nick || "–ö—Ç–æ-—Ç–æ");
  if (me.verified) nickHtml += ' <span style="color:#2b86ff; font-size:18px;">‚úì</span>';
  if (me.role === "creator") nickHtml += ' <span style="font-size:20px;">üî®</span>';
  $("meNick").innerHTML = nickHtml;
  
  $("mePhone").textContent = me.phone || "";
  $("meLogin").textContent = "–õ–æ–≥–∏–Ω: " + (me.login || "");

  $("editAvatarPreview").src = me.avatar || defaultAvatar;
  $("editNick").value = me.nick || "";
  $("editPhone").value = me.phone || "";

  // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
  const creatorBtn = $("creatorBtn");
  if (me.role === "creator") {
    creatorBtn.textContent = "üî® –£–±—Ä–∞—Ç—å —Å–æ–∑–¥–∞—Ç–µ–ª—è";
    creatorBtn.classList.remove("hidden");
  } else {
    creatorBtn.textContent = "üî® –°—Ç–∞—Ç—å —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º";
    creatorBtn.classList.remove("hidden");
  }
}

$("saveProfileBtn").addEventListener("click", async ()=>{
  clearMsg($("profileMsg"));
  const nick = $("editNick").value.trim() || "–ö—Ç–æ-—Ç–æ";
  const phone = $("editPhone").value.trim() || "";
  const avatar = $("editAvatarPreview").src || defaultAvatar;

  try{
    await db.collection("users").doc(me.uid).set({ nick, phone, avatar }, { merge:true });
    me.nick = nick; me.phone = phone; me.avatar = avatar;
    usersCache.set(me.uid, me);
    renderProfile();
    setMsg($("profileMsg"), "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ", "ok");
  }catch(e){
    setMsg($("profileMsg"), "–û—à–∏–±–∫–∞: " + (e?.message || String(e)), "err");
  }
});

/* =========================
   Chats list realtime (–ò–ó–ú–ï–ù–ï–ù–û –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–∞–ª–æ—á–µ–∫ —É –≤—Å–µ—Ö)
========================= */
function bindChatListRealtime(){
  if(!me) return;
  if(unsubChatList){ unsubChatList(); unsubChatList=null; }

  unsubChatList = db.collection("chats")
    .where("participants", "array-contains", me.uid)
    .onSnapshot(async (snap)=>{
      await warmUsersCache();

      let items=[];
      snap.forEach(d=>{
        const c=d.data();
        if((c.lastTime||0) > 0){
          items.push({ id:d.id, ...c });
        }
      });
      items.sort((a,b)=>(b.lastTime||0)-(a.lastTime||0));

      const box = $("chatList");
      box.innerHTML = "";

      if(items.length===0){
        const div=document.createElement("div");
        div.style.padding="10px 16px";
        div.style.color="rgba(234,241,255,.55)";
        div.style.fontWeight="1100";
        div.textContent="–ü–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤. –ù–∞–∂–º–∏ –ø–æ–∏—Å–∫ –∏ –Ω–∞–ø–∏—à–∏ –∫–æ–º—É-–Ω–∏–±—É–¥—å.";
        box.appendChild(div);
        return;
      }

      for(const c of items){
        const peerId = (c.participants||[]).find(x=>x!==me.uid);
        const u = usersCache.get(peerId) || { nick:"–ö—Ç–æ-—Ç–æ", avatar: defaultAvatar, online:false, lastSeen:0 };

        const row=document.createElement("div");
        row.className="row";
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Å –≥–∞–ª–æ—á–∫–æ–π (–¥–ª—è –≤—Å–µ—Ö)
        let nameHtml = escapeHtml(u.nick || "–ö—Ç–æ-—Ç–æ");
        if (u.verified) nameHtml += ' <span style="color:#2b86ff; font-size:16px;">‚úì</span>';
        
        row.innerHTML = `
          <img class="avatar" src="${escapeHtml(u.avatar || defaultAvatar)}" alt="">
          <div class="meta">
            <div class="nameLine">
              <div class="name">${nameHtml}</div>
              <div class="time">${c.lastTime ? fmtTime(c.lastTime) : ""}</div>
            </div>
            <div class="preview">
              <div class="snippet">${escapeHtml(c.lastText || "")}</div>
            </div>
          </div>
        `;
        row.addEventListener("click", ()=> openChat(peerId));
        box.appendChild(row);
      }
    }, (err)=>{
      $("chatList").innerHTML = `<div class="err" style="margin:10px;">–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —á–∞—Ç–æ–≤: ${escapeHtml(err?.message || String(err))}</div>`;
    });
}

/* =========================
   Search screen (–ò–ó–ú–ï–ù–ï–ù–û –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–∞–ª–æ—á–µ–∫ —É –≤—Å–µ—Ö)
========================= */
$("openSearch").addEventListener("click", async ()=>{
  await warmUsersCache();
  $("searchInput").value = "";
  $("searchResults").innerHTML = "";
  $("searchEmpty").textContent = "–ù–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º‚Ä¶";
  showScreen("scr-search");
  $("searchInput").focus();
});

$("cancelSearch").addEventListener("click", ()=> showScreen("scr-chats"));

$("clearSearch").addEventListener("click", ()=>{
  $("searchInput").value = "";
  $("searchResults").innerHTML = "";
  $("searchEmpty").textContent = "–ù–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º‚Ä¶";
  $("searchInput").focus();
});

$("searchInput").addEventListener("input", ()=>{
  const q = $("searchInput").value.trim().toLowerCase();
  const box = $("searchResults");
  box.innerHTML = "";

  if(!q){
    $("searchEmpty").textContent = "–ù–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º‚Ä¶";
    return;
  }

  let found=[];
  for(const [uid,u] of usersCache.entries()){
    if(!me) continue;
    if(uid === me.uid) continue;
    if((u.login||"") === (me.login||"")) continue;

    const nick = (u.nick||"").toLowerCase();
    if(nick.includes(q)) found.push(u);
  }

  found.sort((a,b)=>{
    const ao = isOnline(a) ? 1 : 0;
    const bo = isOnline(b) ? 1 : 0;
    if(ao !== bo) return bo - ao;
    return (a.nick||"").localeCompare(b.nick||"", "ru");
  });

  $("searchEmpty").textContent = found.length ? "" : "–ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ";

  for(const u of found.slice(0, 40)){
    const row=document.createElement("div");
    row.className="row";
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Å –≥–∞–ª–æ—á–∫–æ–π (–¥–ª—è –≤—Å–µ—Ö)
    let nameHtml = escapeHtml(u.nick || "–ö—Ç–æ-—Ç–æ");
    if (u.verified) nameHtml += ' <span style="color:#2b86ff; font-size:16px;">‚úì</span>';
    
    row.innerHTML = `
      <img class="avatar" src="${escapeHtml(u.avatar || defaultAvatar)}" alt="">
      <div class="meta">
        <div class="nameLine" style="justify-content:flex-start; gap:10px;">
          <div class="name" style="max-width:68%;">${nameHtml}</div>
          <div class="statusDot ${isOnline(u) ? "on" : ""}" title="${isOnline(u) ? "–æ–Ω–ª–∞–π–Ω" : "–æ—Ñ—Ñ–ª–∞–π–Ω"}"></div>
        </div>
        <div class="sub">${isOnline(u) ? "–æ–Ω–ª–∞–π–Ω" : "–æ—Ñ—Ñ–ª–∞–π–Ω"}</div>
      </div>
    `;
    row.addEventListener("click", ()=> openChat(u.uid));
    box.appendChild(row);
  }
});

/* =========================
   Chat: open / close / messages (–ò–ó–ú–ï–ù–ï–ù–û)
========================= */
function stopPeerWatch(){
  if(unsubPeer){ unsubPeer(); unsubPeer=null; }
}

function stopMsgWatch(){
  if(unsubMsgs){ unsubMsgs(); unsubMsgs=null; }
}

async function markAsRead(messageIds) {
  if (!messageIds || messageIds.length === 0) return;
  
  const chatRef = db.collection("chats").doc(currentChatId);
  const batch = db.batch();
  
  messageIds.forEach(id => {
    const msgRef = chatRef.collection("messages").doc(id);
    batch.update(msgRef, {
      readBy: firebase.firestore.FieldValue.arrayUnion(me.uid)
    });
  });
  
  await batch.commit();
}

async function openChat(peerId){
  await warmUsersCache();
  const u = usersCache.get(peerId);
  if(!u){ alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"); return; }

  peer = u;
  currentChatId = chatIdFor(me.uid, peerId);

  $("peerAvatar").src = peer.avatar || defaultAvatar;
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Å –≥–∞–ª–æ—á–∫–æ–π (–¥–ª—è –≤—Å–µ—Ö)
  let nickHtml = escapeHtml(peer.nick || "–ö—Ç–æ-—Ç–æ");
  if (peer.verified) nickHtml += ' <span style="color:#2b86ff; font-size:16px;">‚úì</span>';
  $("peerNick").innerHTML = nickHtml;
  
  // –ù–û–í–û–ï: –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ —á–∞—Ç
  const actions = $("chatActions");
  actions.innerHTML = "";

  // –ö–Ω–æ–ø–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–¥–ª—è –≤—Å–µ—Ö)
  const blockBtn = document.createElement("div");
  blockBtn.className = "action-btn";
  blockBtn.innerHTML = "üö´";
  blockBtn.title = "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤ —ç—Ç–æ–º —á–∞—Ç–µ";
  blockBtn.onclick = toggleBlockInChat;
  actions.appendChild(blockBtn);

  // –ö–Ω–æ–ø–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è
  if (me.role === "creator") {
    // –ö–Ω–æ–ø–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
    const verifyBtn = document.createElement("div");
    verifyBtn.className = "action-btn creator-action-btn";
    verifyBtn.innerHTML = "‚úÖ";
    verifyBtn.title = "–í—ã–¥–∞—Ç—å/–∑–∞–±—Ä–∞—Ç—å —Å–∏–Ω—é—é –≥–∞–ª–æ—á–∫—É";
    verifyBtn.onclick = () => toggleVerify(peer.uid);
    actions.appendChild(verifyBtn);

    // –ö–Ω–æ–ø–∫–∞ –º—É—Ç–∞
    const muteBtn = document.createElement("div");
    muteBtn.className = "action-btn creator-action-btn";
    muteBtn.innerHTML = "üö´";
    muteBtn.title = "–û–≥–ª—É—à–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è";
    muteBtn.onclick = () => showMuteModal(peer.uid);
    actions.appendChild(muteBtn);
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
  await checkChatBlockStatus();
  
  stopPeerWatch();
  unsubPeer = db.collection("users").doc(peerId).onSnapshot(async (snap)=>{
    if(!snap.exists) return;
    peer = { uid: snap.id, ...snap.data() };
    usersCache.set(peer.uid, peer);

    const typing = (peer.typingTo === me.uid) && ((now() - (peer.typingAt||0)) < 4000);
    
    const blockedByPeer = await checkChatBlockStatus();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º—É—Ç
    const isMuted = peer.mutedUntil && peer.mutedUntil > now();
    
    if (isMuted) {
      const minutesLeft = Math.ceil((peer.mutedUntil - now()) / 60000);
      $("peerStatus").textContent = `üîá –ó–∞–≥–ª—É—à–µ–Ω (–µ—â—ë ${minutesLeft} –º–∏–Ω)`;
    } else if (blockedByPeer) {
      $("peerStatus").textContent = "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —ç—Ç–∏–º —á–µ–ª–æ–≤–µ–∫–æ–º";
    } else if (typing) {
      $("peerStatus").textContent = "–ü–µ—á–∞—Ç–∞–µ—Ç‚Ä¶";
    } else {
      $("peerStatus").textContent = onlineText(peer);
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è —Å –≥–∞–ª–æ—á–∫–æ–π
    let nickHtml = escapeHtml(peer.nick || "–ö—Ç–æ-—Ç–æ");
    if (peer.verified) nickHtml += ' <span style="color:#2b86ff; font-size:16px;">‚úì</span>';
    $("peerNick").innerHTML = nickHtml;
  });

  const chatRef = db.collection("chats").doc(currentChatId);
  const chatSnap = await chatRef.get();
  if(!chatSnap.exists){
    await chatRef.set({
      participants:[me.uid, peerId],
      lastText:"",
      lastTime:0
    });
  }

  stopMsgWatch();
  let unreadMessageIds = [];
  
  unsubMsgs = chatRef.collection("messages").orderBy("time").onSnapshot((ss)=>{
    const box = $("msgList");
    box.innerHTML = "";
    unreadMessageIds = [];

    ss.forEach(doc => {
      const m = doc.data();
      const b = document.createElement("div");
      b.className = "bubble" + (m.sender === me.uid ? " me" : "");
      
      // –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
      const textDiv = document.createElement("div");
      textDiv.textContent = m.text || "";
      b.appendChild(textDiv);

      // –ù–∏–∂–Ω—è—è –ø–ª–∞—à–∫–∞ —Å –≤—Ä–µ–º–µ–Ω–µ–º –∏ —Å—Ç–∞—Ç—É—Å–æ–º
      const footerDiv = document.createElement("div");
      footerDiv.className = "message-footer";
      
      // –í—Ä–µ–º—è
      const timeSpan = document.createElement("span");
      timeSpan.className = "t";
      timeSpan.textContent = m.time ? fmtTime(m.time) : "";
      footerDiv.appendChild(timeSpan);

      // –°—Ç–∞—Ç—É—Å –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–±–µ–ª—ã–µ –≥–∞–ª–æ—á–∫–∏ —Å–ª–µ–≤–∞)
      if (m.sender === me.uid) {
        const statusSpan = document.createElement("span");
        statusSpan.className = "message-status";
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—á–∏—Ç–∞–Ω–æ –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
        const isRead = m.readBy && m.readBy.includes(peer.uid);
        
        if (isRead) {
          // –î–≤–µ –±–µ–ª—ã–µ –≥–∞–ª–æ—á–∫–∏ - –ø—Ä–æ—á–∏—Ç–∞–Ω–æ
          statusSpan.innerHTML = '‚úî‚úî';
          statusSpan.classList.add("status-read");
        } else {
          // –û–¥–Ω–∞ –±–µ–ª–∞—è –≥–∞–ª–æ—á–∫–∞ - –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ
          statusSpan.innerHTML = '‚úî';
          statusSpan.classList.add("status-delivered");
        }
        
        footerDiv.appendChild(statusSpan);
      } else {
        // –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ - —Å–æ–±–∏—Ä–∞–µ–º –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
        if (!m.readBy || !m.readBy.includes(me.uid)) {
          unreadMessageIds.push(doc.id);
        }
      }

      b.appendChild(footerDiv);
      box.appendChild(b);
    });

    // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
    if (unreadMessageIds.length > 0) {
      markAsRead(unreadMessageIds);
    }

    box.scrollTop = box.scrollHeight;
  });

  $("msgInput").value = "";
  await clearMyTyping();
  updateChatUI();

  showScreen("scr-chat");
  $("msgInput").focus();
}

function closeChat(){
  clearMyTyping();
  showScreen("scr-chats");
}

$("backToChats").addEventListener("click", closeChat);
$("exitChat").addEventListener("click", closeChat);

function updateChatUI() {
  const sendBtn = $("sendBtn");
  const msgInput = $("msgInput");
  
  if (isBlocked) {
    sendBtn.disabled = true;
    msgInput.disabled = true;
    msgInput.placeholder = "–í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ —ç—Ç–æ–º —á–∞—Ç–µ";
  } else {
    sendBtn.disabled = false;
    msgInput.disabled = false;
    msgInput.placeholder = "–°–æ–æ–±—â–µ–Ω–∏–µ";
  }
}

async function sendMessage(){
  if (isBlocked) {
    alert("–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —ç—Ç–æ–º —á–∞—Ç–µ");
    return;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≥–ª—É—à–µ–Ω –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  const isMuted = await checkMuteStatus(me.uid);
  if (isMuted) {
    alert("–í—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–≥–ª—É—à–µ–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è");
    return;
  }
  
  const text = $("msgInput").value.trim();
  if(!text || !currentChatId || !peer) return;

  $("msgInput").value = "";
  const chatRef = db.collection("chats").doc(currentChatId);

  const msgData = {
    text,
    sender: me.uid,
    time: now(),
    readBy: [me.uid] // –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –≤—Å–µ–≥–¥–∞ –ø—Ä–æ—á–∏—Ç–∞–ª —Å–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  };

  await chatRef.collection("messages").add(msgData);

  await chatRef.set({
    participants: [me.uid, peer.uid],
    lastText: text,
    lastTime: now()
  }, { merge:true });

  await clearMyTyping();
}

$("sendBtn").addEventListener("click", sendMessage);
$("msgInput").addEventListener("keydown", (e)=>{
  if(e.key === "Enter") sendMessage();
});

/* =========================
   Typing
========================= */
async function setMyTyping(){
  if(!peer || !session || isBlocked) return;
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º—É—Ç
  const isMuted = await checkMuteStatus(me.uid);
  if (isMuted) return;
  
  try{
    await db.collection("users").doc(me.uid).set({
      typingTo: peer.uid,
      typingAt: now()
    }, { merge:true });
  }catch{}
}

async function clearMyTyping(){
  if(!session || !me) return;
  try{
    await db.collection("users").doc(me.uid).set({
      typingTo: "",
      typingAt: 0
    }, { merge:true });
  }catch{}
}

$("msgInput").addEventListener("input", ()=>{
  if(!peer || isBlocked) return;

  if(!typingTimer){
    typingTimer = setTimeout(async ()=>{
      typingTimer = null;
      await setMyTyping();
    }, 150);
  }

  if(typingClearTimer) clearTimeout(typingClearTimer);
  typingClearTimer = setTimeout(()=> clearMyTyping(), 1200);
});

/* =========================
   Boot
========================= */
(async ()=>{
  $("composer").style.display = "none";

  const s = loadSession();
  if(s && s.uid){
    session = s;
    try{
      await afterLogin();
    }catch(e){
      await logout();
      setAuthMode("login");
      setMsg($("authMsg"), "–°–µ—Å—Å–∏—è —É—Å—Ç–∞—Ä–µ–ª–∞. –í–æ–π–¥–∏ –∑–∞–Ω–æ–≤–æ.", "err");
    }
  }else{
    setAuthMode("login");
  }

  // –ù–û–í–û–ï: –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
  $("muteModal").addEventListener("click", (e) => {
    if (e.target === $("muteModal")) hideMuteModal();
  });
})();
</script>
</body>
</html>
